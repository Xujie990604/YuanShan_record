<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<!--<link href="../css/theme_normal.css" rel="stylesheet" />-->
		<style>
			.tabCut {
				background: #fff;
				display: flex;
				align-items: center;
				justify-content: center;
				text-align: center;
			}
			
			.mui-table-view-cell img {
				height: 100%;
				width: 100%;
				padding: 0px;
			}
			
			.mui-icon-more {
				color: #EA7B56;
			}
			
			.fix-button {
				position: absolute;
				bottom: 0px;
				width: 100%;
				height: 86px;
				display: flex;
				align-items: center;
				justify-content: center;
				margin-top: 0px;
				background-color: #ffffff;
			}
			
			.mui-table-view:after {
				height: 0px;
			}
			
			.mui-scroll {
				background-color: #FFFFFF;
			}
			
			.mui-segmented-control.mui-scroll-wrapper {
				height: 48px;
			}
			
			.mui-segmented-control.mui-scroll-wrapper .mui-scroll {
				height: 48px;
				font-size: 17px;
				font-weight: 400;
			}
			
			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
				border-bottom: 0px solid #007aff;
				background: none;
			}
			
			.mui-table-view:before {
				top: 0px;
			}
			
			.mui-input-group .mui-input-row {
				height: 60px;
			}
			
			.img_style {
				height: 58px;
				width: 98px;
				float: left;
				display: inline-block;
			}
			
			.dev_name {
				float: left;
				padding-left: 10px;
				width: 140px;
				display: inline-block;
				font-size: 17pxs;
			}
			
			.mui-checkbox input[type='checkbox'] {
				top: 16px;
			}
			
			.mui-input-group:before {
				height: 0px;
				width: 100%;
				top: 0px;
				left: 0px;
			}
			
			.dev-list-style {
				top: auto;
				bottom: auto;
				left: auto;
			}
			
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted~.mui-slider-group .mui-slider-item {
				border-top: 1px solid #c8c7cc;
				border-bottom: 0px solid #c8c7cc;
			}
			
			.mui-segmented-control.mui-scroll-wrapper .mui-control-item {
				padding: 0 0 0 10px;
				width: 50%;
			}
			
			.noFileImg {
				position: absolute;
				width: 90%;
				left: 5%;
				margin-top: 30%;
			}
			
			.noFileImg img {
				width: 100%;
			}
			
			.mui-checkbox {
				border-radius: 0px;
			}
			
			.mui-table-view-cell.mui-checkbox input[type=checkbox] {
				top: 26px;
			}
			
			.mui-table-view {
				margin-top: 0px;
			}
			
			.img-tip {
				text-align: center;
				position: relative;
				font-size: 16px;
			}
			
			.mui-segmented-control.mui-scroll-wrapper .mui-scroll {
				width: 100%;
			}
			
			.mui-scroll .mui-input-group .mui-input-row img {
				width: 30px;
			}
			
			.dev-info-style {
				display: flex;
				align-items: center;
				width: 80%;
				padding-left: 18px;
			}
			
			.mui-input-row {
				display: flex;
				align-items: center;
			}
			
			.doorMagnetismInfo {
				padding-left: 15px;
				width: 100%;
			}
			
			.doorMagnetismName {
				font-size: 16px;
				color: #333333;
			}
			
			.doorMagnetismICMI {
				font-size: 14px;
				color: rgba(51, 51, 51, 0.4);
			}
			
			.occupation-bitmap-div img {
				padding: 100px 70px 0px 70px;
			}
			
			.deviceTotalNumber {
				background-color: #FFFFFF;
				font-size: 14px;
				color: rgba(51, 51, 51, 0.7);
				height: 30px;
				display: flex;
				align-items: center;
				font-weight: 400px;
				padding-left: 11px;
			}
			
			.deviceTotalNumber:before {
				content: "";
				height: 1px;
				position: absolute;
				width: 100%;
				left: 0px;
				top: 48px;
				background: #D8D8D8;
				z-index: 10000;
				border-radius: 3px;
			}
			
			.position-div-img {
				text-align: center;
				color: rgba(51, 51, 51, 0.7);
				font-size: 16px;
			}
			
			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
				color: #50d0c1;
			}
			
			.mui-slider .mui-segmented-control.mui-segmented-control-inverted~.mui-slider-group .mui-slider-item {
				border-top: 0px solid #c8c7cc;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_selectDevice">&nbsp;</h1>
		</header>
		<div class="mui-content">
			<div id="slider" class="mui-slider">
				<div class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div id="roomList" class="mui-scroll tabCut">
						<div class="mui-control-item mui-active" data-text="WEB_unassociatedDevice" data-index="0">&nbsp;</div>
						<div class="mui-control-item" data-text="WEB_associatedDevice" data-index="1">&nbsp;</div>
					</div>
				</div>
				<div class="deviceTotalNumber">
					<!--未授权设备几台-->&nbsp;
				</div>
				<div id="totalDevList" class="mui-slider-group" style="height: 200px;">
					<div class="mui-slider-item mui-control-content mui-active" data-index="0">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<form class="mui-input-group" id="noTrunstDeviceList">
									<!--<div class="mui-input-row mui-checkbox ">
										<div class="dev-info-style">
											<img src="../images/all_day@3x.png" alt="" class="custom-left-icon" />
											<div class="doorMagnetismInfo">
												<div class="doorMagnetismName private-ellipsis">
													3-2-101
												</div>
												<div class="doorMagnetismICMI">
													132456794654545
												</div>
											</div>
										</div>
										<input name="checkbox1" value="Item 3" type="checkbox">
									</div>-->
								</form>
							</div>
						</div>
					</div>
					<div class="mui-slider-item mui-control-content" data-index="1">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<form class="mui-input-group" id="trunstDeviceList">
									<!--<div class="mui-input-row mui-checkbox ">
										<div class="dev-info-style">
											<img src="../images/all_day@3x.png" alt="" class="custom-left-icon" />
											<div class="doorMagnetismInfo">
												<div class="doorMagnetismName private-ellipsis">
													3-2-101
												</div>
												<div class="doorMagnetismICMI">
													132456794654545
												</div>
											</div>
										</div>
										<input name="checkbox1" value="Item 3" type="checkbox">
									</div>-->
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div id="confirmFix" class="ui-center fix-button">
				<button id="confirmSelection" class="mui-btn ui-large-btn ui-large-btn1">&nbsp;</button>
			</div>
		</div>

		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<!--<script src="../js/JavaScriptEZAPP.js"></script>-->
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<!--<script src="../js/libs/sha2.js"></script>-->
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/loadCss.js "></script>
		<script id="langScript"></script>
		<script>
			var isShowNoFunction; //无功能占位图
			var deviceList = []; //设备列表
			var totalNum = 0;
			var appInfo;
			var appId;
			var curIndex = 0;
			checkType(localStorage.AppType); //加载特定样式
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;
			setTimeout(function() {
				initPage();
				initData();
				initEvent();
			}, 300);

			function initPage() {
				var Url = "web/applicationPages/appDetail.html";
				var self = dsBridgeFuncSyn.getWebParam(Url);
				appInfo = JSON.parse(self);
				appId = appInfo.appId;
				deviceList = [];
				getTrustDevice(0, 0);
			}

			function initData() {

			}

			function initEvent() {
				mui('.mui-slider').slider();
				//初始化列表点击事件

				mui('.mui-scroll').on('tap', '.mui-control-item:not(.mui-active)', function() {
					dsBridgeFuncSyn.showLoading();
					totalNum = 0;
					deviceList = [];
					mui('.mui-slider').slider().gotoItem(this.getAttribute('data-index'));
					getTrustDevice(Number(this.getAttribute('data-index')), 0);
					//					initDeviceList(Number(this.getAttribute('data-index')));
					curIndex = Number(this.getAttribute('data-index'));
				});

				document.getElementById("confirmSelection").addEventListener("tap", function() {
					getCheckBoxValues(Number($(".mui-control-item.mui-active").attr("data-index")));
				});

			}
			/***
			 * 
			 * @param {Number} type 托管状态，0-查询未托管设备，1-查询托管设备，不带查询用户下所有设备
			 * @param {Number} pageStart 开始页面，第一页为0
			 * 
			 */

			function getTrustDevice(type, pageStart) {
				var Map = {
					pageStart: pageStart,
					pageSize: 100,
					appId: appId,
					trustStatus: type
				};
				CloudSendAjax(localStorage.serverAddress + openAPI.getTrustDeviceList, 'post', function(code, message, data) {
					if(code == 200) {
						totalNum = totalNum + data.deviceList.length;
						deviceList = deviceList.concat(data.deviceList);
						pageStart++;
						if(data.total > totalNum) {
							getTrustDevice(type, pageStart);
						} else {
							filterDevices();
							initDeviceList(type);
						}
					} else {
						$("#slider").addClass("mui-hidden");
						$("#confirmFix").addClass("mui-hidden");
						dsBridgeFuncSyn.dismiss();
						addBitmap(0);
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
					}
				}, Map);
			}

			/***
			 * 初始化设备列表
			 * @param {Number} type 托管状态，0-未托管设备列表，1-托管设备列表
			 * 
			 */

			function initDeviceList(type) {
				var parForm;
				var elString;
				if(type == 0) {
					parForm = document.getElementById("noTrunstDeviceList");
					elString = "noTrunstDeviceList";
					document.getElementsByClassName("deviceTotalNumber")[0].innerText = langTip["WEB_unassociatedDeviceNum"].replace(/%s/, deviceList.length);
					document.getElementById("confirmSelection").innerText = langTip["WEB_relation"];
				} else {
					parForm = document.getElementById("trunstDeviceList");
					elString = "trunstDeviceList";
					document.getElementsByClassName("deviceTotalNumber")[0].innerText = langTip["WEB_associatedDeviceNum"].replace(/%s/, deviceList.length);
					document.getElementById("confirmSelection").innerText = langTip["WEB_Disassociate"];
				}
				$("#" + elString).empty();
				mui("#" + elString).off("tap");
				if(deviceList.length == 0) {
					document.body.style.paddingBottom = "0px";
					document.getElementsByClassName("fix-button")[0].style.height = "0px";
					parForm.parentElement.style.height = "100%";
					parForm.style.height = "100%";
					$("#confirmSelection").addClass("mui-hidden");
					var imgDiv = document.createElement("div");
					imgDiv.className = "occupation-bitmap-div";
					imgDiv.style.height = "100%";
					var imgP = document.createElement("img");
					imgP.src = "../images/auth/no_auth_dev.png";
					imgDiv.appendChild(imgP);
					var divPo = document.createElement("div");
					divPo.className = "position-div-img";
					if(type == 0) {
						divPo.innerText = langTip["WEB_noUnAuthDevice"];
					} else {
						divPo.innerText = langTip["WEB_noAuthDevice"];
					}
					imgDiv.appendChild(divPo);
					parForm.appendChild(imgDiv);

					//					$(".deviceTotalNumber").addClass("mui-hidden");
				} else {
					document.getElementsByClassName("fix-button")[0].style.height = "86px";
					$("#confirmSelection").removeClass("mui-hidden");
					//					$(".deviceTotalNumber").removeClass("mui-hidden");
				}
				var sceenHeight = document.getElementsByClassName("fix-button")[0].getBoundingClientRect().top;
				var elTop = document.getElementById("totalDevList").getBoundingClientRect().top;
				if(sceenHeight - elTop > deviceList.length * 60 && deviceList.length > 0) {
					document.getElementById("totalDevList").style.height = deviceList.length * 60 + "px";
				} else {
					document.getElementById("totalDevList").style.height = sceenHeight - elTop + "px";
				}
				for(var i = 0; i < deviceList.length; i++) {
					var inputRowDiv = document.createElement("div");
					inputRowDiv.className = "mui-input-row mui-checkbox";
					var devDiv = document.createElement("div");
					devDiv.className = "dev-info-style";
					var devInput = document.createElement("input");
					devInput.value = JSON.stringify(deviceList[i]);
					devInput.type = "checkbox";
					var imgDiv = document.createElement("img");
					imgDiv.src = getImgSrc(deviceList[i].deviceType, deviceList[i].status);
					imgDiv.className = "custom-left-icon";
					var doorDiv = document.createElement("div");
					doorDiv.className = "doorMagnetismInfo";
					var nameDiv = document.createElement("div");
					nameDiv.className = "doorMagnetismName private-ellipsis";
					nameDiv.innerText = deviceList[i].deviceName;
					var devSNDiv = document.createElement("div");
					devSNDiv.className = "doorMagnetismICMI private-ellipsis";
					devSNDiv.innerText =langTip["WEB_SerialNo"] +" "+deviceList[i].deviceSerial;
					doorDiv.appendChild(nameDiv);
					doorDiv.appendChild(devSNDiv);
					devDiv.appendChild(imgDiv);
					devDiv.appendChild(doorDiv);
					inputRowDiv.appendChild(devDiv);
					inputRowDiv.appendChild(devInput);
					parForm.appendChild(inputRowDiv);
				}
				mui('.mui-scroll-wrapper').scroll();
				initSelectEvent(type);
				mui('.mui-slider').slider().stopped = true;
			}

			function getCheckBoxValues(type) {
				var sendList = [];
				var ele;
				var sendUrl;
				if(type == 0) {
					ele = mui("#noTrunstDeviceList input");
					sendUrl = localStorage.serverAddress + openAPI.addTrustDevice;
				} else {
					ele = mui("#trunstDeviceList input");
					sendUrl = localStorage.serverAddress + openAPI.deleteDevice;
				}

				for(var i = 0; i < ele.length; i++) {
					if(ele[i].checked) {
						var devSN = {
							deviceSerial: JSON.parse(ele[i].value).deviceSerial
						};
						sendList.push(devSN);
					}
				}
				if(sendList.length > 0 && sendList.length <= 100) {
					var sendMap = {
						appId: appId,
						deviceList: sendList
					}
					CloudSendAjax(sendUrl, 'post', function(code, message, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 200) {
							showToast(langTip["WEB_logcat_save_successful"]);
							dsBridgeFuncSyn.webAppClose();
						} else {
							showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						}
					}, sendMap);

				} else if(sendList.length > 100) {
					showToast(langTip["WEB_moreDeviceTip"]);
				} else {
					showToast(langTip["WEB_selectDevTip"]);
				}
			}

			function filterDevices() {
				var newList = [];
				for(var i = 0; i < deviceList.length; i++) {
					for(var j = 0; j < appInfo.deviceTypeList.length; j++) {
						if(deviceList[i].deviceType == appInfo.deviceTypeList[j]) {
							newList.push(deviceList[i]);
							break;
						}
					}

				}
				deviceList = deepCopy(newList);
			}

			function getImgSrc(devType, status) {
				var src;
				switch(devType) {
					case 0:
						if(status == 1) {
							src = "../images/auth/ipconline3x.png";
						} else {
							src = "../images/auth/ipcoffline3x.png";
						}
						break;
					case 1:
						if(status == 1) {
							src = "../images/auth/nvr_online3x.png";
						} else {
							src = "../images/auth/nvr_offline3x.png";
						}
						break;
					case 6:
						if(status == 1) {
							src = "../images/auth/lock3x.png";
						} else {
							src = "../images/auth/lock_offline3x.png";
						}
						break;
					default:
						break;
				}
				return src;
			}

			function initSelectEvent(type) {
				if(type == 0) {
					ele = mui("#noTrunstDeviceList input");
				} else {
					ele = mui("#trunstDeviceList input");
				}
				ele.each(function(index, El) {
					$(El).on("change", function(e) {
						var total = 0;
						for(var i = 0; i < ele.length; i++) {
							if(ele[i].checked) {
								total++;
							}
						}
						if(type == 0) {
							document.getElementById("confirmSelection").innerText = langTip["WEB_relation"] + langTip["WEB_devSelectedNum"].replace(/%s/, total);
						} else {
							document.getElementById("confirmSelection").innerText = langTip["WEB_Disassociate"] + langTip["WEB_devSelectedNum"].replace(/%s/, total);
						}
					});
				});
				dsBridgeFuncSyn.dismiss();
			}
		</script>
	</body>

</html>