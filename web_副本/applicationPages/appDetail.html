<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<!--<link href="../css/theme_normal.css" rel="stylesheet" />-->
		<style>
			.mui-table-view-cell img {
				position: absolute;
				left: 15px;
				top: 16px;
				width: 36px;
				z-index: 100;
				height: 36px;
			}
			
			.mui-table-view .mui-table-view-cell {
				height: 68px;
			}
			
			.doorMagnetismInfo {
				padding-left: 62px;
			}
			
			.doorMagnetismName {
				font-size: 17px;
				color: #333;
				width: 90%;
			}
			
			#doorMagnetismList {
				overflow-y: auto;
			}
			
			.add-APP-style {
				display: flex;
				justify-content: space-between;
				padding-left: 48px;
				align-items: center;
				height: 100%;
			}
			
			.app-detail {
				display: flex;
				align-items: center;
			}
			
			.detail {
				font-size: 14px;
				color: rgba(51, 51, 51, 0.4);
			}
			
			.fix-button {
				position: absolute;
				bottom: 0px;
				width: 100%;
				height: 86px;
				display: flex;
				align-items: center;
				justify-content: center;
				margin-top: 0px;
				background-color: #ffffff;
			}
			
			.alert-title-span .alert-contant-span {
				font-size: 15px;
			}
			
			.app-permissions {
				padding-left: 15px;
				padding-top: 8px;
				background-color: #ffffff;
				padding-bottom: 5px;
				padding-right: 15px;
			}
			
			.permissions-detail {
				color: rgba(51, 51, 51, 0.4);
				font-size: 14px;
			}
			
			.mui-popup-title {
				font-size: 15px;
				font-weight: 400;
			}
			
			.mui-popup-title+.mui-popup-text {
				font-size: 15px;
				font-weight: 400;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title">&nbsp;</h1>
		</header>
		<div class="mui-content">
			<div id="ezliveContent" class="mui-hidden">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell app-detail">
						<img id="appLogo" alt="" class="custom-left-icon" />
						<div class="doorMagnetismInfo">
							<div id="appName" class="doorMagnetismName private-ellipsis">
								&nbsp;
							</div>
							<div id="simpleDetail" class="detail twoRow">
								&nbsp;
							</div>
						</div>
					</li>
				</ul>
				<ul class="mui-table-view">
					<li class="mui-table-view-cell" id="totalDevices">
						<a id="aLink">
							<div class="doorMagnetismName private-ellipsis" data-text="WEB_associatedDevice">
								&nbsp;
							</div>
							<div id="deviceTotal" class="detail">
								&nbsp;
							</div>
						</a>
					</li>
				</ul>
				<div id="appPermissions" class="app-permissions">
					<div class="doorMagnetismName private-ellipsis" data-text="WEB_associatedAppPermission">&nbsp;</div>
					<!--<div class="permissions-detail private-ellipsis">
					sdadasdsad
				</div>-->
				</div>
				<div id="buttonDiv" class="ui-center fix-button mui-hidden">
					<button id="confirmSelection" class="mui-btn ui-large-btn ui-large-btn1" data-text="WEB_confirmSelectDevice">&nbsp;</button>
				</div>
			</div>
		</div>

		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/libs/sha2.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/loadCss.js "></script>
		<script id="langScript"></script>
		<script>
			var isShowNoFunction; //无功能占位图
			checkType(localStorage.AppType); //加载特定样式
			var totalNum = 0;
			var appInfo;
			var deviceList = [];
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;

			initPage();
			initData();
			initEvent();

			function initPage() {
				var Url = "web/applicationPages/appDetail.html";
				var self = dsBridgeFuncSyn.getWebParam(Url);
				appInfo = JSON.parse(self);
				document.getElementById("appLogo").src = appInfo.logoURL;
				document.getElementById("title").innerText = appInfo.appName;
				document.getElementById("simpleDetail").innerText = appInfo.appIntroduction;
				document.getElementById("appName").innerText = appInfo.appName;

				if(appInfo.isAuth == 0) {
					$("#buttonDiv").removeClass("mui-hidden");
					totalNum = 0;
					getTrustDevice(undefined, 0);
				} else {
					totalNum = 0;
					$("#aLink").addClass("mui-navigate-right");
					document.getElementById("totalDevices").addEventListener("tap", function() {
						var id = "selectAuthorizeDevice";
						var Url = "web/applicationPages/" + id + ".html";
						dsBridgeFuncSyn.pageTo(Url, JSON.stringify(appInfo));
					});
					getTrustDevice(1, 0);
				}
			}

			function initData() {

			}

			function initEvent() {
				document.getElementById("confirmSelection").addEventListener("tap", function() {
					if(deviceList.length > 0) {
						var Map = {
							appId: appInfo.appId
						};
						dsBridgeFuncSyn.showLoading();
						CloudSendAjax(localStorage.serverAddress + openAPI.getAuthCode, 'post', function(code, message, data) {
							if(code == 200) {
								appInfo.isAuth = 1;
								$("#aLink").addClass("mui-navigate-right");
								$("#buttonDiv").addClass("mui-hidden");
								dsBridgeFuncSyn.sendDataToReport("reshApplist", JSON.stringify(appInfo));
								document.getElementById("totalDevices").addEventListener("tap", function() {
									var id = "selectAuthorizeDevice";
									var Url = "web/applicationPages/" + id + ".html";
									dsBridgeFuncSyn.pageTo(Url, JSON.stringify(appInfo));
								});
								dsBridgeFuncAsyn.refreshMyApp(function() {
									var id = "selectAuthorizeDevice";
									var Url = "web/applicationPages/" + id + ".html";
									dsBridgeFuncSyn.pageTo(Url, JSON.stringify(appInfo));
								});
							} else {
								dsBridgeFuncSyn.dismiss();
								showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
							}
						}, Map);
					} else {
						var btnArray = langTip["WEB_determine"];
						mui.alert('<div class="alert-contant-span">' + langTip["WEB_appAuthTip1"] + '</div>', '<div class="alert-title-span">' + langTip["WEB_appAuthTip2"] + '</div>', btnArray, function() {

						}, 'div');
					}
				});
			}

			/***
			 * 
			 * @param {Number} type 托管状态，0-查询未托管设备，1-查询托管设备，不带查询用户下所有设备
			 * @param {Number} pageStart 开始页面，第一页为0
			 * 
			 */

			function getTrustDevice(type, pageStart) {
				var Map = {
					pageStart: pageStart,
					pageSize: 100,
					appId: appInfo.appId,
					trustStatus: type
				};
				CloudSendAjax(localStorage.serverAddress + openAPI.getTrustDeviceList, 'post', function(code, message, data) {
					if(code == 200) {
						totalNum = totalNum + data.deviceList.length;
						deviceList = deviceList.concat(data.deviceList);
						pageStart++;
						if(data.total > totalNum) {
							getTrustDevice(type, pageStart);
						} else {
							filterDevices();
							initDetailPage();
						}
					} else {
						dsBridgeFuncSyn.dismiss();
						addBitmap(0);
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
					}
				}, Map);
			}

			function filterDevices() {
				var newList = [];
				for(var i = 0; i < deviceList.length; i++) {
					for(var j = 0; j < appInfo.deviceTypeList.length; j++) {
						if(deviceList[i].deviceType == appInfo.deviceTypeList[j]) {
							newList.push(deviceList[i]);
							break;
						}
					}

				}
				deviceList = deepCopy(newList);
			}

			function initDetailPage() {
				var par = document.getElementById("appPermissions");
				for(var i = 0; i < appInfo.appPermissionList.length; i++) {
					var div = document.createElement("div");
					div.className = "permissions-detail private-ellipsis";
					div.innerText = appInfo.appPermissionList[i];
					par.appendChild(div);
				}
				if(appInfo.isAuth == 0) {
					var totalNumNoAuth = 0;
					for(var i = 0; i < deviceList.length; i++) {
						if(deviceList[i].isTrust == 1) {
							totalNumNoAuth++;
						}
					}
					document.getElementById("deviceTotal").innerText = langTip["WEB_devNum"].replace(/%s/, totalNumNoAuth);
				} else {
					document.getElementById("deviceTotal").innerText = langTip["WEB_devNum"].replace(/%s/, deviceList.length);
				}
				$("#ezliveContent").removeClass("mui-hidden");
				dsBridgeFuncSyn.dismiss();
			}
		</script>
	</body>

</html>