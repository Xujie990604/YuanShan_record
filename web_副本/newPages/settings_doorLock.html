<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<link href="../css/theme_normal.css" rel="stylesheet" />
		<style>
			.img-div {
				height: 30px;
				width: 30px;
				flex-shrink: 0;
			}
			
			.img-div img {
				width: 100%;
			}
			
			.config-button {
				display: flex;
				align-items: center;
				height: 41px;
				background-color: rgba(102, 102, 102, 0.12);
				width: 40%;
				justify-content: center;
			}
			
			.config-button-group {
				display: flex;
				align-items: center;
				justify-content: space-around;
				margin-top: 10px;
			}
			
			.mui-table-view-cell img {
				position: absolute;
				left: 15px;
				top: 12px;
				width: 36px;
				z-index: 100;
			}
			
			.mui-table-view .mui-table-view-cell {
				height: 60px;
			}
			
			.mui-table-view-cell .custom-left-icon+a {
				padding-left: 63px;
			}
			
			.doorMagnetismName {
				font-size: 16px;
				color: #333;
				width: 90%;
			}
			
			.doorMagnetismICMI {
				font-size: 14px;
				color: rgba(51, 51, 51, 0.4);
				width: 88%;
			}
			
			#doorMagnetismList {
				overflow-y: auto;
			}
			
			.title-one {
				font-size: 17px;
				color: #333333;
				padding-left: 17px;
				padding-top: 10px;
			}
			
			.total-style {
				color: rgba(51, 51, 51, 0.4);
			}
			
			.button-div {
				padding-left: 6px;
				color: rgba(51, 51, 51, 0.7);
				font-size: 16px;
			}
			
			.footButton {
				position: fixed;
				bottom: 0px;
			}
			
			.mui-table-view:after {
				height: 0px;
			}
			
			#configDoorLock {
				height: 30px;
				width: 30px;
				margin: 7px 0px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_doorMagnetismManagement">&nbsp;</h1>
			<img src="../images/appConfig/icon_3x.png" id="configDoorLock" class="mui-pull-right mui-hidden"></img>
		</header>
		<div class="mui-content">
			<div id="pageContent" class="mui-hidden">
				<div class="title-one" data-text="WEB_doorMagnetAdd">
					&nbsp;
				</div>
				<div class="config-button-group">
					<button class="config-button" id="scanAdd">
						<div class="img-div">
							<img src="../images/appConfig/Scancodetoadd3x.png" />
						</div>
						<div class="button-div private-ellipsis" data-text="WEB_scanCodeAdd">
							&nbsp;
						</div>
					</button>
					<button class="config-button" id="manualAdd">
						<div class="img-div">
							<img src="../images/appConfig/Manualentry3x.png" />
						</div>
						<div class="button-div private-ellipsis" data-text="WEB_manualInput">
							&nbsp;
						</div>
					</button>
				</div>
				<div class="title-one">
					<div data-text="WEB_doorMagnetList">
						&nbsp;
					</div>
					<div class="total-style" id="doorMagnetTotal">
						&nbsp;
					</div>
				</div>
				<ul class="mui-table-view" id="doorMagnetismList">
					<!--<li class="mui-table-view-cell">
					<img src="../images/appConfig/timeConfig.png" alt="" class="custom-left-icon" />
					<a class="mui-navigate-right" data-info="objInfo">
						<div class="doorMagnetismInfo">
							<div class="doorMagnetismName private-ellipsis">
								3-2-101
							</div>
							<div class="doorMagnetismICMI">
								132456794654545
							</div>
						</div>
					</a>
				</li>-->
				</ul>

			</div>
			<div class="footButton"></div>
		</div>

		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/libs/sha2.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/loadCss.js "></script>
    <script id="langScript"></script>
		<script>
			var isShowNoFunction; //无功能占位图
			var doorMagnetismList = []; //门磁列表;
			var isLoadingFinish = false;
			var totalNum;
			checkType(localStorage.AppType); //加载特定样式
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;
			document.body.style.paddingBottom = "0px";
			setTimeout(function() {
				initPage();
				initData();
				initEvent();
			}, 300);

			function initPage() {

			}

			function initData() {
				isShowNoFunction = true;
				var pageStart = 0;
				totalNum = 0;
				if(localStorage.deviceType == "0"){
					$("#configDoorLock").removeClass("mui-hidden");
				}
				initDoorMagnetismList(pageStart);
			}

			function initEvent() {
				document.getElementById("scanAdd").addEventListener("tap", function() {
					dsBridgeFuncAsyn.jumpNativeGetData(0, "", function(result) {
						var IEMIStirng = JSON.parse(result).param;
						if(IEMIStirng.length >= 15) {
							IEMIStirng = IEMIStirng.substr(0, 15);
							var reg = /^\d+$/;
							if(reg.test(IEMIStirng)) {
								var id = "settings_doorLockAdd";
								var Url = "web/newPages/" + id + ".html";
								var obj = {
									deviceSerial: localStorage.devSn20,
									channelNo: localStorage.channelId,
									imei: IEMIStirng
								};
								dsBridgeFuncSyn.pageTo(Url, JSON.stringify(obj));
							} else {
								showToast(langTip["WEB_ScanTip"]);
							}
						} else {
							showToast(langTip["WEB_ScanTip"]);
						}
					});
				});
				document.getElementById("manualAdd").addEventListener("tap", function() {
					var id = "settings_doorLockAdd";
					var Url = "web/newPages/" + id + ".html";
					var obj = {
						deviceSerial: localStorage.devSn20,
						channelNo: localStorage.channelId
					};
					dsBridgeFuncSyn.pageTo(Url, JSON.stringify(obj));
				});
				document.getElementById("configDoorLock").addEventListener("tap", function() {
					jumpToWebPage("settings_doorLockAlarm");
				});
			}

			function initDoorMagnetismList(pageStart) {
				var Map = {
					pageStart: pageStart,
					pageSize: 100,
					deviceSerial: localStorage.devSn20,
					channelNo: localStorage.channelId,
					sensorType: 0
				};
				CloudSendAjax("https://" + localStorage.serverAddress + openAPI.getSensorList, 'post', function(code, message, data) {
					if(code == 200) {
						totalNum = totalNum + data.sensorList.length;
						doorMagnetismList = doorMagnetismList.concat(data.sensorList);
						pageStart++;
						if(data.total > totalNum) {
							initDoorMagnetismList(pageStart);
						} else {
							initDoorMagnetismListPage();
						}
					} else {
						dsBridgeFuncSyn.dismiss();
						addBitmap(0);
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
					}
				}, Map);
			}

			function initDoorMagnetismListPage() {
				$("#doorMagnetismList").empty();
				mui("#doorMagnetismList").off("tap");
				$("#pageContent").removeClass("mui-hidden");
				var sceenHeight = document.getElementsByClassName("footButton")[0].getBoundingClientRect().top;;
				var elTop = document.getElementById("doorMagnetismList").getBoundingClientRect().top;

				console.log(sceenHeight);
				console.log(elTop);
				if(sceenHeight - elTop > doorMagnetismList.length * 60) {
					document.getElementById("doorMagnetismList").style.height = doorMagnetismList.length * 60 + "px";
				} else {
					document.getElementById("doorMagnetismList").style.height = sceenHeight - elTop + "px";
				}
				var parEl = document.getElementById("doorMagnetismList");
				for(var i = 0; i < doorMagnetismList.length; i++) {
					var liEl = document.createElement("li");
					liEl.className = "mui-table-view-cell";
					liEl.id = doorMagnetismList[i].imei;
					var imgEl = document.createElement("img");
					setEnableStatus(doorMagnetismList[i].alarmEnable, imgEl);
					imgEl.className = "custom-left-icon";
					var aEl = document.createElement("a");
					aEl.className = "mui-navigate-right";
					liEl.setAttribute("data-info", JSON.stringify(doorMagnetismList[i]));
					var div1 = document.createElement("div");
					div1.className = "doorMagnetismInfo";
					var div2 = document.createElement("div");
					var div3 = document.createElement("div");
					div2.className = "doorMagnetismName private-ellipsis";
					div3.className = "doorMagnetismICMI private-ellipsis";
					div2.id = "name" + doorMagnetismList[i].imei;
					div2.innerText = doorMagnetismList[i].name;
					div3.innerText = doorMagnetismList[i].imei;
					div1.appendChild(div2);
					div1.appendChild(div3);
					aEl.appendChild(div1);
					liEl.appendChild(imgEl);
					liEl.appendChild(aEl);
					parEl.appendChild(liEl);
				}
				document.getElementById("doorMagnetTotal").innerText = langTip["WEB_doorMagnetTotal"].replace("s%", doorMagnetismList.length);
				initDoorMagnetismListEvent();
			}

			function initDoorMagnetismListEvent() {
				mui("#doorMagnetismList li").each(function(index, El) {
					$(El).on("tap", function(e) {
						console.log(El);
						var id = "settings_doorLockConfig";
						var param = El.getAttribute("data-info");
						var Url = "web/newPages/" + id + ".html";
						dsBridgeFuncSyn.pageTo(Url, param);
					});
				});
				isLoadingFinish = true;
				dsBridgeFuncSyn.dismiss();

			}

			function refresh() {
				initDoorMagnetismList(0);
			}

			function setEnableStatus(enable, el) {
				if(enable == 1) {
					el.src = "../images/appConfig/doorLockOpen3x.png";
				} else {
					el.src = "../images/appConfig/doorLockClose3x.png";
				}
			}

			//修改页面尺寸
			dsBridge.register("callWebDoBaseFuncAsyn", function(args) {
				var webInfo = JSON.parse(args);
				for(var key in webInfo) {
					switch(webInfo[key].whichInfo) {
						case "rotation": // 绘图数据发还给运检测配置页面
							document.documentElement.style.height = webInfo[key].infoValue.screenHeight + "px";
							document.documentElement.style.width = webInfo[key].infoValue.screenWidth + "px";
							if(isLoadingFinish) {
								setTimeout(function() {
									var sceenHeight = document.getElementsByClassName("footButton")[0].getBoundingClientRect().top;;
									var elTop = document.getElementById("doorMagnetismList").getBoundingClientRect().top;
									if(sceenHeight - elTop > doorMagnetismList.length * 60) {
										document.getElementById("doorMagnetismList").style.height = doorMagnetismList.length * 60 + "px";
									} else {
										document.getElementById("doorMagnetismList").style.height = sceenHeight - elTop + "px";
									}
								}, 200);
							}
							break;
					}
				}
			});

			/******************新增原生App上报Web功能接口******************/
			dsBridge.register("callWebDoFuncAsyn", function(args) {
				appLog("Web --- args: " + args);
				var webInfo = JSON.parse(args);
				for(var key in webInfo) {
					switch(webInfo[key].whichInfo) {
						case "refreshDoorLockEnable":
							var upObj = JSON.parse(webInfo[key].infoValue);
							for(var i = 0; i < doorMagnetismList.length; i++) {
								if(upObj.imei == doorMagnetismList[i].imei) {
									$("#" + upObj.imei).attr("data-info", JSON.stringify(upObj));
									$("#name" + upObj.imei).text(upObj.name);
									doorMagnetismList[i] = upObj;
									var el = $("#" + upObj.imei + " img")[0];
									setEnableStatus(upObj.alarmEnable, el);
									break;
								}
							}
							break;
						case "refreshDoorLockList": // TODO：通道名称修改成功后，详情页同步更新
							dsBridgeFuncSyn.showLoading();
							totalNum = 0;
							doorMagnetismList = []
							refresh();
							break;
						case "deviceStatus": // 更新设备在线状态
							localStorage.deviceStatus = webInfo[key].infoValue;
							break;
						case "deviceName": //更新设备名称
							localStorage.deviceName = webInfo[key].infoValue;
							deviceNameVal.innerText = localStorage.deviceName;
							break;
						case "sdkType": //更新SDK类型
							localStorage.sdkType = webInfo[key].infoValue;
							accessProtocolVal.innerHTML = localStorage.sdkType;
							break;
						case "hasNewVersion": //是否有新版本
							localStorage.hasNewVersion = webInfo[key].infoValue;
							break;
						case "versionNumber": //当前版本号
							localStorage.versionNumber = webInfo[key].infoValue;
							deviceEditionVal.innerHTML = localStorage.versionNumber;
							break;
						case "LocalDeviceUname": //免注册设备用户名更新
							localStorage.LocalDeviceUname = webInfo[key].infoValue;
							deviceInfosVal.innerHTML = localStorage.LocalDeviceUname;
							break;
						default:
							break;
					}
				}
			})
		</script>
	</body>

</html>