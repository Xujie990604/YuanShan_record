<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title></title>
  <link href="../css/mui.css" rel="stylesheet" />
  <link href="../css/iconfont.css" rel="stylesheet" />
  <link href="../css/Common.css" rel="stylesheet" />
  <link href="../css/theme_normal.css" rel="stylesheet" />
  <style>
    .mui-table-view .mui-table-view-cell {
      height: 60px;
    }

    .mui-table-view-cell>a:not(.mui-btn) {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .mui-table-view-cell>a:not(.mui-btn)>div {
      display: inline-block;
    }

    .mui-table-view .mui-media-object {
      height: 100%;
    }

    .mui-table-view .mui-media-body.ui-single {
      height: 100%;
      line-height: 36px;
    }

    .mui-ellipsis {
      line-height: 16px;
    }

    .mui-table-view-cell {
      padding: 12px 15px;
    }
  </style>
</head>

<body>
  <header class="mui-bar mui-bar-nav">
    <a id="back" class="mui-icon iconfont icon-back1"></a>
    <h1 id="title" class="mui-title" data-text="WEB_motion_detection_time_quantum"></h1>
  </header>
  <div class="mui-content">
    <ul id="CheckTimeStepList" class="mui-table-view mui-table-view-radio">
      <li id="allday" data-type='allday' class="mui-table-view-cell mui-media">
        <a class="mui-navigate-right">
          <img class="mui-media-object mui-pull-left" src="../images/all_day@3x.png">
          <div class="mui-media-body ui-single">
            <span data-text="WEB_all_day">&nbsp;</span>
            <p class='mui-ellipsis'>&nbsp;</p>
          </div>
        </a>
      </li>
      <li id="custom" data-type='selfDIY' class="mui-table-view-cell mui-media">
        <a class="mui-navigate-right">
          <img class="mui-media-object mui-pull-left" src="../images/customize@3x.png">
          <div class="mui-media-body ui-single">
            <span data-text="WEB_custom_title">&nbsp;</span>
            <p id="timestr" class='mui-ellipsis'>&nbsp;</p>
          </div>
        </a>
      </li>
    </ul>
    <p class="ui-tishi">
      <span data-text="WEB_weekplan_tip1">&nbsp;</span><br><span data-text="WEB_weekplan_tip2">&nbsp;</span>
    </p>
  </div>

  <script src="../js/dsbridge.min.js"></script>
  <script src="../js/common.js"></script>
  <script src="../js/libs/md5.js"></script>
  <script src="../js/libs/jquery-3.4.1.min.js"></script>
  <script src="../js/libs/sha2.js"></script>
  <script src="../js/resource.js"></script>
  <script src="../js/Utils.js"></script>
  <script src="../js/mui.js"></script>
  <script src="../js/immersed.js"></script>
  <script src="../js/customSetting.js"></script>
  <script src="../js/loadCss.js"></script>
  <script id="langScript"></script>
  <script>
    var langTip;
    var self;
    var parentW;
    var checkDate;
    var ServiceData;
    var timeCustom;
    var isCrossDay = false;
    var dataBack;
    var allday = document.getElementById('allday');
    var custom = document.getElementById('custom');
    var alldayChecked;
    var customChecked;
    var isCapality;
    var LAPIstr;
    var sendData;
    checkType(localStorage.AppType); //加载特定样式
    mui.init();
    var typeLan = initLang();
    langTip = typeLan.lang;

    initData();
    initEvent();
    setTimeout(function () {
      dsBridgeFuncSyn.dismiss();
    }, 500)

    function initData() {
      // TODO：获取各告警配置的服务端数据（动检、人形、自动跟踪）
      var Url = "web/newPages/settings_CheckTime.html";
      var self = dsBridgeFuncSyn.getWebParam(Url);
      self = JSON.parse(self);
      checkDate = self.checkDate;
      isCapality = self.isCapality;
      if (isCapality == 1) {
        LAPIstr = LAPI.WeekPlan;
      } else if (isCapality == 2) {
        LAPIstr = LAPI.DetectionWeekPlan;
      } else {
        LAPIstr = LAPI.HumanWeekPlan;
      }
      ServiceData = self.ServiceData;
      isCrossDay = judgeIsAcrossDay(ServiceData);
      timeCustom = getTimeType(ServiceData).timeCustom;
      if (isCrossDay) {
        timeCustomAcrossDay = getTimeType(ServiceData, 1).timeCustom;
        timeCustom.endHour = timeCustomAcrossDay.endHour;
        timeCustom.endMin = timeCustomAcrossDay.endMin;
        timeCustom.endSec = timeCustomAcrossDay.endSec;
      }
      dataBack = checkDate;
      sendData = deepCopy(ServiceData);
      initTime();
      if (localStorage.deviceType == "0") {
        sendData.Num = 7;
      } else {
        sendData.Num = 8;
      }
      alldayChecked = allday.classList.contains("mui-selected"); //点击前全天是否选中
      customChecked = custom.classList.contains("mui-selected"); //点击前自定义是否选中
    }

    function initEvent() {
      allday.addEventListener('tap', allDay);
      custom.addEventListener('tap', customs);
    }

    function add0(num) {
      var str = "";
      if (num < 10) {
        str = str + "0" + num;
      } else {
        str = str + num;
      }
      return str;
    }

    /**
     * 设置界面显示时间段函数
     * @param {Object} obj
     */
    function setTimeStr(obj) {
      var sendIsAcrossDay = true;
      if (obj.endHour > obj.startHour) {
        sendIsAcrossDay = false;
      } else if (obj.endHour == obj.startHour) {
        if (obj.endMin > obj.startMin) {
          sendIsAcrossDay = false;
        } else if (obj.endMin == obj.startMin) {
          if (obj.endSec > obj.startSec) {
            sendIsAcrossDay = false;
          }
        }
      }
      var timestr = add0(obj.startHour) + ":" + add0(obj.startMin) + ":" + add0(obj.startSec) + "-" + add0(obj.endHour) + ":" + add0(obj.endMin) + ":" + add0(obj.endSec);
      var el = document.getElementById("timestr");
      if (sendIsAcrossDay) {
        el.innerText = timestr + "(" + langTip["WEB_nextDay"] + ")";
      } else {
        el.innerText = timestr;
      }

      el.parentElement.classList.remove("ui-single");
    }

    function initTime() {
      if (checkDate == langTip["WEB_all_day"]) {
        allday.classList.add('mui-selected');
      } else if (checkDate == langTip["WEB_custom_title"]) {
        custom.classList.add('mui-selected');
        if (!isCrossDay) {
          //设置界面显示时间段
          if (timeCustom.endHour == 24) {
            timeCustom.endHour = 23;
            timeCustom.endMin = 59;
            timeCustom.endSec = 59;
          };
        }
        if (isCrossDay) {
          //设置界面显示时间段
          if (timeCustom.endHour == 0 && timeCustom.endMin == 0 && timeCustom.endSec == 0) {
            timeCustom.endHour = 23;
            timeCustom.endMin = 59;
            timeCustom.endSec = 59;
          };
        }
        setTimeStr(timeCustom);
      }
    }

    function allDay() {
      if (alldayChecked) {
        if (!allday.classList.contains("mui-selected")) {
          allday.classList.add("mui-selected");
        }
        if (custom.classList.contains("mui-selected")) {
          custom.classList.remove("mui-selected");
        }
        return;
      }
      for (var i = 0; i < sendData.Days.length; i++) {
        if (sendData.Days[i].Num == 0) {
          sendData.Days[i]["TimeSectionInfos"] = [{
            "Begin": "00:00:00",
            "End": "23:59:59",
            "ArmingType": 0
          }];
        }
        sendData.Days[i].TimeSectionInfos.splice(1, sendData.Days[i].TimeSectionInfos.length);
        if (localStorage.deviceType == "0") {
          for (var j = 0; j < 4; j++) {
            if (j == 0) {
              sendData.Days[i].TimeSectionInfos[j].Begin = "00:00:00";
              sendData.Days[i].TimeSectionInfos[j].End = "23:59:59";
            } else {
              sendData.Days[i].TimeSectionInfos.push({
                "Begin": "24:00:00",
                "End": "24:00:00",
                "ArmingType": sendData.Days[i].TimeSectionInfos[0].ArmingType
              });
            }
          }
        } else {
          sendData.Days[i].Num = 8;
          for (var j = 0; j < 8; j++) {
            if (j == 0) {
              sendData.Days[i].TimeSectionInfos[j].Begin = "00:00:00";
              sendData.Days[i].TimeSectionInfos[j].End = "24:00:00";
            } else {
              var item = {
                "Begin": "00:00:00",
                "End": "00:00:00",
                "ArmingType": sendData.Days[i].TimeSectionInfos[0].ArmingType
              };
              sendData.Days[i].TimeSectionInfos.push(item);
            }
          }
        }
      }
      dataBack = langTip["WEB_all_day"];
      dsBridgeFuncSyn.showLoading();
      SendAjax(LAPIstr, 'put', function (code, data) {
        dsBridgeFuncSyn.dismiss();
        if (code == 0) {
          ServiceData = deepCopy(sendData);
          allday.classList.add("mui-selected");
          custom.classList.remove("mui-selected");
          var el = document.getElementById("timestr");
          el.innerText = "";
          el.parentElement.classList.add("ui-single");
          alldayChecked = true;
          customChecked = false;
          // TODO: 时间数据发送给上一页面
          var param = {
            dataBackTxt: dataBack,
            ServiceData: ServiceData,
            isCapality: isCapality
          }
          dsBridgeFuncSyn.sendDataToReport("reshTimeStepVal", JSON.stringify(param));
        } else {
          allday.classList.remove("mui-selected");
          alldayChecked = false;
          if (customChecked) {
            custom.classList.add("mui-selected");
          }
          showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
        }
      }, sendData);
    }

    function customs() {
      dataBack = langTip["WEB_custom_title"];
      if (timeCustom.endHour == 24) {
        timeCustom.endHour = 23;
        timeCustom.endMin = 59;
        timeCustom.endSec = 59;
      };
      var sendIsAcrossDay = true;
      // TODO:调用原生APP时间选择器控件
      dsBridgeFuncAsyn.showDate("hdate_ex", JSON.stringify(timeCustom), function (result) {
        var result = JSON.parse(result);
        if (result.statusCode == "1" && customChecked) return;
        if (result.statusCode == "1" && !customChecked) {
          if (alldayChecked) {
            allday.classList.add("mui-selected");
          }
          custom.classList.remove("mui-selected");
          return;
        }
        var resultObj = JSON.parse(result.param);
        if (resultObj.endHour > resultObj.startHour) {
          sendIsAcrossDay = false;
        } else if (resultObj.endHour == resultObj.startHour) {
          if (resultObj.endMin > resultObj.startMin) {
            sendIsAcrossDay = false;
          } else if (resultObj.endMin == resultObj.startMin) {
            if (resultObj.endSec > resultObj.startSec) {
              sendIsAcrossDay = false;
            } else if (resultObj.endSec == resultObj.startSec) {
              allDay();
              return;
            }
          }
        }
        if (sendIsAcrossDay) {
          AcrossDaySet(resultObj);
        } else {
          normalSet(resultObj);
        }
        dsBridgeFuncSyn.showLoading();
        SendAjax(LAPIstr, 'put', function (code, data) {
          dsBridgeFuncSyn.dismiss();
          if (code == 0) {
            ServiceData = deepCopy(sendData);
            timeCustom = {
              "startHour": resultObj.startHour,
              "startMin": resultObj.startMin,
              "startSec": resultObj.startSec,
              "endHour": resultObj.endHour,
              "endMin": resultObj.endMin,
              "endSec": resultObj.endSec,
            };
            allday.classList.remove("mui-selected");
            custom.classList.add("mui-selected");
            alldayChecked = false;
            customChecked = true;
            if (sendIsAcrossDay) {
              //设置界面显示时间段
              if (timeCustom.endHour == 0 && timeCustom.endMin == 0 && timeCustom.endSec == 0) {
                timeCustom.endHour = 23;
                timeCustom.endMin = 59;
                timeCustom.endSec = 59;
              };
            }
            setTimeStr(timeCustom);
            // TODO: 时间数据发送给上一页面
            var param = {
              dataBackTxt: dataBack,
              ServiceData: ServiceData,
              isCapality: isCapality
            }
            dsBridgeFuncSyn.sendDataToReport("reshTimeStepVal", JSON.stringify(param));
          } else {
            if (!customChecked) {
              custom.classList.remove("mui-selected");
            }
            if (alldayChecked) {
              allday.classList.add("mui-selected");
            }
            showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
          }
        }, sendData);
      })
    }

    function AcrossDaySet(resultObj) {
      var begin = add0(resultObj.startHour) + ":" + add0(resultObj.startMin) + ":" + add0(resultObj.startSec);
      var end = add0(resultObj.endHour) + ":" + add0(resultObj.endMin) + ":" + add0(resultObj.endSec);
      for (var i = 0; i < sendData.Days.length; i++) {
        if (sendData.Days[i].Num < 2) {
          sendData.Days[i]["TimeSectionInfos"] = [{
            "Begin": "00:00:00",
            "End": "23:59:59",
            "ArmingType": 0
          }, {
            "Begin": "00:00:00",
            "End": "23:59:59",
            "ArmingType": 0
          }];
        }
        sendData.Days[i].TimeSectionInfos.splice(2, sendData.Days[i].TimeSectionInfos.length);
        if (localStorage.deviceType == "0") {
          for (var j = 0; j < 4; j++) {
            if (j == 0) {
              sendData.Days[i].TimeSectionInfos[j].Begin = begin;
              sendData.Days[i].TimeSectionInfos[j].End = "23:59:59";
            } else if (j == 1) {
              sendData.Days[i].TimeSectionInfos[j].Begin = "00:00:00";
              sendData.Days[i].TimeSectionInfos[j].End = end;
            } else {
              var item = {
                "Begin": "24:00:00",
                "End": "24:00:00",
                "ArmingType": sendData.Days[i].TimeSectionInfos[0].ArmingType
              };
              sendData.Days[i].TimeSectionInfos.push(item);
            }
          }
        } else {
          sendData.Days[i].Num = 8;
          for (var j = 0; j < 8; j++) {
            if (j == 0) {
              sendData.Days[i].TimeSectionInfos[j].Begin = begin;
              sendData.Days[i].TimeSectionInfos[j].End = "24:00:00";
            } else if (j == 1) {
              sendData.Days[i].TimeSectionInfos[j].Begin = "00:00:00";
              sendData.Days[i].TimeSectionInfos[j].End = end;
            } else {
              var item = {
                "Begin": "00:00:00",
                "End": "00:00:00",
                "ArmingType": sendData.Days[i].TimeSectionInfos[0].ArmingType
              };
              sendData.Days[i].TimeSectionInfos.push(item);
            }
          }
        }
      }

    }

    function normalSet(resultObj) {
      var begin = add0(resultObj.startHour) + ":" + add0(resultObj.startMin) + ":" + add0(resultObj.startSec);
      var end = add0(resultObj.endHour) + ":" + add0(resultObj.endMin) + ":" + add0(resultObj.endSec);

      if (begin == end) {
        showToast(langTip["WEB_dialog_time_edit"]);
        return;
      }
      if (localStorage.deviceType != "0" && resultObj.endHour == 23 && resultObj.endMin == 59 && resultObj.endSec != 0) {
        end = "24:00:00";
      }
      if (resultObj.startHour == 0 && resultObj.startMin == 0 && resultObj.startSec == 0 && resultObj.endHour == 23 && resultObj.endMin == 59 && resultObj.endSec != 0) {
        dataBack = langTip["WEB_all_day"];
      }
      for (var i = 0; i < sendData.Days.length; i++) {
        if (sendData.Days[i].Num == 0) {
          sendData.Days[i]["TimeSectionInfos"] = [{
            "Begin": "00:00:00",
            "End": "23:59:59",
            "ArmingType": 0
          }];
        }
        sendData.Days[i].TimeSectionInfos.splice(1, sendData.Days[i].TimeSectionInfos.length);
        if (localStorage.deviceType == "0") {
          for (var j = 0; j < 4; j++) {
            if (j == 0) {
              sendData.Days[i].TimeSectionInfos[j].Begin = begin;
              sendData.Days[i].TimeSectionInfos[j].End = end;
            } else {
              var item = {
                "Begin": "24:00:00",
                "End": "24:00:00",
                "ArmingType": sendData.Days[i].TimeSectionInfos[0].ArmingType
              };
              sendData.Days[i].TimeSectionInfos.push(item);
            }
          }
        } else {
          sendData.Days[i].Num = 8;
          for (var j = 0; j < 8; j++) {
            if (j == 0) {
              sendData.Days[i].TimeSectionInfos[j].Begin = begin;
              sendData.Days[i].TimeSectionInfos[j].End = end;
            } else {
              var item = {
                "Begin": "00:00:00",
                "End": "00:00:00",
                "ArmingType": sendData.Days[i].TimeSectionInfos[0].ArmingType
              };
              sendData.Days[i].TimeSectionInfos.push(item);
            }
          }
        }
      }
    }
  </script>
</body>

</html>