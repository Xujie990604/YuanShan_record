<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<link href="../css/theme_normal.css" rel="stylesheet" />
		<style>
			.ui-list-titile label {
				text-align: center;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_dayNightMode">&nbsp;</h1>
		</header>
		<div class="mui-content">
			<div id="EZView-content" class="mui-hidden">
				<!--昼夜模式设置-->
				<ul id="dayNight" class="mui-table-view">
					<li id="setDayNight" class="mui-table-view-cell">
						<a href="#setDayNightMode" class="mui-navigate-right">&nbsp;
							<span data-text="WEB_dayNightMode" class="mainStyle">&nbsp;</span>
							<span id="setDayNightVal" class="mui-badge"></span>
						</a>
						<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
					</li>
					<li id="nightTime" class="mui-table-view-cell StarTimeItem mui-hidden">
						<a id="StarTimeArea" class="mui-navigate-right">&nbsp;
							<span data-text="WEB_start_end_time" class="mainStyle padding-left-15">&nbsp;</span>
							<span id="TimeStepVal" class="mui-badge "></span>
						</a>
						<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
					</li>
				</ul>
			</div>
		</div>
		<!--昼夜模式-->
		<div id="setDayNightMode" class="mui-popover mui-popover-action mui-popover-bottom ui-radio-list">
			<form class="mui-input-group">
				<div class="mui-input-row mui-checkbox ui-list-titile" id="swipedownDiv">
					<label data-text="WEB_dayNightMode">&nbsp;</label>
					<span id="closeDayNightMode" class="mui-icon mui-icon-closeempty"></span>
				</div>
				<ul id="DayNightModeList" class="mui-table-view mui-table-view-radio">

				</ul>
			</form>
			<button id="DayNightModeOk" class="mui-btn mui-btn-block ui-dateok" data-text="WEB_button_ok">&nbsp;</button>
		</div>

		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/libs/sha2.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/loadCss.js "></script>
    <script id="langScript"></script>
		<script>
			checkType(localStorage.AppType); //加载特定样式
			var langTip;
			//宽动态配置
			var setWideDynamicConfirm = true; //宽动态开关状态变化时是否调接口提交
			var WideDynamicCheck;
			// 昼夜模式设置
			var setImageCapabilities;
			var dayNightModeChecked; //选中的昼夜模式
			var imageServiceData; // 图像配置服务端数据
			var LightModeChecked;
			var date = { //初始化起止时间
				startHour: 0,
				startMin: 0,
				startSec: 0,
				endHour: 0,
				endMin: 0,
				endSec: 0
			};
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;
			initData();
			initEvent();

			function initData() {
				initsetImage(); //发请求获取昼夜模式
			}

			function initEvent() {
				document.getElementById('setDayNightMode').addEventListener('hidden', function(e) {
					//针对点击其他地方会隐藏弹窗，故隐藏的时候需确保每次弹窗选中的都是已保存昼夜模式
					mui('#DayNightModeList a').each(function(index, El) {
						if(El.getAttribute('data-value') == dayNightModeChecked) {
							El.parentNode.classList.add('mui-selected');
						} else {
							El.parentNode.classList.remove('mui-selected');
						}
					});
				});
				document.getElementById('closeDayNightMode').addEventListener('tap', closeDayNightMode);
				document.getElementById('DayNightModeOk').addEventListener('tap', DayNightModeOk);
				document.getElementById('nightTime').addEventListener('tap', getTimeFrame);

				// 手势操作：向下滑动关闭弹框
				document.getElementById("swipedownDiv").addEventListener("swipedown", function() {
					mui('#setDayNightMode').popover('toggle');
				});
			}

			/**
			 * 图像设置使能
			 */
			function initsetImage() {
				var Url = "web/newPages/settings_DayNight.html";
				var self = dsBridgeFuncSyn.getWebParam(Url);
				self = JSON.parse(self);
				var data = self.capacityData;
				setImageCapabilities = deepCopy(data);
				getDayNightModeList(setImageCapabilities.Exposure.DayNight.DayNightModeList);
				setDayNightData();
			}

			/**
			 * 设置昼夜模式文字转换
			 * @param {Object} mode
			 */
			function setDayNightText(mode) {
				var text = '';
				if(mode == 0) {
					text = langTip["WEB_auto"];
				} else if(mode == 1) {
					text = langTip["WEB_dayTime"];
				} else if(mode == 2) {
					text = langTip["WEB_nightTime"];
				} else if(mode == 4) {
					text = langTip["WEB_nightTiming"];
				}
				return text;
			}

			/**
			 * 昼夜模式列表在页面中显示
			 * @param {Object} data
			 */
			function getDayNightModeList(data) {
				var DayNightModeList = document.getElementById('DayNightModeList');
				var listVal;
				for(var i = 0; i < data.length; i++) {
					listVal = setDayNightText(data[i]);
					var item = document.createElement('li');
					item.className = 'mui-table-view-cell installType';
					item.innerHTML = '<a class="mui-navigate-right" data-value=' + data[i] + '>&nbsp;' + listVal + '</a>';
					DayNightModeList.appendChild(item);
				}
			}
			/*
			 * 发请求获取昼夜设置数据初始化
			 */
			function setDayNightData() {
				SendAjax(LAPI.DayNightInfo, 'get', function(code, data) {
					if(code == 0) {
						$("#EZView-content").removeClass("mui-hidden");
						imageServiceData = deepCopy(data);
						var dayNightModeText = '';
						//初始化昼夜模式
						dayNightModeChecked = imageServiceData.DayNight.Mode;
						dayNightModeText = setDayNightText(dayNightModeChecked);
						document.getElementById('setDayNightVal').innerText = dayNightModeText;
						mui('#DayNightModeList a').each(function(index, El) {
							if(El.getAttribute('data-value') == dayNightModeChecked) {
								El.parentNode.classList.add('mui-selected');
							}
						});
						if(dayNightModeChecked == 4) {
							//显示定时夜晚的起止时间配置选项
							var statrTime = imageServiceData.DayNight.Start;
							var endTime = imageServiceData.DayNight.End;
							document.getElementById('nightTime').classList.remove('mui-hidden');
							document.getElementById('TimeStepVal').innerText = statrTime + "-" + endTime;
						}
						dsBridgeFuncSyn.dismiss();
					} else {
						//数据获取失败的处理
						addBitmap(0);
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						dsBridgeFuncSyn.dismiss();
					}
				});
			}

			/*
			 * 监听昼夜模式
			 */
			function closeDayNightMode() {
				mui('#setDayNightMode').popover('toggle');
			}

			function DayNightModeOk() {
				var sendData = deepCopy(imageServiceData);
				var dayNightModeChecked_new;
				mui('#DayNightModeList a').each(function(index, El) {
					if(El.parentNode.classList.contains('mui-selected')) {
						dayNightModeChecked_new = Number(El.getAttribute('data-value'));
					}
				});
				if(dayNightModeChecked_new == 4) {
					var date0 = {
						startHour: 0,
						startMin: 0,
						startSec: 0,
						endHour: 0,
						endMin: 0,
						endSec: 0
					}
					setBrageTime(date0, dayNightModeChecked);
				} else {
					sendData.DayNight.Mode = dayNightModeChecked_new;
					dsBridgeFuncSyn.showLoading();
					SendAjax(LAPI.DayNightInfo, 'put', function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {
							document.getElementById('nightTime').classList.add('mui-hidden');
							imageServiceData = deepCopy(sendData);
							dayNightModeChecked = dayNightModeChecked_new;
							document.getElementById('setDayNightVal').innerText = setDayNightText(dayNightModeChecked);
						} else {
							if(LightModeChecked != document.getElementById('setImageLightVal').innerText.trim()) {
								mui('#DayNightModeList a').each(function(index, El) {
									if(El.getAttribute('data-value') == dayNightModeChecked) {
										El.parentNode.classList.add('mui-selected');
									} else {
										El.parentNode.classList.remove('mui-selected');
									}
								});
							}
							showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
						}
						mui('#setDayNightMode').popover('toggle');
					}, sendData);
				}
			}

			/**
			 * 起止时间设置
			 */
			function getTimeFrame() {
				var v = document.getElementById('nightTime');
				var startType = v.children["StarTimeArea"].children["TimeStepVal"].innerText.split("-")[0];
				var endType = v.children["StarTimeArea"].children["TimeStepVal"].innerText.split("-")[1];
				date = transterTime(startType, endType);
				if(date.startHour == "24" && date.startMin == "00" && date.startSec == "00" && //开始时间和结束时间为24:00:00时，改为00:00:00
					date.endHour == "24" && date.endMin == "00" && date.endSec == "00") {
					date = {
						startHour: 0,
						startMin: 0,
						startSec: 0,
						endHour: 0,
						endMin: 0,
						endSec: 0
					}
				}
				setBrageTime(date);
			}

			function setBrageTime(date, dayNightMode) {
				//昼夜模式对起止时间不做校验
				//TODO：调用原生侧时间选择器控件
				dsBridgeFuncAsyn.showDate("hdate_ex", JSON.stringify(date), function(result) {
					var result = JSON.parse(result);
					if(result.statusCode == "1") return;
					var resultObj = JSON.parse(result.param);
					var begin = add0(resultObj.startHour) + ":" + add0(resultObj.startMin) + ":" + add0(resultObj.startSec);
					var end = add0(resultObj.endHour) + ":" + add0(resultObj.endMin) + ":" + add0(resultObj.endSec);
					var sendData = deepCopy(imageServiceData);
					var DayArr = sendData.DayNight;
					DayArr.Mode = 4;
					DayArr.Start = begin;
					DayArr.End = end;
					dsBridgeFuncSyn.showLoading();
					SendAjax(LAPI.DayNightInfo, 'put', function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {
							//赋值给setDayNightServiceData并更新页面
							document.getElementById('nightTime').classList.remove('mui-hidden');
							document.getElementById('setDayNightVal').innerText = setDayNightText(4);
							var nightTime = document.getElementById('nightTime');
							nightTime.children["StarTimeArea"].children["TimeStepVal"].innerText = begin + "-" + end;
							imageServiceData = deepCopy(sendData);
							dayNightModeChecked = 4;
							//配置成功 知会原生侧
							dsBridgeFuncSyn.alreadySetTimeCfg();

						} else {
							showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
						}
					}, sendData);
				});
			}

			function add0(num) {
				var str = "";
				if(num < 10) {
					str = str + "0" + num;
				} else {
					str = str + num;
				}
				return str;
			}

			/**
			 * 时间赋值
			 * @param {Object} startTime
			 * @param {Object} endTime
			 */
			function transterTime(startTime, endTime) {
				var start = startTime.split(":").map(function(v) {
					return Number(v)
				})
				var end = endTime.split(":").map(function(v) {
					return Number(v)
				})
				date = {
					startHour: start[0],
					startMin: start[1],
					startSec: start[2],
					endHour: end[0],
					endMin: end[1],
					endSec: end[2]
				}
				return date
			}
		</script>
	</body>

</html>