<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<link href="../css/theme_normal.css" rel="stylesheet" />
		<style>
			.mui-popover .mui-scroll-wrapper {
				margin: 1px 0;
			}
			.ui-Gallery-item {
				height: 48px !important;
			}
			
			.mui-input-row.ui-Gallery-item span {
				line-height: 48px;
			}
			
			.ui-Gallery-item input[type='checkbox'] {
				top: 11px;
			}
			
			.mainStyle {
			    white-space: nowrap;
			    text-overflow: ellipsis;
			    overflow: hidden;
			    width: 50%;
			    display: inline-block;
			    height: 56px;
			    line-height: 56px;
			    position: absolute;
			    top: 0px;
			    left: 15px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_storageConfig">&nbsp;</h1>
		</header>
		<div class="mui-content">
			<!--nvr 满覆盖-->
			<ul class="mui-table-view mui-hidden" id="settings_NVRFullCover">
				<li id="FullCoverItem" class="mui-table-view-cell ">
					<span data-text="WEB_Full_Coverage" class="mainStyle">&nbsp;</span>
					<div id="FullCoverSwitch" class="mui-switch mui-switch-mini">
						<div class="mui-switch-handle"></div>
					</div>
					<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
				</li>
			</ul>

			<ul class="mui-table-view" id="baseUl">
				<!--SD卡配置-->
				<li class="mui-table-view-cell mui-hidden" id="settings_SDCard">
					<a class="mui-navigate-right" data-text="WEB_sd_config">&nbsp;</a>
				</li>
			
				<!--录像计划-->
				<li class="mui-table-view-cell mui-hidden" id="settings_VideoPlan">
					<a class="mui-navigate-right" data-text="WEB_device_manager_record_schedule">&nbsp;</a>
				</li>
				<!--通道选择-->
				<li class="mui-table-view-cell mui-hidden" id="setGallery">
					<a href="#VideoGallery" id="resetGallery" class="mui-navigate-right">&nbsp;
						<span data-text="WEB_alarm_setting_channel" class="mainStyle">&nbsp;</span>
						<span id="VideoGalleryVal" class="mui-badge"></span>
					</a>
					<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
				</li>
			</ul>
		</div>
				<!--录像通道弹框-->
				<div id="VideoGallery" class="mui-popover mui-popover-action mui-popover-bottom">
					<form id="VideoGalleryList" class="mui-input-group">
						<div class="mui-input-row mui-checkbox ui-list-titile" id="swipedownDiv3">
							<label data-text="WEB_alarm_setting_channel" class="alarm_setting_channel">&nbsp;</label>
						</div>
						<div class="mui-input-row mui-checkbox ">
							<label data-text="WEB_select_all">&nbsp;</label>
							<input id="GalleryAll" name="GalleryAll" value="all" type="checkbox">
						</div>
						<div id="GalleryListC" class="ui-list-container">
							<div class="mui-scroll-wrapper">
								<div id="GalleryList" class="mui-scroll">
		
								</div>
							</div>
						</div>
					</form>
					<button id="VideoGalleryOk" class="mui-btn mui-btn-block ui-dateok" data-text="WEB_button_ok">&nbsp;</button>
				</div>

		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/libs/sha2.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/loadCss.js "></script>
    <script id="langScript"></script>
		<script>
			checkType(localStorage.AppType); //加载特定样式
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;
            var getAlarmMsg = false; //是否开启满覆盖
			var channelInfoData;
			var channelID = [];
			var disabledID = [];
			initPage();
			initEvent();

			function initPage() {
				dsBridgeFuncSyn.dismiss();
				$("#baseUl").removeClass("mui-hidden");
				if(localStorage.deviceType == "0"&& localStorage.channelId == "0") {
					$("#settings_SDCard").removeClass("mui-hidden");
				}
				if(localStorage.deviceType == "1" && localStorage.channelId == "0") {
					$("#settings_NVRFullCover").removeClass("mui-hidden");
					$("#settings_VideoPlan").removeClass("mui-hidden");
					$("#setGallery").removeClass("mui-hidden");
					// setGallery
					initData()
				}
				if(localStorage.deviceType == "1" && localStorage.channelId != "0") {
					$("#settings_VideoPlan").removeClass("mui-hidden");
				}
				if(localStorage.deviceType == "0"&& localStorage.channelId != "0" && localStorage.isMultiChannelIPC =="1"){
					$("#settings_SDCard").removeClass("mui-hidden");
				}
			}

			function initData() {
				
				getChannelDetailInfos();
				initFullCover();
				
				mui('.mui-scroll-wrapper').scroll();
			}

			function initEvent() {
				// IPC SD卡
				document.getElementById("settings_SDCard").addEventListener('tap', function() {
					jumpToWebPage("settings_SDCardNew");
				});		
				
				document.getElementById("FullCoverSwitch").addEventListener("toggle", function(event) {
					FullCoverSwitch(event); //满覆盖开关事件处理
				});

				// NVR通道录像计划
				document.getElementById("settings_VideoPlan").addEventListener('tap', function() {
					var Extras = {
						channelID,
						disabledID
				}
				// TODO:页面跳转+传参
				jumpToWebPage("settings_VideoPlan", JSON.stringify(Extras))
					// jumpToWebPage("settings_VideoPlan");
				});
				//录像通道全选事件
				document.getElementById('GalleryAll').addEventListener('change', GalleryAll); 
				//录像通道选项改变监听
				mui('#VideoGalleryList').on('change', 'input', VideoGalleryList); 
				//录像通道确定事件
				document.getElementById('VideoGalleryOk').addEventListener('tap', VideoGalleryOk); 
                // 点击通道事件
				document.getElementById('resetGallery').addEventListener('tap', function() {
					mui('#VideoGalleryList input').each(function(index, El) {
						if(index !== 0) {
							El.checked = false;
							if(isInArr(channelID, El.value) || isInArr(disabledID, El.value)) {
								El.checked = true;
							}
						}
					});
					var checkedLen = mui('.checkedGalleryList:checked').length;
					if(checkedLen == mui('#VideoGalleryList input').length - 1) {
						document.getElementById('GalleryAll').checked = true;
					} else {
						document.getElementById('GalleryAll').checked = false;
					}
				})

				// 手势操作：向下滑动关闭弹框
				document.getElementById("swipedownDiv3").addEventListener("swipedown", function() {
					mui('#VideoGallery').popover('toggle');
				});
			}
			/**
			 * 通道全选
			 */
			 function GalleryAll() {
				var checkall = document.getElementById('GalleryAll').checked;
				if(checkall) {
					mui('#VideoGalleryList input').each(function(index, El) {
						El.checked = true;
					})
				} else {
					mui('#VideoGalleryList input').each(function(index, El) {
						El.checked = false;
						if(El.disabled) {
							El.checked = true;
						}
					})
				}
			}
		     /**
			 * 获取通道信息
			 */
			 function getChannelDetailInfos() {
				dsBridgeFuncSyn.showLoading();
				SendAjax(LAPI.ChannelDetailInfos, 'get', function(code, data) {
					dsBridgeFuncSyn.dismiss();
					if(code == 0) {
						var infoData = deepCopy(data);
						channelInfoData = infoData.DetailInfos;
						var showLenght = [];
						var channelLen = channelInfoData.length;
						for(var i = 0; i < channelLen; i++) {
							if(channelInfoData[i].Status == 0 || channelInfoData[i].Status == 1) {
								if(channelInfoData[i].Status == 1) {
									channelID.push(channelInfoData[i].ID);
								} else if(channelInfoData[i].Status == 0) {
									disabledID.push(channelInfoData[i].ID);
								}
								showLenght.push(channelInfoData[i]);
							}
						}
						if(channelID.length == 0) {
							document.getElementById("GalleryAll").setAttribute("disabled", 'disabled');
						}
						setGalleryList(showLenght);
					} else {
					$("#settings_NVRFullCover").addClass("mui-hidden");
					$("#settings_VideoPlan").addClass("mui-hidden");
					$("#setGallery").addClass("mui-hidden");
						addBitmap(0);
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						dsBridgeFuncSyn.dismiss();
					}
				});
			}

			/**
			 * 通道确定
			 */
			 function VideoGalleryOk() {
				var channelIdTem = [];
				//获取选取通道
				mui('#VideoGalleryList input').each(function(index, El) {
					if(El.checked && !El.disabled) {
						channelIdTem.push(El.value);
					}
					if(isInArr(channelIdTem, 'all')) {
						channelIdTem.splice(index, 1)
					}
				});
				if(channelIdTem.length == 0) {
					showToast(langTip["WEB_check_camara"]);
					return;
				}
				channelID = channelIdTem;
				mui('#VideoGallery').popover('toggle');
			}


			/**
			 * 通道列表
			 */
			 function VideoGalleryList() {
				var GalleryAll = document.getElementById('GalleryAll');
				var Gallerys = document.querySelectorAll('#VideoGalleryList input');
				var allchecked = true;
				for(var i = 1; i < Gallerys.length; i++) {
					if(!Gallerys[i].checked) {
						allchecked = false;
						break;
					}
				}
				allchecked ? GalleryAll.checked = true : GalleryAll.checked = false;
			}

			/**
			 * 通道列表
			 * @param {Object} setGalleryList
			 */
			function setGalleryList(setGalleryList) {
				var GalleryList = document.getElementById('GalleryList');
				var GalleryListC = document.getElementById('GalleryListC');
				var data = setGalleryList;
				if(data.length > 5) {
					GalleryListC.style.height = '300px';
					for(var i = 0; i < data.length; i++) {
						var item = document.createElement('div');
						item.className = 'mui-input-row mui-checkbox ui-Gallery-item';
						item.innerHTML = '<span><img src="../images/camera.png" alt="" /></span><span class="ui-Gallery-txt"> ' + data[i].Name + '</span><input name="gallery' + data[i].ID + '" value=' + data[i].ID + ' type="checkbox" class="ui-Gallery-list checkedGalleryList">';
						GalleryList.appendChild(item);
						if(data[i].Status == 0) {
							document.getElementsByClassName("ui-Gallery-list")[i].setAttribute("disabled", 'disabled');
						}
					}
				} else {
					GalleryListC.style.height = 48 * data.length + 'px';
					for(var i = 0; i < data.length; i++) {
						var item = document.createElement('div');
						item.className = 'mui-input-row mui-checkbox ui-Gallery-item';
						item.innerHTML = '<span><img src="../images/camera.png" alt="" /></span><span class="ui-Gallery-txt"> ' + data[i].Name + '</span><input class="ui-Gallery-list checkedGalleryList" name="checkbox2" value=' + data[i].ID + ' type="checkbox" >';
						GalleryList.appendChild(item);
						if(data[i].Status == 0) {
							document.getElementsByClassName("ui-Gallery-list")[i].setAttribute("disabled", 'disabled');
						}
					}
				}
				mui('#VideoGalleryList input').each(function(index, El) {
					El.checked = true;
				});
			}
			/*
			 * 调接口获取初始数据
			 */
			 function initFullCover() {
				SendAjax(LAPI.FullCover, 'get', function(code, data) {
					if(code == 0) {
						$("#NVRFull").removeClass("mui-hidden");
						document.getElementById("FullCoverSwitch").style.zIndex = 20;
						document.getElementById("FullCoverSwitch").style.visibility = "visible";
						FullCoverConfirm = false;
						setSwitchStatus("FullCoverSwitch", data.StoreStrategy ? 0 : 1);
						FullCoverConfirm = true;
						dsBridgeFuncSyn.dismiss();
					} else {
					$("#settings_NVRFullCover").addClass("mui-hidden");
					$("#settings_VideoPlan").addClass("mui-hidden");
					$("#setGallery").addClass("mui-hidden");
						addBitmap(0);
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						dsBridgeFuncSyn.dismiss();
					}
				});
			}

			function FullCoverSwitch(event) {
				if(event.detail.isActive && FullCoverConfirm) {
					var sendDataON = {
						StoreStrategy: 0
					};
					dsBridgeFuncSyn.showLoading();
					SendAjax(LAPI.FullCover, 'put', function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {

						} else {
							showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
							FullCoverConfirm = false;
							setTimeout(function() {
								mui("#FullCoverSwitch").switch().toggle();
							}, 300);
						}
					}, sendDataON);

				} else if(!event.detail.isActive && FullCoverConfirm) {
					var sendDataOFF = {
						StoreStrategy: 1
					};
					dsBridgeFuncSyn.showLoading();
					SendAjax(LAPI.FullCover, 'put', function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {

						} else {
							showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
							FullCoverConfirm = false;
							setTimeout(function() {
								mui("#FullCoverSwitch").switch().toggle();
							}, 300);
						}
					}, sendDataOFF);
				} else {
					FullCoverConfirm = true;
				};
			}
		</script>
	</body>

</html>