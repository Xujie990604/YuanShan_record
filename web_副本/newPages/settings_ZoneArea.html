<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<style>
			html,
			body {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
				color: #ffffff;
				font-size: 15px;
				overflow: hidden;
				background-color: #000000;
			}
			
			ul,
			li {
				margin: 0;
				padding: 0;
				list-style: none;
			}
			
			#drawDiv {
				width: 100%;
				height: 100%;
				box-sizing: border-box;
				overflow: hidden;
				position: absolute;
				left: 0;
				background-color: #000;
			}
			
			#canvas {
				background-size: 100% 100%;
				margin: 0;
				padding: 0;
			}
			
			#drawback {
				position: fixed;
				top: 10px;
				left: 10px;
			}
			
			#drawbtn {
				width: 50px;
				height: 100%;
				position: absolute;
				right: 0;
				top: 0;
				z-index: 800;
			}
			
			#drawbtn button {
				width: 25px;
				height: 25px;
				border: 0px;
				margin-right: 0;
			}
			
			#drawbtn ul {
				width: 100%;
				height: 100%;
				display: flex;
				display: -webkit-flex;
				flex-direction: column;
				-webkit-flex-direction: column;
				justify-content: center;
				-webkit-justify-content: center;
				align-items: center;
				-webkit-align-items: center;
			}
			
			#drawbtn #areabtn {
				background-color: #000000;
			}
			
			#areabtn li {
				margin: 30px 0;
			}
			
			.wapp-side-btn-back {
				background: url('../images/return.png') no-repeat;
				background-size: 100% 100%;
			}
			
			.wapp-side-btn-add {
				background: url('../images/motionDetection0/add_normal.png') no-repeat;
				background-size: 100% 100%;
			}
			
			.wapp-side-btn-del {
				background: url('../images/motionDetection0/delete_normal.png') no-repeat;
				background-size: 100% 100%;
			}
			
			.wapp-side-btn-commit {
				background: url('../images/motionDetection0/checked.png') no-repeat;
				background-size: 100% 100%;
			}
			
			.ui-drawbtn-invisible {
				visibility: hidden;
			}
			
			.canvas-style {
				margin-top: 30px;
				margin-left: 50px;
				margin-right: 50px;
				background: url("../images/no_photo@3x.png") center center no-repeat;
				background-size: 100px 80px;
				background-color: #3D3E41;
			}
			
			button:disabled {
				opacity: 0.35;
			}
			
			#goBack {
				width: 28px!important;
				height: 28px!important;
			}
		</style>
	</head>

	<body>
		<div id="drawDiv">
			<div class="canvas-style" id="canvasStyle" style="display: none">
				<canvas id="canvas" width="" height=""></canvas>
			</div>
			<div id="drawbtn" class="ui-drawbtn-invisible">
				<div id="drawback">
					<button type="button" id="goBack" class="wapp-side-btn-back"></button>
				</div>
				<ul id="areabtn" class="wapp-selected wapp-hide">
					<li><button type="button" id="areaadd" class="wapp-side-btn-add"></button></li>
					<li><button type="button" id="areadel" class="wapp-side-btn-del"></button></li>
					<li><button type="button" id="areacommit" class="wapp-side-btn-commit"></button></li>
				</ul>
			</div>
		</div>
	</body>
	<script src="../js/dsbridge.min.js"></script>
	<script src="../js/common.js"></script>
	<script src="../js/libs/md5.js"></script>
	<script src="../js/libs/jquery-3.4.1.min.js"></script>
	<script src="../js/libs/sha2.js"></script>
	<script src="../js/resource.js"></script>
	<script src="../js/Utils.js"></script>
	<script src="../js/mui.js"></script>
	<!--	<script src="../js/immersed.js"></script>-->
	<!--<script src="../js/customSetting.js"></script>-->
  <script id="langScript"></script>
	<script type="text/javascript">
		var langTip;
		var drawDiv = document.getElementById("drawDiv");
		var areaadd = document.getElementById("areaadd");
		var areadel = document.getElementById("areadel");
		var self;
		var parentW;
		var ZoneGridService;
		var GridService;
		var AreaType; //绘图区域类型：0---区域入侵
		var LapiAreaType;
		//canvas画图相关参数
		var canvas;
		var context;
		var imgSrc = ""; //获取第一帧图返回数据
		var imgTimeout = false; //获取第一帧图是否超10秒
		var initDrawFlag = false; //是否已经完成绘制
		canvas = document.getElementById("canvas");
		context = canvas.getContext("2d");
		//越界和区域绘图的初始化坐标点，当设备侧没有配置绘制区域时，采用该默认坐标值
		var initLinePoints = [{
				'X': 150,
				'Y': 50
			}, {
				'X': 200,
				'Y': 50
			}, {
				'X': 250,
				'Y': 100
			},
			{
				'X': 200,
				'Y': 150
			}, {
				'X': 150,
				'Y': 150
			}, {
				'X': 100,
				'Y': 100
			}
		];
		//越界和区域绘图的坐标点共享数据，越界取前两个，区域取全部的
		var linePoints = [{
				'X': 150,
				'Y': 50
			}, {
				'X': 200,
				'Y': 50
			}, {
				'X': 250,
				'Y': 100
			},
			{
				'X': 200,
				'Y': 150
			}, {
				'X': 150,
				'Y': 150
			}, {
				'X': 100,
				'Y': 100
			}
		];
		//越界和区域绘图共享的配置信息，越界取前四个，区域取全部的
		var lineCfgInfo = {
			'ID': 0,
			'Enabled': 1,
			'Sensitivity': 75,
			'DisplayEnabled': '',
			'TargetSize': 1,
			'PointNum': 4
		};
		//设备侧的数据
		var oriLinePoints = [{
				'X': 0,
				'Y': 0
			}, {
				'X': 0,
				'Y': 0
			}, {
				'X': 0,
				'Y': 0
			},
			{
				'X': 0,
				'Y': 0
			}, {
				'X': 0,
				'Y': 0
			}, {
				'X': 0,
				'Y': 0
			}
		];
		var linePointNum = -1; //最大到0--5，-1为无效点
		checkType(localStorage.AppType); //加载特定样式
		mui.init();
		var typeLan = initLang();
		langTip = typeLan.lang;
		initPage();
		initData();

		function initPage() {
			var Url = "web/newPages/settings_ZoneArea.html";
			var self = dsBridgeFuncSyn.getWebParam(Url);
			self = JSON.parse(self);
			ZoneGridService = JSON.parse(JSON.stringify(self.ZoneGridService));
			GridService = JSON.parse(JSON.stringify(ZoneGridService));
			AreaType = self.AreaType;
			switch(AreaType) {
				case 0:
					LapiAreaType = LAPI.IntrusionDetectionAreas;
					break;
				case 1:
					LapiAreaType = LAPI.AccessZoneAreas;
					break;
				case 2:
					LapiAreaType = LAPI.LeaveZoneAreas;
					break;
				case 3:
					LapiAreaType = LAPI.SmartMotionDetectionAreas;
					break;
				default:
					break;
			}
			if(AreaType != 3) {
			lineCfgInfo.ID = GridService.PolygonInfoList[0].ID;
			lineCfgInfo.Enabled = GridService.PolygonInfoList[0].Enabled;
			lineCfgInfo.Sensitivity = GridService.PolygonInfoList[0].Sensitivity;
			lineCfgInfo.DisplayEnabled = GridService.PolygonInfoList[0].DisplayEnabled;
			lineCfgInfo.TargetSize = GridService.PolygonInfoList[0].TargetSize;
			lineCfgInfo.PointNum = GridService.PolygonInfoList[0].PointNum;
			lineCfgInfo.PointList = GridService.PolygonInfoList[0].PointList ? GridService.PolygonInfoList[0].PointList : [];
			} else {
				lineCfgInfo.Enabled = GridService.RECTAreas[0].Enabled;
				lineCfgInfo.PointNum = GridService.RECTAreas[0].AreaInfoList.PointNum;
				lineCfgInfo.PointList = GridService.RECTAreas[0].AreaInfoList.PointList;
			}
			var enabled = lineCfgInfo.PointList.every(function(item) { // 当获取的数据为空时，lineCfgInfo.Enabled =0，默认图标+为高亮
				return item.X == 0 && item.Y == 0
			})
			if(enabled) {
				lineCfgInfo.Enabled = 0;
			}

		}

		function doTask() {
			drawbtn.classList.remove("ui-drawbtn-invisible");
			canvasWidth = drawDiv.offsetWidth - 50 - 50;
			canvasHeight = drawDiv.offsetHeight - 60;
			if((canvasWidth - canvasHeight) < 100) {
				setTimeout(doTask, 200);
				return;
			}
			canvas.style.width = canvasWidth + 'px';
			canvas.style.height = canvasHeight + 'px';
			document.getElementById("canvasStyle").style.width = canvasWidth + 'px';
			document.getElementById("canvasStyle").style.height = canvasHeight + 'px';
			canvas.width = canvasWidth;
			canvas.height = canvasHeight;
			document.getElementById("canvasStyle").style.display = "block";
			initDrawAreas();
		}

		/**
		 * 数据初始化
		 */
		function initData() {
			//			dsBridgeFuncAsyn.setScreenRotation("1", function() {

			setTimeout(doTask, 500);
			//			});
		}

		/*
		 * 初始化绘图区域
		 */
		function initDrawAreas() {
			dsBridgeFuncSyn.showLoading();
			setTimeout(function() {
				dsBridgeFuncSyn.dismiss();
				if(!initDrawFlag) {
					timeoutDo();
				}
			}, 10000);
			dsBridgeFuncAsyn.getFirstImg(function(path) {
				dsBridgeFuncSyn.dismiss();
				var data = JSON.parse(path);
				if(imgTimeout) return;
				if(data.statusCode == "0") {
					imgSrc = data.param;
					canvas.style.backgroundImage = 'url(' + imgSrc + ')';
				}
				drawbtn.classList.remove("ui-drawbtn-invisible");
				getDrawAreas();
				context.clearRect(0, 0, canvas.width, canvas.height);
				drawIntrusion();
				initDrawFlag = true;
				canvas.addEventListener("touchstart", drawLineEvent, false);
				canvas.addEventListener("touchmove", drawLineEvent, false);
				canvas.addEventListener("touchend", drawLineEvent, false);
			});
			changeAreaBtnStatus(lineCfgInfo.Enabled);
		}

		/**
		 * 获取到设备侧的数据并处理
		 */
		function getDrawAreas() {
			for(var num = 0; num < lineCfgInfo.PointNum; num++) {
				linePoints[num].X = Math.ceil(lineCfgInfo.PointList[num].X * canvas.width / 10000);
				linePoints[num].Y = Math.ceil(lineCfgInfo.PointList[num].Y * canvas.height / 10000);
				oriLinePoints[num].X = linePoints[num].X;
				oriLinePoints[num].Y = linePoints[num].Y;
			}
		}
		//处理越界和区域获取绘图数据
		mui('#areabtn').on('tap', 'button', function() { //6边型
			if(this.id == "areaadd") {
				lineCfgInfo.Enabled = 1;
				lineCfgInfo.PointNum = initLinePoints.length;
				for(var num = 0; num < initLinePoints.length, num < 6; num++) {
					linePoints[num].X = initLinePoints[num].X;
					linePoints[num].Y = initLinePoints[num].Y;
				}
				context.clearRect(0, 0, canvas.width, canvas.height);
			} else if(this.id == "areadel") {
				lineCfgInfo.Enabled = 0;
				for(var num = 0; num < initLinePoints.length, num < 6; num++) {
					linePoints[num].X = 0;
					linePoints[num].Y = 0;
				}
				context.clearRect(0, 0, canvas.width, canvas.height);
			} else if(this.id == "areacommit") {
				saveCommit();
			}
			changeAreaBtnStatus(lineCfgInfo.Enabled);
			drawIntrusion();
		})

		/**
		 * 修改图标状态
		 * @param {Object} isEnable
		 */
		function changeAreaBtnStatus(isEnable) {
			if(isEnable) {
				areaadd.disabled = true;
				areadel.disabled = false;
			} else {
				areaadd.disabled = false;
				areadel.disabled = true;
			}
		}

		/*
		 * 超时绘制图形
		 */
		function timeoutDo() {
			if(imgSrc == "") {
				imgTimeout = true;
				drawbtn.classList.remove("ui-drawbtn-invisible");
				getDrawAreas();
				context.clearRect(0, 0, canvas.width, canvas.height);
				drawIntrusion();
				canvas.addEventListener("touchstart", drawLineEvent, false);
				canvas.addEventListener("touchmove", drawLineEvent, false);
				canvas.addEventListener("touchend", drawLineEvent, false);
			}
		}

		/**
		 * 绘图
		 */
		function drawIntrusion() {
			context.globalAlpha = 1;
			if(lineCfgInfo.Enabled == 0) {
				return;
			}
			context.beginPath();

			if(localStorage.AppType == '1' || localStorage.AppType == '3') { //智U
				context.strokeStyle = "#4FCEBF";
			} else {
				context.strokeStyle = "#4D97E4";
			}
			context.lineWidth = 2;
			context.moveTo(linePoints[0].X, linePoints[0].Y); //6边型，可能三，四，五边型
			for(var i = 0; i < lineCfgInfo.PointNum; i++) {
				context.lineTo(linePoints[i].X, linePoints[i].Y);
			}
			context.lineTo(linePoints[0].X, linePoints[0].Y);
			context.stroke();
			context.restore();
			for(var i = 0; i < lineCfgInfo.PointNum; i++) {
				context.beginPath();
				context.strokeStyle = "black";
				context.arc(linePoints[i].X, linePoints[i].Y, 5, 0, 2 * Math.PI);
				context.fillStyle = "white";
				context.fill();
				context.stroke();
				context.restore();
			}
		}

		/**
		 * canvas绘图相关的函数
		 * @param {Object} event
		 */
		function drawLineEvent(event) {
			var touchPoint = event.touches[0];
			var xPosition = touchPoint.clientX - 50;
			var yPosition = touchPoint.clientY - 30;
			switch(event.type) {
				case "touchstart":
					checkTouchLinePoint(xPosition, yPosition);
					break;
				case "touchmove":
				case "touchend":
					if(xPosition < 5 || 　xPosition > (canvas.width - 5) ||
						yPosition < 5 || 　yPosition > (canvas.height - 5)) {
						return;
					}
					if(linePointNum != -1) {
						linePoints[linePointNum].X = xPosition;
						linePoints[linePointNum].Y = yPosition;
					}
					context.clearRect(0, 0, canvas.width, canvas.height);
					drawIntrusion();
					break;
			}
		}

		function checkTouchLinePoint(X, Y) {
			if((Math.abs(X - linePoints[0].X) < 20) && (Math.abs(Y - linePoints[0].Y) < 20)) {
				linePointNum = 0;
			} else if((Math.abs(X - linePoints[1].X) < 20) && (Math.abs(Y - linePoints[1].Y) < 20)) {
				linePointNum = 1;
			} else if((Math.abs(X - linePoints[2].X) < 20) && (Math.abs(Y - linePoints[2].Y) < 20)) {
				linePointNum = 2;
			} else if((Math.abs(X - linePoints[3].X) < 20) && (Math.abs(Y - linePoints[3].Y) < 20)) {
				linePointNum = 3;
			} else if((Math.abs(X - linePoints[4].X) < 20) && (Math.abs(Y - linePoints[4].Y) < 20)) {
				linePointNum = 4;
			} else if((Math.abs(X - linePoints[5].X) < 20) && (Math.abs(Y - linePoints[5].Y) < 20)) {
				linePointNum = 5;
			} else {
				linePointNum = -1;
			}
		}

		/**
		 * 绘图保存
		 */
		function saveCommit() {
			var sendPoint = [];
			for(var i = 0; i < lineCfgInfo.PointNum; i++) {
				var point = {
					X: 0,
					Y: 0
				};
				point.X = Math.floor(linePoints[i].X * 10000 / canvas.width) == 10000 ? 9999 : Math.floor(linePoints[i].X * 10000 / canvas.width);
				point.Y = Math.floor(linePoints[i].Y * 10000 / canvas.height) == 10000 ? 9999 : Math.floor(linePoints[i].Y * 10000 / canvas.height);
				sendPoint.push(point);
			}
			if(AreaType == 3) {
				GridService.RECTAreas[0].Enabled = lineCfgInfo.Enabled;
				GridService.RECTAreas[0].AreaInfoList.PointNum = lineCfgInfo.PointNum;
				GridService.RECTAreas[0].AreaInfoList.PointList = sendPoint;
			} else {
			GridService.PolygonInfoList[0].Enabled = lineCfgInfo.Enabled;
			GridService.PolygonInfoList[0].PointNum = lineCfgInfo.PointNum;
			GridService.PolygonInfoList[0].PointList = sendPoint;
			}
			dsBridgeFuncSyn.showLoading();
			SendAjax(LapiAreaType, 'put', function(code, data) {
				dsBridgeFuncSyn.dismiss();
				if(code == 0) {
					for(var j = 0; j < lineCfgInfo.PointNum; j++) {
						oriLinePoints[j].X = linePoints[j].X;
						oriLinePoints[j].Y = linePoints[j].Y;
					}
					var param = {
						Grid_Bak: GridService
					}
					dsBridgeFuncSyn.sendDataToReport("updateGrid", JSON.stringify(param));
					drawbtn.classList.add("ui-drawbtn-invisible");
					dsBridgeFuncAsyn.setScreenRotation("0", function() {
						showToast(langTip["WEB_logcat_save_successful"]);
						dsBridgeFuncSyn.backTo();
					});
				} else {
					showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
				}
			}, GridService);
		}

		//绘图相关工具条，按钮
		mui('#drawback').on('tap', 'button', function() {
			if(this.id == "goBack") {
				if(JSON.stringify(linePoints.slice(0, lineCfgInfo.PointNum)) ===
					JSON.stringify(oriLinePoints.slice(0, lineCfgInfo.PointNum))) {
					dsBridgeFuncAsyn.setScreenRotation("0", function() {
						dsBridgeFuncSyn.backTo();
					});
				} else {
					var btnArray = [langTip["WEB_cancel"], langTip["WEB_password_confirm_modify"]];
					var str = langTip["WEB_confirm_save"];
					if(str.indexOf("?") != -1) {
						str = str.substr(0, str.indexOf("?") + 1);
					}
					mui.confirm(str, langTip["WEB_dialog_title_notify"], btnArray, function(e) {
						if(e.index == 1) {
							saveCommit();
						} else {
							dsBridgeFuncAsyn.setScreenRotation("0", function() {
								drawbtn.classList.add("ui-drawbtn-invisible");
								dsBridgeFuncSyn.backTo();
							});
						}
					}, 'div');
				}
			}
		});
	</script>

</html>