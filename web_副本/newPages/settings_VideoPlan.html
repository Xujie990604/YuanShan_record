<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<link href="../css/theme_normal.css" rel="stylesheet" />
		<style>
			#VideoType .mui-radio input[type='radio']:checked:before {
				content: '\e442';
			}
			.mui-popover .mui-scroll-wrapper {
				margin: 1px 0;
			}
			/*智U*/
			
			.mui-table-view-cell .ui-tip {
				position: absolute;
				right: 5px;
				top: 20px;
				z-index: 100;
			}
			
			.mui-badge {
				background-color: rgba(0, 0, 0, 0);
			}
			
			.ui-dateok {
				border: none;
			}
			
			.mui-radio.mui-left label {
				padding-left: 35px;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				width: 114px;
				font-size: 14px;
			}
			#footBtn input[value='1']:checked:before {
				color: #8cb9fb !important;
			}
			#footBtn input[value='2']:checked:before {
				color: #FF8D7F !important;
			}
			#footBtn input[value='1']:before {
				color: #8cb9fb !important;
				font-weight: 700;
			}
			#footBtn input[value='2']:before {
				color: #FF8D7F !important;
				font-weight: 700;
			}

			.mui-radio.mui-left input[type='radio']{
				left: 5px;
			}
			.mui-input-row label {
				padding: 13px 13px;
			}
			.mui-radio input[type='radio'] {
				top: 9px;
			}

			.canvas-style{
				height: 100%;
             /* margin-left: 30px; */
			 /* margin-top: 10px; */
			}
		    .date-title{
				display: flex;
				/* width: 100%; */
				height: 30px;
				line-height: 30px;
				background-color: #fff;
				font-size: 14px;
				justify-content: space-around;
				padding-left: 60px;
				padding-right: 12px;
				margin-bottom: 12px;
                opacity: 0.6;
				color: rgba(51,51,51,0.4);
			}
			.btn{
				position: absolute;
		
                width: 100%; 
				height: 45px;
				padding:0px 5px;
				background-color: #fff;
				opacity: 0.6;
        
			}


			.common-left{
                margin-left: -15px;
			}
			.commonBtn{
             display: inline-block;
			 width: 56px;
			 height: 45px;
			 line-height: 45px;
			 margin-right: 10px;
			 white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			}

			.selectedbtn{
				display: inline-block;
			}
			.common-right{
				float: right;
				display: flex;
				justify-content: space-between;
			}

		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_device_manager_record_schedule">&nbsp;</h1>
			<a id="save" class="mui-icon iconfont icon-save mui-pull-right"></a>
		</header>
		<div class="mui-content" id="content">
			<div class="date-title" id="dateTitle">
                 <span class="date" data-text="WEB_SUN"></span>
				 <span class="date" data-text="WEB_Mon"></span>
				 <span class="date" data-text="WEB_Tue"></span>
				 <span class="date" data-text="WEB_Wed"></span>
				 <span class="date" data-text="WEB_Thu"></span>
				 <span class="date" data-text="WEB_Fri"></span>
				 <span class="date" data-text="WEB_Sat"></span>
			</div>
			<div class="canvas-style" id="drawDiv">
				<!-- <div id="canvasBox" style="display: none"><canvas id="canvas" width="" height=""></canvas></div> -->
				<canvas id="canvas" width="" height=""></canvas>
			</div>
			<div class="btn mui-hidden" id="footBtn">
				<div class="mui-input-row mui-radio mui-left selectedbtn mui-hidden" id="leftBtn1">
					<label data-text="WEB_ScheduledRecording"></label>
					<input name="radio1" type="radio" value="1" checked>
				</div> 
				<div class="mui-input-row mui-radio mui-left selectedbtn common-left mui-hidden" id="leftBtn2">
					<label data-text="WEB_EventRecording"></label>
					<input name="radio1" type="radio" value="2">
				</div> 
				<div class="common-right">
					<div class="commonBtn" id ='selectedAll' data-text="WEB_select_all"></div>
					<div class="commonBtn" id="clearAll" data-text="WEB_web_drawarea_clear"></div>
				</div>

			</div>
		</div>

		<!--录像类型弹框-->
		<div id="VideoType" class="mui-popover mui-popover-action mui-popover-bottom ui-radio-list">
			<form class="mui-input-group">
				<div class="mui-input-row mui-checkbox ui-list-titile" id="swipedownDiv2">
					<label data-text="WEB_record_type">&nbsp;</label>
				</div>
				<div id="VideoTypeList" class="VideoTypeList">
					<div class="mui-input-row mui-radio">
						<label data-text="WEB_ScheduledRecording"></label>
						<input name="radio2" value="0" type="radio">
					</div>
					<div class="mui-input-row mui-radio " id="motionDetection">
						<label data-text="WEB_EventRecording"></label>
						<input name="radio2" value="3" type="radio">
					</div>
				</div>
			</form>
			<button id="VideoTypeOk" class="mui-btn mui-btn-block ui-dateok" data-text="WEB_button_ok">&nbsp;</button>
		</div>


		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/libs/sha2.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/loadCss.js"></script>
    <script id="langScript"></script>
		<script>
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;

			var startX = 0;
			var startY = 0;
			var handStartX = 8;
			var handStartY = 6;
			var GridIsEmpty = true;
            var configType = 'motion'
			//canvas画图相关参数
			var canvas;
			var context;
			// var context;
			var ratio; //缩放倍数
			//动检配置相关的数据
			var bgcolor = "#8cb9fb"
			var map_mo = [];
			var widthN =7; //宽轴网格数
			var heightN = 24; //竖轴网格数
			var canvasWidth;
			var startFlag;
			var canvasHeight;
			var tempx = 0;
			var sendUrl;
			var tempy = 0;
			var splitNum = 4;
			// dsBridgeFuncSyn.dismiss();
			var lenW; //单元格宽度
			var lenH; //单元格高度
			var area_mo = []; //存储画图对象
			var str_mo = [
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,],
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,],
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,],
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,],
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,],
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,],
			[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,],
		    ]; 

			var rows =
			 [
			 '00:00','01:00','02:00','03:00','04:00','05:00','06:00',
			 '07:00','08:00','09:00','10:00','11:00','12:00','13:00',
			 '14:00','15:00','16:00','17:00','18:00','19:00','20:00',
			 '21:00','22:00','23:00','24:00'
			];//坐标
			var btnArray;
			var isAuto = true;
			//八位数组组成的字符串
			//canvas画图相关参数
			// var canvasBox = document.getElementById("canvasBox");
			drawDiv = document.getElementById("drawDiv");
			canvas = document.getElementById("canvas");
			context = canvas.getContext("2d");
			ratio = getPixelRatio(context);
			// 数据
			var timeSectionInfos = [{
				Begin: "00:00:00",
				End: "24:00:00",
				ArmingType: 5
			}];
			var saveData;// 存储录像计划数据
			var sendData = {
				Enabled: 1,
				IsRedundantStorage: 0,
				RecordRule: {
					PreRecordTime: 10,
					PostRecordTime: 60
				},
				WeekPlan: {
					Days: [],
					Num: 7
				}
			};
			var offsetHeight // 顶部偏移量
			var copyTimeList
			var flag = false; // 是否弹出弹窗
			var saveDays =[]
			var channelID = [];
			var disabledID = [];
			var copyDate = []; // 下发失败，还原数据
			var VocationDayPlanInfo =[];// 通道的第八天录像数据
			var coverObjs;
			var editionFlag;
			checkType(localStorage.AppType); //加载特定样式
			
			setTimeout(function(){
				initPage();
			},500)
			
			initEvent();

			
			dsBridgeFuncSyn.dismiss();
			
			function initPage() {
				//根据设备版本号判断是否支持SD卡新接口
				var devVersionNumberList = ["GIHOS-B2101.2.3.220905", "GIHOS-B2101.2.2.220810", "GIHOS-B2101.2.1.220802", "GIHOS-B2101.2.0.220713", "GIHOS-B2101.1.5.220712"];
				if(devVersionNumberList.indexOf(localStorage.versionNumber) == -1) {
					if(localStorage.sdkVer && (localStorage.versionNumber.indexOf("CIPC-B2303") == -1)) {
						if(judgeSDkVersion("1.9.0")) {
							editionFlag = true;
						}
					}
				}
				if(editionFlag) {
					sendUrl = LAPI.StoreStrategy;
				} else {
					sendUrl = LAPI.Storage;
				}


				dsBridgeFuncSyn.showLoading();
				var Url = "web/newPages/settings_VideoPlan.html";
				if(localStorage.deviceType == '0') {
				var self = dsBridgeFuncSyn.getWebParam(Url);
				self = JSON.parse(self);
				isAuto = self.isAuto;
				coverObjs = self.coverObjs;

				if(editionFlag) {
					if(coverObjs.RecordStrategy.StoreEnabled == 0) {
						coverObjs.RecordStrategy.StoreEnabled = 1;
					}
				} else {
					if(coverObjs.VideoStorage.StorageMode == 10 && sportcheck == 0) {
					    coverObjs.VideoStorage.StorageMode = 11;
					}

					}
				} else  {
					splitNum = 8;
					$("#leftBtn1").removeClass("mui-hidden");
					$("#leftBtn2").removeClass("mui-hidden");
					if(localStorage.deviceType == '1' && localStorage.channelId == "0"){
						var self = dsBridgeFuncSyn.getWebParam(Url);
						self = JSON.parse(self);
						channelID = self.channelID
						disabledID = self.disabledID
					}
				}

				btnArray = [langTip["WEB_cancel"], langTip["WEB_button_ok"]];
                offsetHeight = $('#drawDiv').offset().top
				canvasWidth = drawDiv.offsetWidth - 10;// 减去右边距
				canvasHeight = document.documentElement.clientHeight - offsetHeight -50; //  减去上下边距

				canvas.style.width = canvasWidth + 'px';
				canvas.style.height = canvasHeight + 'px';
				
				canvas.width = canvasWidth * ratio;
				canvas.height = canvasHeight * ratio;
				lenW = Math.floor(((canvasWidth-60) / widthN) * ratio); //单元格宽度
				lenH = Math.floor(((canvasHeight-20) / heightN) * ratio); //单元格高度
				$("#footBtn").removeClass("mui-hidden");
				// 清空画布
				context.clearRect(0, 0, canvas.width, canvas.height);
				// 重绘
				drawObj();
				// getRecordInfo();

				initData();
			}
        

			function initEvent() {
				
				// canvas.addEventListener("click", onClickEvent, false);
				canvas.addEventListener("touchstart", drawLineEvent, false);
				canvas.addEventListener("touchmove", drawLineEvent, false);
				canvas.addEventListener("touchend", drawLineEvent, false);
				document.getElementById('save').addEventListener('tap', save);
									// 录像类型确定按钮
				document.getElementById('VideoTypeOk').addEventListener('tap', function() {
					mui('#VideoType').popover('toggle');
					var typeAlls = document.querySelectorAll('#VideoTypeList input');
					for(var i = 0; i < typeAlls.length; i++) {
						if(typeAlls[i].checked) {
						  if(Number(typeAlls[i].value) ==0) {
							  // 计划录像全选
							saveDays = selectedAll(1,0)
							initReactData(1)
							 } else{
							  // 报警录像全选
							saveDays = selectedAll(1,10)
							initReactData(2)
							 }
                 			//清空画布
							context.clearRect(0, 0, canvas.width, canvas.height);
							//重绘
							drawObj();
							getRecordInfo()
						 }

					 }
					 
				  }, false);

					// 切换颜色
					mui('.btn .mui-input-row').on('change', 'input', function() {
						if(this.value == 1 ){
							bgcolor = '#8cb9fb'
						}else{
							bgcolor = '#FF8D7F'
						}
					});

					$("#selectedAll").on('tap',function(){
						if(localStorage.deviceType !='0') {
							mui('#VideoType').popover('toggle')
						} else {
							// IPC 全选事件
							saveDays =selectedAll(1);
							initReactData(1)
							//清空画布
							context.clearRect(0, 0, canvas.width, canvas.height);
							//重绘
							drawObj();
							getRecordInfo()
						  
						}

					})
					$("#clearAll").on('tap',function(){
						mui.confirm(langTip["WEB_ClearPlan"], langTip["WEB_dialog_title_notify"], btnArray, function(e) {
							if(e.index == 1) {
								saveDays = selectedAll(0);
								//清空画布
								initReactData(0)
								context.clearRect(0, 0, canvas.width, canvas.height);
								//重绘
								drawObj();
								getRecordInfo()
							  }
						}, 'div');

					})
			  }

			function initData() {
				switch(localStorage.deviceType) {
					case "0":
					// if(!isAuto){
                    //       // []手动告警默认选择所有时间
					// 	  saveDays = selectedAll(1)
							
					// } else{
					// 	initPlanCheck();

					// }

					initPlanCheck();
						break;
					case "1":
						if(localStorage.channelId == "0") {
							// getChannelDetailInfos();
							dsBridgeFuncSyn.dismiss();
							saveDays = initNVRData();
							sendData.WeekPlan.Days = deepCopy (saveDays);
						} else {
							initPlanCheck()
						}
						break;
				}
			}
          function  initReactData(value) {
			for (var k = 0; k < 7; k++) {
				for (var j = 0; j < 24; j++) {
					str_mo[k][j] = value
					
				}
			}	
		  }

            
			function initNVRData() {
				var Days = []
				for(var i = 0; i < 7; i++) {
					dayPlanInfo = {
						ID: i+1,
						Num:0
						
					};
					Days.push(dayPlanInfo);
				}
				return Days
				
			}
			function selectedAll(type,planType) {
				var Days = []
				if(localStorage.deviceType == '0') {
					for(var i = 0; i < 7; i++) {
					 if(type) {
						var dayPlanInfo = {
							ID: i == 0 ? 7:i,
							Num: 4,
							TimeSectionInfos:[{
								Begin: "00:00:00",
								End: "23:59:59",
							},
							{
								Begin: "24:00:00",
								End: "24:00:00",
							},
							{
								Begin: "24:00:00",
								End: "24:00:00",
							},
							{
								Begin: "24:00:00",
								End: "24:00:00",
							}]
						 }
							
					  } else {
						var dayPlanInfo = {
							ID: i == 0 ? 7:i,
							Num: 4,
							TimeSectionInfos:[{
								Begin: "24:00:00",
								End: "24:00:00",
							},
							{
								Begin: "24:00:00",
								End: "24:00:00",
							},
							{
								Begin: "24:00:00",
								End: "24:00:00",
							},
							{
								Begin: "24:00:00",
								End: "24:00:00",
							}]
						}
					  }

					Days.push(dayPlanInfo);
			    }
			 } else {
				for(var i = 0; i < 7; i++) {
					 if(type) {
						   var dayPlanInfo = {
							ID: i+1,
							Num: 1,
							TimeSectionInfos:[{
								Begin: "00:00:00",
								End: "24:00:00",
								ArmingType: planType
							}]
						 }
							
					  } else {
						var dayPlanInfo = {
							ID: i+1,
							Num: 0
						 }
					  }
					   Days.push(dayPlanInfo);
			      }
				  if(localStorage.channelId!='0') {
					Days.push(VocationDayPlanInfo)
				  }
			 }

				return Days
				
			}
			function drawObj() {
				// var x = (area_mo[i].x) * lenW + 60*ratio;
				// var y = (area_mo[i].y) * lenH + 5*ratio;
				area_mo = [];
				for(var i = 0; i < heightN; i++) {
					for(var j = 0; j < widthN; j++) {
						var gridObj = {
							x: j,
							y: i,
							show: str_mo[j][i],
						}
						area_mo.push(gridObj);
					}
				}

				
				var font_size = 12 * ratio;
				context.font = font_size + "px simhei";
				context.fillStyle = '#333333';// 填充色
				context.globalAlpha = 0.4; //透明度
				for(var i=0;i<25;i++){
					context.fillText(rows[i],15*ratio,lenH*i+10*ratio);//绘制纵坐标
				}
				for(var i = 0; i < area_mo.length; i++) {
					var text_width = context.measureText(area_mo[i].y).width;
					var text_height = context.measureText(area_mo[i].y).actualBoundingBoxAscent
					 + context.measureText(area_mo[i].y).actualBoundingBoxDescent;
					// 	var text_height = text_width;
					// 	if(area_mo[i].y>=10){
					// 		text_height = text_width/2
					// 	}
					var x = (area_mo[i].x) * lenW + 60*ratio;
					var y = (area_mo[i].y) * lenH + 5*ratio;
					
					context.fillStyle = '#8cB9FB';// 矩形填充色
                   
					    context.lineWidth = 0.5 * ratio;// 矩形线宽
						context.strokeStyle = '#333333'; // 矩形颜色
						context.globalAlpha = 0.15; //矩形边框透明度
						context.strokeRect(x, y, lenW, lenH);

						context.fillStyle = '#333' // 数字颜色
						context.globalAlpha = 0.4; //数字颜色透明度
						// context.fillText(area_mo[i].y,x+lenW/2-text_width/2,y+lenH/2-text_height/2);
						context.fillText(area_mo[i].y,x+lenW/2-text_width/2,y+lenH/2+text_height/2);
					
				}

			}
			function getPixelRatio(context) {
				var backingStore = context.backingStorePixelRatio ||
					context.webkitBackingStorePixelRatio ||
					context.mozBackingStorePixelRatio ||
					context.msBackingStorePixelRatio ||
					context.oBackingStorePixelRatio ||
					context.backingStorePixelRatio || 1;
				return(window.devicePixelRatio || 1) / backingStore;
			}

			/**
			 * 绘制数字
			 */
			function text(l,x,y) {
				context.fillStyle = '#fff' // 数字颜色
				context.globalAlpha = 1; //数字颜色透明度
				var text_width = context.measureText(l).width;
				var text_height = context.measureText(l).actualBoundingBoxAscent
					 + context.measureText(l).actualBoundingBoxDescent;
				context.fillText(l,x+lenW/2-text_width/2,y+lenH/2+text_height/2); // 写数字
			}
			/**
			 * 绘制纵坐标
			 */
			 function drawNum() {
				var font_size = 12 * ratio;
				context.font = font_size + "px simhei";
				context.fillStyle = '#333333';// 填充色
				context.globalAlpha = 0.4; //透明度
				for(var i=0;i<25;i++){
					context.fillText(rows[i],15*ratio,lenH*i+10*ratio);//绘制纵坐标
				}
			}


			/**
			 * 点击事件处理函数
			 * @param {Object} event
			 */
			//  function onClickEvent(event) {
			// 	if(configType == "motion") {
			// 		moClick(event);
			// 	}
			// }

			/**
			 * 单元格点击
			 * @param {Object} event
			 */
			// function moClick(event) {
			// 	var xPosition = event.clientX - 60;
			// 	var yPosition = event.clientY - 95;
			// 	var x1 = xPosition * ratio;
			// 	var y1 = yPosition * ratio;
			// 	if(xPosition>=0&&yPosition>=0) {
			// 	var x = Math.floor(x1 / lenW);
			// 	var y = Math.floor(y1 / lenH);
			// 	if(x>=0&&x<=6&& y>=0&&y<=23) {
			// 	str_mo[x][y] = str_mo[x][y] == 0 ? 1: 0
			// 	// console.log(str_pr[x][y],'www');
			// 	// str_pr[x][y] = 1
			// 		//清空
			// 	context.clearRect(0, 0, canvas.width, canvas.height);
			// 	//重画
				
			// 	drawObj();
			// 	}
				
			// 	}

			// }

			/**
			 * canvas绘图相关的函数
			 * @param {Object} event
			 */
			 function drawLineEvent(event) {	
				if (event.cancelable) {
					event.preventDefault();
				}
				var touchPoint = event.changedTouches[0];
				var xPosition = touchPoint.pageX - 60;
				var yPosition = touchPoint.pageY - offsetHeight - 5;
				//canvas.width-1 减一个像素兼容ios
				if(xPosition < 0 || xPosition > canvas.width - 1 ||
					yPosition < 0 || yPosition > canvas.height) {
					return;
				}
				var x1 = xPosition * ratio;
				var y1 = yPosition * ratio;
				var x = Math.floor(x1 / lenW);
				var y = Math.floor(y1 / lenH);
				switch(event.type) {
					
					case "touchstart":
					tempx = x;
					tempy = y;
					drawRect(x,y);
					break;
					case "touchmove":
					case "touchend":
					if(configType == "motion" &&(tempx !=x||tempy!=y)&&(x<=6&&y<=23)) {
						drawRect(x,y);
						tempx =x
						tempy=y
					}
						break;
				}
			}


			 function transTime(time) {
				var timeList = time.split(':')
				var hour = Number(timeList[0]);
				var minute = Number(timeList[1]);
				var second = Number(timeList[2])
                return hour*60*60 + minute*60 + second;
			}
            function formatTime (x) {
				  var time	
					if(x<10) {
					   time = '0'+x+':00:00'
					} else{
					   time = x+':00:00'
					  if(localStorage.deviceType == '0' && x ==24) {
						time = '23:59:59'
					  }
					}
					return time;
			  }
            function compareTime(str1, str2){

				var str1Time = transTime(str1);
				var str2Time = transTime(str2);
				return str2Time >= str1Time 

			}

			function compareTime1(str1, str2){

			var str1Time = transTime(str1);
			var str2Time = transTime(str2);
			return str2Time > str1Time 

			}
            
			function judgeTime(time1, time2){
				var type1 = compareTime(time1.End,time2.Begin);
				var type2 = compareTime(time1.End,time2.End);
				var type3 = compareTime(time1.Begin,time2.Begin);
				var type4 = compareTime(time1.Begin,time2.End);
				var type5 = compareTime(time2.Begin,time1.End);
				var type6 = compareTime(time2.Begin,time1.Begin);
				var type7 = compareTime(time2.End,time1.End);
                if(type1) {
					return 1;
				}

                if(type5 && type3) {
					return 2;
				}
				
                if(type2&& type6) {
					return 3;
				}
				if(!type2&& !type6) {
					return 4;
				}

                if(type7 && type4) {
					return 5;
				}
                if(!type4) {
					return 6;
				}
				
			}

           function delEmptyTime(timeList) {
			for (var k = 0; k < timeList.length; k++) {
				  if(localStorage.deviceType=='0') {
					 if(timeList[k].Begin=='24:00:00'||timeList[k].End=='24:00:00') {
						timeList.splice(k,1);
					   }	
				   }else{
					  if(timeList[k].Begin=='24:00:00' && timeList[k].End=='24:00:00') {
						timeList.splice(k,1);
					   }	
				   }
				}
			}


			function delTime(timeList, time) {
				delEmptyTime(timeList) 
				
                for (var i = 0; i < timeList.length; i++) {
					var result = judgeTime (time,timeList[i])
					 if(result == 3 ||result == 2) {
						var timeEnd = timeList[i].End
						 timeList[i].End = time.Begin
						 // 处理清除时间事件
						 
						var time1 =  {
							Begin:time.End,
							End:timeEnd
						 }
						if(localStorage.deviceType !='0') {
							time1.ArmingType = bgcolor =='#8cb9fb' ? 0:10
						}
						 timeList.splice(i+1,0,time1)
						
                         break;

					 }
				  }

			 }


			function adDelTime(timeList, time) {
                for (var i = 0; i < timeList.length; i++) {
					var result = judgeTime (time,timeList[i])
					 if(result == 3 ||result == 2) {

						 // 处理清除时间事件
				    var timeEnd = timeList[i].End // 保存原数据
				     timeList[i].End = time.Begin
					      
						var time1 =  {
							Begin:time.End,
							End:timeEnd,
							ArmingType : timeList[i].ArmingType
						 }
						 timeList.splice(i+1,0,time);
						 timeList.splice(i+2,0,time1);
						
                         break;

					 }
				  }

			 }
			function addTime(timeList, time ,index) {
				delEmptyTime(timeList)
				var test = deepCopy(timeList)
				if(timeList.length>0) {
					// var st = judgeTime (start,timeList[i].start) 
					// var se = judgeTime (start,timeInfo[i].end) 
                    var result = judgeTime (time,timeList[index])
					if(result == 1) {
                        // timeList.unshift(time)
						timeList.splice(index,0,time)
						
					}
					if(result == 2){
						if (timeList[index].ArmingType == time.ArmingType) {
							timeList[index].Begin = time.Begin
							if(compareTime1(timeList[index].End,time.End)){
								timeList[index].End = time.End
							}
						} else {
							timeList.splice(index,0,time)
							timeList[index + 1].Begin = time.End
						}
						
					}

					if(result == 4){
						timeList[index].Begin = time.Begin
						timeList[index].End = time.End
						if(localStorage.deviceType!='0') {
							timeList[index].ArmingType = time.ArmingType
						}

					}
					if(result == 5){
						if (timeList[index].ArmingType == time.ArmingType) {
						    timeList[index].End = time.End
						} else {
							timeList[index].End = time.Begin
							timeList.splice(index + 1,0,time)
						}
					}
					// timeInfo[i].Begin = time.Begin
					if(result == 6){
						if(index == timeList.length-1) {
							// timeList.splice(index,0,time)
							timeList.push(time)
						} else{
							index += 1
							addTime(timeList,time,index)
						}

					}
				} else{
					timeList.push(time)
				}
			}

			function clearTime(timeList) {
			  for (var o = 0; o < timeList.length; o++) {
				if(!compareTime1(timeList[o].Begin,timeList[o].End)) {
					timeList.splice(o,1);
				}
			  }
              for (var i = 0; i < timeList.length-1; i++) {

				// const element = array[i];
				var compare1 = compareTime(timeList[i+1].Begin,timeList[i].End);
                var isSame = localStorage.deepCopy!='0' && timeList[i].ArmingType==timeList[i+1].ArmingType
				var unSame = localStorage.deepCopy!='0' && timeList[i].ArmingType!=timeList[i+1].ArmingType
				if(compare1 && isSame){
					if(compareTime(timeList[i].End,timeList[i+1].End)) {
						timeList[i].End = timeList[i+1].End ;  
					} 
					timeList.splice(i+1,1);
					clearTime(timeList)
				} else if(compare1&& unSame) {
					if(compareTime1(timeList[i].End,timeList[i+1].End)) {
						timeList[i+1].Begin = timeList[i].End ;
					} else{
						timeList.splice(i+1,1);
						clearTime(timeList)
					}
				}
				
			  }
			}
            
			function chuliTime (timeList) {
				var length = timeList.length;
				if(length>splitNum) {
					if(splitNum == 4){
						showToast(langTip["WEB_selrctTip1"]);
					} else {
						showToast(langTip["WEB_selrctTip2"]);
					}
					timeList = deepCopy (copyTimeList);
			
				} else if(length<splitNum) {
				  for (var j = length; j < splitNum; j++) {
					var time ={
						Begin :'24:00:00',
						End :'24:00:00'
					}
					if(localStorage.deviceType!='0'){
						time.ArmingType = bgcolor =='#8cb9fb' ? 0:10
					}
					timeList.push(time)
				 }
				 copyTimeList = deepCopy (timeList)
			  }
			  return timeList;
				
		    }

            /**
			 * 绘制矩形框内单元格
			 * @param {Object} event
			 */

			function drawRect(x,y) {
				if(x > widthN - 1) {
					return
				}
				if(y > heightN - 1) {
					return
				 }
                
				 var timeInfo1	
					if(localStorage.deviceType != '0') {
						if(x == 0) {
							timeInfo1  =  saveDays[6].TimeSectionInfos || []; 
							saveDays[6].Num = 8;
						} else {
							timeInfo1  =  saveDays[x-1].TimeSectionInfos || [];
							saveDays[x-1].Num = 8;
						} 

					} else{
						timeInfo1  =  saveDays[x].TimeSectionInfos || []; 
						saveDays[x].Num = 4;
					}
					// timeInfo1.Num = 8;
					// var 
					copyTimeList = deepCopy (timeInfo1);
					var Begin = formatTime(y);
					var End = formatTime(y+1);
					
					var time = {
					Begin,
					End
					}

                        // = 蓝色
				 if(bgcolor =='#8cb9fb') {
					if(localStorage.deviceType !='0') {
						time.ArmingType = 0
					}
					if(str_mo[x][y] == 1 ) {

                        // todo:添加删除逻辑
                        
						delTime (timeInfo1,time);
						clearTime(timeInfo1)
						if(localStorage.deviceType != '0') {
							if(x == 0) {
								saveDays[6].TimeSectionInfos = chuliTime(timeInfo1); 
							} else {
								saveDays[x-1].TimeSectionInfos = chuliTime(timeInfo1);
							} 

						} else{
							saveDays[x].TimeSectionInfos =  chuliTime(timeInfo1) ; 
						}

						// saveDays[x].TimeSectionInfos = chuliTime(timeInfo1);
						
						str_mo[x][y] = 0
					} else if (str_mo[x][y] == 2) {
						// // todo:添加选择和删除逻辑
						adDelTime (timeInfo1,time,0);
						clearTime(timeInfo1)
						if(localStorage.deviceType != '0') {
							if(x == 0) {
								saveDays[6].TimeSectionInfos = chuliTime(timeInfo1); 
							} else {
								saveDays[x-1].TimeSectionInfos = chuliTime(timeInfo1);
							} 

						} else{
							saveDays[x].TimeSectionInfos = chuliTime(timeInfo1) ; 
						}
						str_mo[x][y] = 1;
					} else {
						// // todo:添加选择逻辑
						addTime (timeInfo1,time,0);
						clearTime(timeInfo1)
						// saveDays[x].TimeSectionInfos = chuliTime(timeInfo1);
						if(localStorage.deviceType != '0') {
							if(x == 0) {
								saveDays[6].TimeSectionInfos = chuliTime(timeInfo1); 
							} else {
								saveDays[x-1].TimeSectionInfos = chuliTime(timeInfo1);
							} 

						} else{
							saveDays[x].TimeSectionInfos = chuliTime(timeInfo1) ; 
						}
						str_mo[x][y] = 1;
					}
				 } else {

					if(localStorage.deviceType !='0') {
						time.ArmingType = 10
					}
					if(str_mo[x][y] == 1 ) {
						adDelTime (timeInfo1,time,0);
						clearTime(timeInfo1)
						if(localStorage.deviceType != '0') {
							if(x == 0) {
								saveDays[6].TimeSectionInfos = chuliTime(timeInfo1); 
							} else {
								saveDays[x-1].TimeSectionInfos = chuliTime(timeInfo1);
							} 

						} else{
							saveDays[x].TimeSectionInfos = chuliTime(timeInfo1) ; 
						}

						str_mo[x][y] = 2
					} else if (str_mo[x][y] == 2) {
						delTime (timeInfo1,time,0);
						clearTime(timeInfo1)
						if(localStorage.deviceType != '0') {
							if(x == 0) {
								saveDays[6].TimeSectionInfos = chuliTime(timeInfo1); 
							} else {
								saveDays[x-1].TimeSectionInfos = chuliTime(timeInfo1);
							} 

						} else{
							saveDays[x].TimeSectionInfos = chuliTime(timeInfo1) ; 
						}
			
						str_mo[x][y] = 0;
					} else {
						// // todo:添加选择逻辑
						addTime (timeInfo1,time,0);
						clearTime(timeInfo1)
						// saveDays[x].TimeSectionInfos = chuliTime(timeInfo1);
						if(localStorage.deviceType != '0') {
							if(x == 0) {
								saveDays[6].TimeSectionInfos = chuliTime(timeInfo1); 
							} else {
								saveDays[x-1].TimeSectionInfos = chuliTime(timeInfo1);
							} 

						} else{
							saveDays[x].TimeSectionInfos = chuliTime(timeInfo1) ; 
						}
						str_mo[x][y] = 2;
					}


					
				 }
				 
				//清空
				context.clearRect(0, 0, canvas.width, canvas.height);
				//重画
				drawObj();
				getRecordInfo()
			}
             

			// }
			/*
			 * 发请求获取数据初始化
			 */


			function initPlanCheck() {
				SendAjax(LAPI.RecordScheduleInfo, 'get', function(code, data) {
					if(code == 0) {
						// CheckTimeServiceData = deepCopy(data);
						saveData = deepCopy(data); 
						sendData = deepCopy(saveData);// 用于下发
						saveDays = deepCopy(data.WeekPlan.Days) // 录像计划源数据

						if(!isAuto){
                          // []手动告警默认选择所有时间
						  saveDays = selectedAll(1)
						  initReactData(1)
						} 
						getRecordInfo();
						dsBridgeFuncSyn.dismiss();
					} else {
						//数据获取失败的处理
						 $("#dateTitle").addClass("mui-hidden");
						 $("#drawDiv").addClass("mui-hidden");
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						addBitmap(0);
						flag = true;
						dsBridgeFuncSyn.dismiss();
					}
				});
			}



			function getRecordInfo() {
			    var Days = deepCopy (saveDays);
				if(localStorage.deviceType != "0") {
					var nvrtimeInfo = Days.slice(0,7);
					    nvrtimeInfo.unshift(Days[6])
						nvrtimeInfo.pop();
						Days = nvrtimeInfo;
				if(localStorage.channelId !='0') {
					VocationDayPlanInfo = {
						ID: saveDays[7].ID,
						Num: saveDays[7].Num,
						TimeSectionInfos: saveDays[7].TimeSectionInfos
					};
				}
				} 



				for(var i = 0; i < Days.length; i++) {
					if(Days[i].Num == 0) {
						continue;
					}
					var timeInfo = Days[i].TimeSectionInfos;
				for(var j = 0;j<timeInfo.length;j++) {
					if(timeInfo[j].Begin!==timeInfo[j].End) {
					var startTime = Number(timeInfo[j].Begin.split(':')[0]);
					var startMinute = Number(timeInfo[j].Begin.split(':')[1]);
					var startSecned = Number(timeInfo[j].Begin.split(':')[2]);
					var endTime = Number(timeInfo[j].End.split(':')[0]);
					var endMinute = Number(timeInfo[j].End.split(':')[1]);
					var endSecned = Number(timeInfo[j].End.split(':')[2]);
					if( localStorage.deviceType =='0' &&(startTime ==24 || endTime == 24)) {
						break;
					}
					if(timeInfo[j].ArmingType == 10) {
						context.fillStyle = '#FF8D7F'                       
					} else {
						context.fillStyle = '#8cb9fb'
					}
					context.globalAlpha = 0.7; //透明度
					if(startTime == endTime && startTime<24) {
						var time = (endMinute-startMinute)/60;
						var x =  i * lenW + 60*ratio;
						
						var y =  startTime * lenH + 5*ratio;
						context.fillRect(x + lenW*0.1, y +(startMinute/60)*lenH, lenW*0.8, time*lenH);
						if(localStorage.deviceType =='0' &&(timeInfo[j].Begin == '23:00:00'&&
						timeInfo[j].End == '23:59:59'
						)){
							str_mo[i][startTime] = 1;
							text(startTime,x,y)

						}
					} else{
						var x1 =  i * lenW + 60*ratio;
						var y1 =  startTime * lenH + 5*ratio;
						var y2 =  endTime * lenH + 5*ratio;
						context.fillRect(x1 + lenW*0.1, y1 +(startMinute/60)*lenH, lenW*0.8, (60-startMinute)/60*lenH);
						context.fillRect(x1 + lenW*0.1, y2, lenW*0.8, endMinute/60*lenH);
						if(startMinute==0&&startSecned==0) {
							if(timeInfo[j].ArmingType == 10) {
								str_mo[i][startTime] = 2;                 
							} else {
								str_mo[i][startTime] = 1;        
							}
							text(startTime,x1,y1);
						}
					
						if(endMinute==59&&endSecned==59&&endTime==23) {
							if(timeInfo[j].ArmingType == 10) {
								str_mo[i][endTime] = 2;                 
							} else {
								str_mo[i][endTime] = 1;        
							}
						  text(endTime,x1,y2);
						}
						
						
						

					}

					for (var l = startTime + 1; l <= endTime - 1; l++) {
						var x =  i * lenW + 60*ratio;
						var y =  l * lenH + 5*ratio;
						context.fillStyle = bgcolor
						if(timeInfo[j].ArmingType == 10) {
						str_mo[i][l] = 2; 
						context.fillStyle = '#FF8D7F'						
						} else {
						str_mo[i][l] = 1;      
						context.fillStyle = '#8cb9fb'
						}
						context.globalAlpha = 0.7;
						context.fillRect(x + lenW*0.1, y, lenW*0.8, lenH);
						text(l,x,y);
					}
					}
				}
				}

				dsBridgeFuncSyn.dismiss();
			}

			function setPlanCheck(sendData) {
				// var sendDataON = deepCopy(CheckTimeServiceData);
				// sendDataON.Enabled = sendData.Enabled;
				// sportcheck = sendData.Enabled;
				SendAjax(sendUrl, 'put', function(code, data) {
					if(code == 0) {
						
						commonAjax(LAPI.RecordScheduleInfo, sendData)
					} else {
						sendData.WeekPlan.Days = copyDate
						showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
					}
				}, coverObjs);
			}

			/**
			 * 保存按钮
			 */
			function save() {
				if(flag) {
					mui.confirm(langTip["WEB_supported"], langTip["WEB_dialog_title_notify"], btnArray, function(e) {
						if(e.index == 1) {}
					}, 'div');
					return false;
				}

				if(localStorage.deviceType == '1' && localStorage.channelId == "0") {
					if((channelID.length + disabledID.length) == disabledID.length) {
						showToast(langTip["WEB_device_manager_type_unknow"]);
						return;
					}

				}
                
				if(JSON.stringify(saveDays) == JSON.stringify(sendData.WeekPlan.Days)) {
					dsBridgeFuncSyn.backTo();
					return;
				}

				var RecordScheduleUrl = LAPI.RecordScheduleInfo;
				mui.confirm(langTip["WEB_save_recover"], langTip["WEB_dialog_title_notify"], btnArray, function(e) {
					if(e.index == 1) {
				    copyDate = deepCopy(sendData.WeekPlan.Days);
					sendData.Enabled = 1;
					sendData.WeekPlan.Days = saveDays;
						dsBridgeFuncSyn.showLoading();
						if(localStorage.deviceType == '1' && localStorage.channelId == "0") {
							for(var i = 0; i < channelID.length; i++) {
								if(LAPI.RecordScheduleInfo.indexOf('<ID>') > -1) {
									RecordScheduleUrl = LAPI.RecordScheduleInfo.replace(/<ID>/, channelID[i]);
								}
								commonAjax(RecordScheduleUrl, sendData)
							}
						} else {
							if(isAuto){
								commonAjax(RecordScheduleUrl, sendData);
							} else{
								setPlanCheck(sendData)
							}
						}
					}
				}, 'div');
			}
			function commonAjax(RecordScheduleUrl, sendData) {
				SendAjax(RecordScheduleUrl, 'put', function(code, data) {
					dsBridgeFuncSyn.dismiss();
					if(code == 0) {
					  if(localStorage.deviceType == '0'){
						//修改页面尺寸
                       //TODO：跨页面传参
                        dsBridgeFuncSyn.sendDataToReport("modifyVideoType",'true');
						}
						showToast(langTip["WEB_logcat_save_successful"]);
						// TODO:关闭当前页面
						setTimeout(function() {
							dsBridgeFuncSyn.backTo();
						}, 300);
					} else {
						sendData.WeekPlan.Days = copyDate
						if(localStorage.deviceType == "1" && localStorage.channelId == "0") {
							var tips = langTip["WEB_channel_fail"] + channelID.join(', ') + langTip["WEB_symbol"];
							showToast(tips, code);
						} else {
							showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
						}
					}
				}, sendData)
			}
		</script>
	</body>

</html>