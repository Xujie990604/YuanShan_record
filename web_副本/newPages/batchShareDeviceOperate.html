<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title></title>
  <link href="../css/mui.css" rel="stylesheet" />
  <link href="../css/iconfont.css" rel="stylesheet" />
  <!-- 样式影响到我了，先注释掉 -->
  <!-- <link href="../css/Common.css" rel="stylesheet" /> -->
  <link href="../css/theme_normal.css" rel="stylesheet" />
  <style>
    button {
      border: none !important;
      background-color: #fff !important;
    }

    input {
      border: none !important;
    }

    /* 文本超长省略 */
    .super-long-omitted {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    #recipient {
      margin: 10px 0 10px 20px;
      font-size: 14px;
      color: rgba(0, 0, 0, 0.6);
      font-weight: 400;
    }

    /* 接受者信息样式 */
    .input-common-style {
      width: 94%;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      margin-left: 3%;
      margin-bottom: 12px;
      background-color: #fff;
      border-radius: 8px;
    }

    .input-common-style .mui-icon {
      margin-right: 20px;
    }

    /* TODO: input 超过一定范围就点击不到 mui-icon了 */
    /* 有时间可以去找一下具体的原因 */
    .input-common-style .user-info {
      width: 70%;
      border: 0;
      border-radius: 8px;
    }

    /* 手机号输入框的格式 */
    .user-phone-content button {
      position: relative;
      width: 56px;
    }

    .user-phone-content button::after {
      position: absolute;
      display: block;
      content: '|';
      top: 6px;
      right: 0;
    }

    .user-phone-content input {
      width: 60%;
      flex: 1 1 0;
    }

    .user-phone-content .mui-icon {
      margin-left: 30px;
    }


    /* 备注的样式 */
    #shareRemark {
      height: 44px;
    }

    #shareRemark input {
      border-radius: 8px;
    }

    #shareTimeText {
      margin: 10px 0 10px 20px;
      font-size: 14px;
      color: rgba(0, 0, 0, 0.6);
      font-weight: 400;
      border-radius: 8px;
    }

    #shareTimeContent {
      border-radius: 8px;
    }

    #shareTimeContent input {
      border-radius: 8px;
    }

    #shareDevicesText {
      margin: 8px 20px 8px 20px;
      font-size: 14px;
      color: rgba(0, 0, 0, 0.6);
      font-weight: 400;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
    }

    /* 管理设备按钮 */
    #manageDeviceBtn {
      height: 52px;
      width: 94%;
      margin-left: 3%;
      font-size: 17px;
      color: #50d0C1 !important;
      font-weight: 400;
      border-radius: 8px !important;
    }

    /* 页签 + 列表 */
    #selectInfoContent {
      margin-top: 8px;
      position: relative;
      display: flex;
      flex-direction: column;
      width: 94%;
      margin-left: 3%;
    }

    /* 设备/通道页签 */
    .mui-segmented-control {
      background-color: #fff;
      border-radius: 8px;
      border: none;
      height: 48px;
    }

    .mui-segmented-control .mui-control-item {
      color: rgba(17, 31, 44, 0.56);
      border: none;
      line-height: 48px;
    }

    .mui-segmented-control .mui-control-item.mui-active {
      position: relative;
      background-color: #fff;
      color: #111f2c;
    }

    .mui-segmented-control .mui-control-item.mui-active::after {
      position: absolute;
      bottom: 0;
      left: 50%;
      margin-left: -12px;
      display: block;
      content: "";
      width: 24px;
      height: 3px;
      background-color: #50D0C1;
      border-radius: 3px;
    }

    /* 列表 */
    .mui-content-padded {
      margin: 8px 0 0 0;
    }

    /* 被分享设备&&通道的列表 */
    #selectDeviceListContent ul,
    #selectChannelListContent ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: transparent;
    }

    .device-logo,
    .channel-logo,
    .channel-list-logo {
      height: 48px;
      margin: 0 10px 0 12px;
    }

    /* 设备滚动列表，用于定位和设置高度 */
    /* TODO:  列表的高度需要计算产生 */
    #selectDeviceListContent {
      position: relative;
    }

    #selectDeviceListUL::after {
      height: 0;
    }

    /* 被分享的设备的样式 */
    #selectDeviceListContent .device-card {
      height: 88px;
      width: 100%;
      margin-bottom: 12px;
      display: flex;
      flex-direction: row;
      border-radius: 8px;
      background-color: #fff;
    }

    #selectDeviceListContent .device-card a {
      position: relative;
      display: flex;
      flex-direction: row;
      align-items: center;
      height: 100%;
    }

    .device-info {
      display: flex;
      flex-direction: column;
      width: 70%;
      margin-right: 30px;
    }

    .device-name {
      font-size: 17px;
      color: rgba(0, 0, 0, 0.9);
    }

    .device-permissions {
      font-size: 12px;
      color: rgba(0, 0, 0, 0.6);
    }

    /* 通道滚动列表，用于定位和设置高度 */
    #selectChannelListContent {
      position: relative;
      height: 300px;
    }

    #selectChannelListUL::after {
      height: 0;
    }

    /* 被分享的 NVR 通道的样式 */
    .channels-list-card {
      width: 100%;
      background-color: #fff !important;
      border-radius: 8px;
      margin-bottom: 20px;
    }


    .channels-list-card .collapse-btn {
      position: relative;
      display: flex;
      flex-direction: row;
      align-items: center;
      height: 56px;
    }

    .channel-list-logo {
      position: absolute;
      top: 5px;
    }

    .NVR-channels-list-name {
      display: inline-block;
      position: absolute;
      left: 80px;
      top: 22px;
      width: 70%;
    }

    /* NVR 通道列表的折叠按钮 */
    #selectChannelListContent .collapse-btn::after {
      position: absolute;
      top: 50%;
      left: 0;
      font-size: 30px;
    }

    .channels-list-card::after {
      height: 0 !important;
    }

    /* NVR设备和通道的分割线 */
    .channels-list-card .line {
      height: 1px;
      background-color: rgba(51, 51, 51, 0.15);
      margin-bottom: 5px;
    }

    .channel-card .channel-card-a {
      position: relative;
      height: 88px;
      display: flex;
      flex-direction: row;
      align-items: center;
    }

    .channel-info {
      display: flex;
      flex-direction: column;
      width: 70%;
      margin-right: 30px;
    }

    .channel-name {
      font-size: 17px;
      color: rgba(0, 0, 0, 0.9);
    }

    .channel-permissions {
      font-size: 12px;
      color: rgba(0, 0, 0, 0.6);
    }

    /* 底部的批量分享按钮 */
    #EZView-content .batch-share-btn-content {
      position: fixed;
      bottom: 0;
      height: 86px;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #fff;
    }

    #EZView-content .batch-share-btn {
      height: 44px;
      width: 78%;
      border-radius: 22px !important;
      background-color: #50d0c1 !important;
      font-size: 17px;
      color: #fff !important;
      font-weight: 400;
    }
  </style>
</head>

<body>
  <!-- 页面标题：批量分享 -->
  <header class="mui-bar mui-bar-nav">
    <a id="back" class="mui-icon iconfont icon-back1"></a>
    <h1 id="title" class="mui-title" data-text="">批量分享</h1>
  </header>
  <div class="mui-content">
    <div id="EZView-content" class="">
      <div id="recipient">接收者</div>
      <!-- 被分享者 -->
      <!-- 用户名/邮箱 -->
      <div id="userNameEmailContent" class="input-common-style">
        <input id="userNameEmailInput" class="user-info" type="text" placeholder="请输入用户名/邮箱">
        <span class="mui-icon mui-icon-phone"></span>
      </div>
      <!-- 手机号码 -->
      <div id="userPhoneContent" class="user-phone-content input-common-style mui-hidden">
        <button>+86</button>
        <input type="text" id="userPhoneInput" placeholder="请输入手机号号码">
        <span class="mui-icon mui-icon-email"></span>
      </div>
      <!-- 备注 -->
      <div id="shareRemark" class="input-common-style">
        <input id="shareRemarkInput" type="text" class="mui-input-clear" placeholder="请输入备注（不超过64个字符）">
      </div>
      <div id="shareTimeText">分享有效期</div>
      <div id="shareTimeContent" class="input-common-style">
        <input type="text" id="shareTimeInput">
        <span class="mui-icon mui-icon-compose"></span>
      </div>
      <div id="shareDevicesText">
        <span>被分享的设备</span>
        <span id="editDeviceBtn" class="mui-hidden">管理设备</span>
      </div>
      <button id="manageDeviceBtn" type="button" class="mui-btn">管理设备</button>

      <!-- 列表：用户勾选的设备 -->
      <div id="selectInfoContent">
        <!-- 选项卡：设备/通道切换 -->
        <!-- TODO:只在有数据的时候显示这个 tab，没数据的时候不显示 -->
        <div class="tab-card mui-hidden">
          <div id="segmentedControl" class="mui-segmented-control">
            <a href="#item1" class="mui-control-item ">设备</a>
            <a href="#item2" class="mui-control-item mui-active">通道</a>
          </div>
        </div>
        <!-- 使用 mui 的组件来实现列表滚动 -->
        <div class="mui-content-padded">

          <!-- 选项卡内容：设备的信息 -->
          <div id="item1" class="mui-control-content">
            <div id="selectDeviceListContent">
              <div class="mui-scroll-wrapper">
                <div class="mui-scroll">
                  <ul id="selectDeviceListUL" class="mui-table-view">
                    <!-- IPC设备模版 -->
                    <li class="device-card-template device-card mui-hidden">
                      <a class="mui-navigate-right">
                        <img class="device-logo" src="../images/appConfig/IPC3x.png">
                        <div class="device-info">
                          <span class="device-name super-long-omitted">IPC-001</span>
                          <span class="device-permissions">实况查看/云台控制/语音对讲/告警消息/录像查看/设备配置</span>
                        </div>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- 选项卡内容：通道的信息 -->
          <div id="item2" class="mui-control-content mui-active">
            <div id="selectChannelListContent">
              <div class="mui-scroll-wrapper">
                <div class="mui-scroll">
                  <ul id="selectChannelListUL" class="mui-table-view">
                    <!-- NVR通道列表模版 -->
                    <li
                      class="mui-table-view-cell mui-collapse NVR-channels-list-card-template channels-list-card mui-hidden mui-active">
                      <a class="mui-navigate-right collapse-btn" href="#">
                        <img class="channel-list-logo" src="../images/appConfig/NVR3x.png">
                        <span class="NVR-channels-list-name super-long-omitted">NVR-001</span>
                      </a>
                      <div class="mui-collapse-content">
                        <!-- 分割线 -->
                        <div class="line"></div>
                        <!-- 通道列表 -->
                        <ul class="mui-table-view NVR-channel-list-ul">
                          <!-- 把 NVR 通道卡片的 DOM 结构放到这里面 -->
                        </ul>
                      </div>
                    </li>
                    <!-- NVR 通道卡片模板 -->
                    <li class="NVR-channels-card-template mui-hidden channel-card">
                      <a class="mui-navigate-right channel-card-a">
                        <img class="channel-logo" src="../images/appConfig/IPC3x.png">
                        <div class="channel-info">
                          <span class="channel-name super-long-omitted">IPC-001</span>
                          <span class="channel-permissions">实况查看/云台控制/语音对讲/告警消息/录像查看/设备配置</span>
                        </div>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>

          </div>

        </div>

      </div>

      <!-- 按钮：分享按钮 -->
      <div class="batch-share-btn-content">
        <button id="batchShareBtn" type="button" class="mui-btn batch-share-btn">分享</button>
      </div>

    </div>
  </div>
  <script src="../js/dsbridge.min.js"></script>
  <script src="../js/common.js"></script>
  <script src="../js/libs/md5.js"></script>
  <script src="../js/libs/jquery-3.4.1.min.js"></script>
  <script src="../js/libs/sha2.js"></script>
  <script src="../js/resource.js"></script>
  <script src="../js/Utils.js"></script>
  <script src="../js/mui.js"></script>
  <script src="../js/immersed.js"></script>
  <script src="../js/customSetting.js"></script>
  <script src="../js/loadCss.js"></script>
  <script src="../js/batchShareDeviceUtil.js"></script>
  <script id="langScript"></script>
  <script>
    var langTip;
    checkType(localStorage.AppType); //加载特定样式
    mui.init();
    // 获取语言文件
    var typeLan = initLang();
    langTip = typeLan.lang;
    var shareToUserBy = 'userNameEmail'  // 分享用户的方式 userNameEmail 用户名/邮箱  phone 手机号

    dsBridgeFuncSyn.dismiss()

    // 所有的设备数据(以这份数据为中心，编辑权限，添加权限，新增设备，删除设备都要反应在这个数组中)
    var allDevicesInfo = []
    // 所有的通道数据
    var allChannelsInfo = []


    // 初始化页面
    initPage()
    // 初始化数据
    initData();
    // 初始化事件
    initEvent()

        function initPage() {
      // 初始化滚动列表
      mui('.mui-scroll-wrapper').scroll();
      // TODO：一个月后的时间戳，后续需要替换成永久时间的时间戳
      $('#shareTimeInput').val(1697766880)
      if (isMock) {
        // mock 的假数据
        // 从设备管理页面传过来的所有设备信息
        var param = {
          deviceList: [
            {
              "deviceSerial": "211111XXXXXXXXXXXXX1",
              "deviceName": "IPC未被分享",
              "deviceType": 0,
              "isShared": 0
            },
            {
              "deviceSerial": "222222XXXXXXXXXXXXX1",
              "deviceName": "IPC被分享",
              "deviceType": 0,
              "isShared": 1
            },
            {
              "deviceSerial": "233333XXXXXXXXXXXXX1",
              "deviceName": "NVR卧室",
              "deviceType": 1,
              "isShared": 0
            },
            {
              "deviceSerial": "244444XXXXXXXXXXXXX1",
              "deviceName": "NVR3在卧室",
              "deviceType": 1,
              "isShared": 1
            },
            {
              "deviceSerial": "255555XXXXXXXXXXXXX1",
              "deviceName": "NVR4在卧室",
              "deviceType": 1,
              "isShared": 1
            },
            {
              "deviceSerial": "266666XXXXXXXXXXXXX1",
              "deviceName": "NVR5在卧室",
              "deviceType": 1,
              "isShared": 1
            },
          ],
          channelsList: [
            {
              deviceSerial: '233333XXXXXXXXXXXXX1',
              deviceName: 'NVR卧室',
              deviceType: '1',
              isShared: 0,
              channelList: [
                {
                  channelName: '通道1',
                  channelNo: '1',
                  isShared: 1
                },
                {
                  channelName: '通道2',
                  channelNo: '2',
                  isShared: 1
                }
              ]
            },
            {
              deviceSerial: '22222222xxxxxxxxxxxx7',
              deviceName: 'NVR在林场',
              deviceType: '1',
              channelList: [
                {
                  channelName: '通道3',
                  channelNo: 3,
                  isShared: 1
                },
                {
                  channelName: '通道4',
                  channelNo: 4,
                  isShared: 0
                },
                {
                  channelName: '通道5',
                  channelNo: 5,
                  isShared: 0
                }
              ]
            }
          ]
        }
        allDevicesInfo = param.deviceList;
        allChannelsInfo = param.channelsList;
        if (allChannelsInfo.length != 0 || allDevicesInfo.length != 0) {
          $('.tab-card').removeClass('mui-hidden')
          $('#manageDeviceBtn').addClass('mui-hidden')
          $('#editDeviceBtn').removeClass('mui-hidden')
        } else {
          $('.tab-card').addClass('mui-hidden')
          $('#manageDeviceBtn').removeClass('mui-hidden')
          $('#editDeviceBtn').addClass('mui-hidden')
        }
        // 首次被添加的数据上需要被添加默认最全的权限
        addPermissionToNewDevice(allDevicesInfo, allChannelsInfo)
        // 从所有的设备&&通道信息中筛选中 被选中的
        var selectDeviceChannelInfo = filterSelectedDevice(allDevicesInfo, allChannelsInfo)
        // 生成设备列表
        buildSelectDeviceList(selectDeviceChannelInfo.selectDeviceInfoArray)
        // 生成通道列表
        buildSelectChannelsList(selectDeviceChannelInfo.selectChannelsInfoArray)
        var scrollBottom = $(".batch-share-btn-content").offset().top;
        var scrollTop = $('.mui-content-padded').offset().top;
        var scrollHeight = scrollBottom - scrollTop;
        $('#selectDeviceListContent').css("height", scrollHeight + "px");
        $('#selectChannelListContent').css("height", scrollHeight + "px");
      }

    }


    function initData() {

    }

    function initEvent() {
      // 事件绑定：设备管理(首次添加时的大按钮)按钮的 tap 事件
      $('#manageDeviceBtn').on('tap', function () {
        // 跳转页面：跳转到设备管理页面, 只携带操作类型，不携带数据
        var param = {
          operateType: 'add'
        }
        dsBridgeFuncSyn.pageTo("web/newPages/manageDevice.html", JSON.stringify(param));

      })

      // 事件绑定：设备管理(编辑信息时的小按钮)按钮的 tap 事件
      $('#editDeviceBtn').on('tap', function () {
        // 跳转页面：跳转到设备管理页面, 携带操作类型和设备信息
        var param = {
          deviceList: allDevicesInfo,
          channelsList: allChannelsInfo,
          operateType: 'edit'
        }
        dsBridgeFuncSyn.pageTo("web/newPages/manageDevice.html", JSON.stringify(param));
      })

      // 绑定事件：切换到手机号分享
      $('.mui-icon-phone').on('tap', function () {
        event.stopPropagation()
        $('#userPhoneContent').removeClass('mui-hidden')
        $('#userNameEmailContent').addClass('mui-hidden')
        shareToUserBy = "phone"
      })

      // 绑定事件：切换到用户名/邮箱分享
      $('.mui-icon-email').on('tap', function () {
        $('#userPhoneContent').addClass('mui-hidden')
        $('#userNameEmailContent').removeClass('mui-hidden')
        shareToUserBy = "userNameEmail"
      })

      // 事件绑定：时间选择框的 tap 事件
      $('.mui-icon-compose').on('tap', function () {
        // TODO：data 的格式应该是什么样的？ showDate() 的第一个参数应该是什么样的
        var data = ""
        dsBridgeFuncAsyn.showDate("ptzTime", date, function (result) {
          console.log(result);
        })
      })

      // 事件绑定：分享按钮的 tap 事件
      $("#batchShareBtn").on('tap', batchShareDevice)

    }

    // 事件处理函数：批量分享设备给用户
    function batchShareDevice() {
      var sendData = {}
      // 填充值：用户名/邮箱/手机号
      if (shareToUserBy == 'userNameEmail') {
        var shareTo = $('#userNameEmailInput').val()
      } else {
        // TODO: 手机的区号要如何传入
        var shareTo = $('#userPhoneInput').val()
      }
      if (shareTo == "") {
        showToast("被分享者不能为空");
        return
      }
      // 填充值：备注
      var remark = $('#shareRemarkInput').val()
      // 填充值：截止日期
      // TODO：截止日期需要转换成时间戳的形式
      var endTime = $('#shareTimeInput').val()
      // 填充值：设备列表
      var selectInfo = filterSelectedDevice(allDevicesInfo, allChannelsInfo);
      var deviceList = createShareDeviceList(selectInfo.selectDeviceInfoArray, selectInfo.selectChannelsInfoArray)
      if (deviceList.length == 0) {
        showToast("请选择分享设备");
        return
      }
      sendData = {
        shareTo: shareTo,
        remark: remark,
        endTime: Number(endTime),
        deviceList: deviceList
      }
      // TODO: 提示框的样式需要自己 DIY
      var btn = ['确定', "取消"]
      mui.confirm('确认分享设备给如下账号吗', "分享", btn, function (e) {
        if (e.index == 0) {
          console.log('创建批量分享时的入参%o', sendData);
          // 调用接口：创建批量分享的接口
          batchShareDeviceAPI(sendData)
        }
      })
    }

    // 接口：创建批量分享的接口
    function batchShareDeviceAPI(sendData) {
      dsBridgeFuncSyn.showLoading()
      CloudSendAjax(localStorage.serverAddress + openAPI.batchShareCreate, 'post', function (code, message, data) {
        if (code == 200) {
          var batchShareFailedDevice = data.shareResultList.filter(function (deviceInfo) {
            return deviceInfo.code != 200
          })
          // 全部分享成功
          if (batchShareFailedDevice.length == 0) {
            showToast("分享成功");
          } else {
            batchShareFailedDevice.forEach(function (deviceInfo) {
              showToast("", deviceInfo.code);
            })
          }
          dsBridgeFuncSyn.dismiss();
          // 页面跳转：设备详情页面
          var param = {
            userId: data.shareUserId,
            userName: sendData.shareTo,
            remark: sendData.remark
          }
          // 通知批量分享管理首页：更新数据
          dsBridgeFuncSyn.sendDataToReport("batchShareDeviceSuccess", "");
          // 从批量分享页面调到分享详情页面之前把自己返回掉，这样在详情页面取消分享或者使用返回键后能直接回到批量分享首页
          dsBridgeFuncSyn.sendDataToReport("destroyDeviceOperatePage", "");
          dsBridgeFuncSyn.pageTo("web/newPages/batchShareDeviceDetail.html", JSON.stringify(param));
        } else {
          addBitmap(0);
          showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
          dsBridgeFuncSyn.dismiss();
        }
      }, sendData)
    }

    // 生成被分享设备的列表
    function buildSelectDeviceList(selectDeviceInfoList) {
      // 避免数据叠加：每次渲染前将之前的生成的 DOM 结构清除
      $('#selectDeviceListUL li:not(.mui-hidden)').remove()
      var ulDom = $('#selectDeviceListUL');
      selectDeviceInfoList.forEach((deviceInfo) => {
        // 克隆模板
        var deviceTemplate = $('.device-card-template').clone();
        deviceTemplate.removeClass('device-card-template mui-hidden');
        var imgUrl = ""
        // TODO: 后续门铃门禁可能会有自己的专属图标
        switch (deviceInfo.deviceType) {
          case 0:
            imgUrl = "../images/appConfig/IPC3x.png"
            break;
          case 1:
            imgUrl = "../images/appConfig/NVR3x.png"
            break;
          case 6:
            imgUrl = "../images/appConfig/IPC3x.png"
            break;
          case 7:
            imgUrl = "../images/appConfig/IPC3x.png"
            break;
          default:
            imgUrl = "../images/appConfig/IPC3x.png"
        }
        // 填充值：设备图片信息
        deviceTemplate.find("img").attr("src", imgUrl)
        // 填充值：设备名称
        deviceTemplate.find(".device-name").text(deviceInfo.deviceName)
        // 填充值：设备权限
        deviceTemplate.find(".device-permissions").text(changePermissionToText(deviceInfo.permission))
        // 事件绑定：点击设备卡片的 tap 事件
        deviceTemplate.on('tap', updateDevicePermission)
        // 添加属性：设备序列号
        deviceTemplate.attr("data-deviceSerial", deviceInfo.deviceSerial)
        // 插入列表中
        ulDom.append(deviceTemplate)
      })
    }

    // 事件处理函数；点击设备卡片，想要修改权限
    function updateDevicePermission() {
      var currentDeviceSerial = $(this).attr("data-deviceSerial")
      var currentDeviceInfo = allDevicesInfo.filter(function (deviceInfo) {
        return deviceInfo.deviceSerial == currentDeviceSerial
      })
      // 跳转页面：跳转到权限管路页面, 携带被点击设备的信息
      var param = {
        deviceInfo: currentDeviceInfo[0],
        operateType: 'updatePermission'
      }
      dsBridgeFuncSyn.pageTo("web/newPages/devicePermissionManage.html", JSON.stringify(param));
    }

    function buildSelectChannelsList(selectChannelsInfoList) {
      // 避免数据叠加：每次渲染前将之前的生成的 DOM 结构清除
      $('#selectChannelListUL li:not(.mui-hidden)').remove()
      var ulDom = $('#selectChannelListUL');
      selectChannelsInfoList.forEach(function (channelsListInfo) {
        // 克隆模版: 通道列表
        var channelsListTemplate = $('.NVR-channels-list-card-template').clone();
        channelsListTemplate.removeClass('NVR-channels-list-card-template mui-hidden');
        // 移除掉通道数据的模版
        channelsListTemplate.remove(".NVR-channels-card-template.mui-hidden")
        // 填充值：通道所属 NVR 设备的名字
        channelsListTemplate.find('.NVR-channels-list-name').text(channelsListInfo.deviceName);
        // 添加属性：NVR 的设备序列号
        channelsListTemplate.attr("data-deviceSerial", channelsListInfo.deviceSerial)

        channelsListInfo.channelList.forEach(function (channelInfo) {
          var NVRListUlDom = channelsListTemplate.find('.NVR-channel-list-ul');
          // 克隆模版：通道
          var channelTemplate = $('.NVR-channels-card-template').clone();
          channelTemplate.removeClass('NVR-channels-card-template mui-hidden');
          // 填充值：NVR 通道的名字
          channelTemplate.find(".channel-name").text(channelInfo.channelName);
          // 填充值：通道的权限信息
          channelTemplate.find(".channel-permissions").text(changePermissionToText(channelInfo.permission))
          // 添加属性：通道号
          channelTemplate.attr("data-channelNo", channelInfo.channelNo)
          // 事件绑定：点击通道卡片的 tap 事件
          channelTemplate.on('tap', updateChannelPermission)
          // 通道插入通道 List 中
          NVRListUlDom.append(channelTemplate);
        })
        ulDom.append(channelsListTemplate);
      })
    }

    // 事件处理函数：更改被点击通道的权限
    function updateChannelPermission() {
      currentDeviceSerial = $(this).parents(".mui-collapse").attr("data-deviceSerial")
      currentChannelNo = $(this).attr("data-channelNo")
      var channelInfoTemp = {}
      allChannelsInfo.forEach(function (channelListInfo) {
        if (channelListInfo.deviceSerial == currentDeviceSerial) {
          channelListInfo.channelList.forEach(function (channelInfo) {
            if (channelInfo.channelNo == currentChannelNo) {
              channelInfoTemp = deepCopy(channelInfo)
              channelInfoTemp.deviceSerial = currentDeviceSerial
            }
          })
        }
      })
      // 跳转页面：跳转到权限管路页面, 携带被点击设备的信息
      var param = {
        deviceInfo: channelInfoTemp,
        operateType: 'updatePermission'
      }
      console.log("被点击通道卡片的数据%o", param.deviceInfo);
      dsBridgeFuncSyn.pageTo("web/newPages/devicePermissionManage.html", JSON.stringify(param));

    }

    // 将被选择 设备/通道 的数据，组装成接口需要的形式 
    function createShareDeviceList(selectDeviceInfoList, selectChannelsInfoList) {
      var deviceList = []
      // 生成分享设备的数据
      selectDeviceInfoList.forEach(function (selectDeviceInfo) {
        var deviceInfo = {}
        deviceInfo.deviceSerial = selectDeviceInfo.deviceSerial;
        deviceInfo.permission = selectDeviceInfo.permission;
        deviceInfo.shareName = selectDeviceInfo.deviceName;
        deviceList.push(deviceInfo)
      })

      // 生成分享通道的数据
      selectChannelsInfoList.forEach(function (selectChannelsList) {
        // 遍历 NVR 设备下的通道信息
        selectChannelsList.channelList.forEach(function (selectChannelInfo) {
          // 同一个 NVR 设备下的通道，共用同一个设备序列号
          var channelInfo = {
            deviceSerial: selectChannelsList.deviceSerial
          }
          channelInfo.channelNo = Number(selectChannelInfo.channelNo);
          channelInfo.permission = selectChannelInfo.permission;
          channelInfo.shareName = selectChannelInfo.channelName;
          deviceList.push(channelInfo)
        })
      })
      return deviceList;
    }


    /******************新增原生App上报Web功能接口******************/
    // 监听原生侧上报数据
    dsBridge.register("callWebDoFuncAsyn", function (args) {
      appLog("Web --- args: " + args);
      var webInfo = JSON.parse(args);
      for (var key in webInfo) {
        switch (webInfo[key].whichInfo) {
          // 管理界面选择的数据在当前页面进行展示
          case "addSelectDeviceChannels":
            var param = JSON.parse(webInfo[key].infoValue);
            allDevicesInfo = param.deviceList;
            allChannelsInfo = param.channelsList;
            if (allChannelsInfo.length != 0 || allDevicesInfo.length != 0) {
              $('.tab-card').removeClass('mui-hidden')
              $('#manageDeviceBtn').addClass('mui-hidden')
              $('#editDeviceBtn').removeClass('mui-hidden')
            } else {
              $('.tab-card').addClass('mui-hidden')
              $('#manageDeviceBtn').removeClass('mui-hidden')
              $('#editDeviceBtn').addClass('mui-hidden')
            }
            // 首次被添加的数据上需要被添加默认最全的权限
            addPermissionToNewDevice(allDevicesInfo, allChannelsInfo)
            // 从所有的设备&&通道信息中筛选中 被选中的
            var selectDeviceChannelInfo = filterSelectedDevice(allDevicesInfo, allChannelsInfo)
            // 生成设备列表
            buildSelectDeviceList(selectDeviceChannelInfo.selectDeviceInfoArray)
            // 生成通道列表
            buildSelectChannelsList(selectDeviceChannelInfo.selectChannelsInfoArray)
            var scrollBottom = $(".batch-share-btn-content").offset().top;
            var scrollTop = $('.mui-content-padded').offset().top;
            var scrollHeight = scrollBottom - scrollTop;
            $('#selectDeviceListContent').css("height", scrollHeight + "px");
            $('#selectChannelListContent').css("height", scrollHeight + "px");
            break;
          // 修改设备的权限
          case "updateDevicePermission":
            var param = JSON.parse(webInfo[key].infoValue);
            if (param.deviceInfo.channelNo != undefined) {
              // 更新通道的数据
              allChannelsInfo.forEach(function (channelsListInfo) {
                if (channelsListInfo.deviceSerial == param.deviceInfo.deviceSerial) {
                  channelsListInfo.channelList.forEach(function (channelInfo) {
                    if (channelInfo.channelNo == param.deviceInfo.channelNo) {
                      channelInfo.permission = param.deviceInfo.permission;
                    }
                  })
                }
              })
              var selectInfo = filterSelectedDevice(allDevicesInfo, allChannelsInfo)
              buildSelectChannelsList(selectInfo.selectChannelsInfoArray)
            } else {
              // 更新设备的信息
              allDevicesInfo.forEach(function (deviceInfo) {
                if (deviceInfo.deviceSerial == param.deviceInfo.deviceSerial) {
                  deviceInfo.permission = param.deviceInfo.permission;
                }
              })
              var selectInfo = filterSelectedDevice(allDevicesInfo, allChannelsInfo)
              buildSelectDeviceList(selectInfo.selectDeviceInfoArray)
            }
            break;
          // 在设备详情页面取消分享或者使用返回键，需要直接回到批量分享首页，所以需要把自己销毁掉
          case "destroyDeviceOperatePage":
            dsBridgeFuncSyn.backTo();
            break;
          case "deviceStatus": // 更新设备在线状态
            localStorage.deviceStatus = webInfo[key].infoValue;
            break;
          case "ip": // 更新ip
            localStorage.Ip = webInfo[key].infoValue;
            break;
          case "port": // 更新port
            localStorage.Port = webInfo[key].infoValue;
            break;
          case "logInfo": //更新登录信息
            localStorage.logInfo = webInfo[key].infoValue;
            break;
          case "deviceName": //更新设备名称
            var deviceName = document.getElementById("deviceName");
            break;
          case "sdkType": //更新SDK类型
            localStorage.sdkType = webInfo[key].infoValue;
            break;
          case "isNetConnect": //更新手机是否联网
            localStorage.isNetConnect = webInfo[key].infoValue;
            break;
          case "hasNewVersion": //是否有新版本
            localStorage.hasNewVersion = webInfo[key].infoValue;
            break;
          case "versionNumber": //当前版本号
            localStorage.versionNumber = webInfo[key].infoValue;
            break;
          case "LocalDeviceUname": //免注册设备用户名更新
            localStorage.LocalDeviceUname = webInfo[key].infoValue;
            break;
          case "deviceOs": //设备云端在线状态 “true”在线，“false”离线
            localStorage.deviceOs = webInfo[key].infoValue;
            break;
          case "updateChannelName": // TODO：通道名称修改成功后，主页同步更新
            localStorage.deviceName = webInfo[key].infoValue;
            break;
          case "workingStatus":
            localStorage.workingStatus = webInfo[key].infoValue;
            break;
          case "channelStatus":
            localStorage.channelStatus = webInfo[key].infoValue;
            break;
          default:
            break;
        }
      }
    })


  </script>
</body>

</html>