<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<link href="../css/theme_normal.css" rel="stylesheet" />
		<style>
			.ui-placeholder-imgbox1 p {
				font-family: simhei;
				text-align: center;
				margin-top: 5px;
			}
			
			.ui-placeholder-imgbox1 {
				padding: 12px 20px 0px 20px;
				text-align: center;
			}
			
			.ui-placeholder-imgbox1 img {
				width: 65px;
			}
			
			#placeholderImg {
				position: absolute;
				width: 100%;
				height: 88%;
			}
			
			.ui-concent {
				width: 80%;
				line-height: 20px;
				margin: 0 10%;
				text-align: left;
				text-justify: distribute-all-lines;
				height: 60%;
				overflow-y: scroll;
			}
			/*滚动条样式*/
			
			.ui-concent::-webkit-scrollbar {
				/*滚动条整体样式*/
				width: 4px;
				/*高宽分别对应横竖滚动条的尺寸*/
				height: 4px;
			}
			
			.ui-concent::-webkit-scrollbar-thumb {
				/*滚动条里面小方块*/
				border-radius: 5px;
				-webkit-box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
				background: rgba(99, 99, 99, 1);
			}
			
			.ui-concent::-webkit-scrollbar-track {
				/*滚动条里面轨道*/
				-webkit-box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
				border-radius: 0;
				background: rgba(0, 0, 0, 0.2);
			}
			
			.mui-input-row .mui-input-clear~.mui-icon-clear {
				font-size: 20px;
				position: absolute;
				z-index: 1;
				top: 4px;
				right: 0;
				width: 38px;
				height: 38px;
				line-height: 38px;
				text-align: center;
				color: #999;
			}
			
			.ui-top {
				margin-top: 12px;
			}
			
			#topDiv {
				padding-top: 10px;
				padding-left: 20px;
			}
			
			.ui-img {
				width: 60px
			}
			
			.ui-area {
				height: 60px;
				width: 200px;
				margin-left: 13px;
				border: 0;
				vertical-align: top;
				font-size: 15px !important;
			}
			
			.ui-js {
				position: absolute;
				top: 120px;
				left: 80px;
			}
			
			.ui-placeholder-imgbox2 p {
				font-family: simhei;
				text-align: center;
				margin-top: 5px;
			}
			
			.ui-placeholder-imgbox2 {
				padding: 50px 20px 0px 20px;
			}
			
			.ui-placeholder-imgbox2 img {
				width: 100%;
			}
			
			.ui-iknow {
				margin-top: 40px;
				text-align: center;
			}
			
			.ui-iknow .mui-btn {
				/*color: #50d0c1;
				border: 1px solid #50d0c1;*/
				height: 44px;
				border-radius: 22px !important;
				font-size: 16px;
				width: 200px;
				white-space: nowrap;
  			text-overflow: ellipsis;
  			overflow: hidden;
			}
			
			.mui-input-row label {
				width: auto !important;
				float: right;
			}
			
			.mui-input-row label~input {
				float: left !important;
				padding-left: 15px;
			}
			
			.ui-p1 {
				margin-top: 15px;
				font-size: 18px;
				font-weight: bold;
				color: #000000;
			}
			
			.ui-wite {
				background-color: #efeff4 !important;
				color: #000000;
			}
			
			.ui-placeholder-full {
				width: 100%;
				height: 100%;
				position: absolute;
				top: 0;
				left: 0;
				background: #ffffff;
			}
			
			.mui-input-row {
				background-color: #ffffff;
				color: #000000;
			}
			
			.ui-wite .mui-input-row:last-child {
				background-color: #ffffff;
			}
			
			input[type='text'] {
				margin-bottom: 0;
				padding: 10px 15px;
				-webkit-user-select: text;
				border: 1px solid rgba(0, 0, 0, .1);
				border-radius: 0;
				outline: none;
				-webkit-appearance: none;
				height: 45px;
				background-color: #ffffff;
			}
			
			input:disabled {
				opacity: 0.4;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_cancel_account">&nbsp;</h1>
			<a id="back1" class="mui-icon iconfont icon-back1 mui-pull-left mui-hidden"></a>
			<a id="close" class="mui-icon iconfont icon-close mui-pull-left mui-hidden"></a>
		</header>
		<div class="mui-content">
			<!--注销内容-->
			<div id="placeholderImg">
				<div class="ui-placeholder-imgbox1">
					<img src="../images/cancel_icon.png" />
					<p class="ui-p1" data-text="WEB_cancel_account"></p>
				</div>
				<div id="concent" class="ui-concent"></div>
				<div class="ui-center" style="margin-top: 40px">
					<button id="cancelAccount" class="mui-btn ui-large-btn ui-large-btn1" data-text="WEB_cancel_apply"></button>
				</div>
			</div>
			<!--账号-->
			<div id="accountInfo" class="mui-hidden">
				<div class="mui-input-row ui-top">
					<input id="accountName" disabled autocomplete="off" type="text" value="">
				</div>
				<div class="ui-center">
					<button id="cancelCode" class="mui-btn ui-large-btn ui-large-btn1" data-text="WEB_cancel_code"></button>
				</div>
			</div>
			<!--验证码-->
			<div id="inputCode" class="mui-hidden">
				<div class="ui-center" style="margin-top: 15px">
					<p id="tip1" class="ui-tishi" data-text="WEB_cancel_tip3">&nbsp;</p>
					<p id="tip2" class="ui-tishi">&nbsp;</p>
				</div>
				<div class="mui-input-row ui-top">
					<label id="codeTime">60s</label>
					<input id="code" type="tel" pattern="[0-9]*" oninput="checkVal()" data-placeholder="cancel_codeIn" autocomplete="off" type="text" value="">
				</div>
				<div class="ui-center">
					<button disabled id="cancelConfirm" class="mui-btn ui-large-btn ui-large-btn1" data-text="WEB_cancel_confirm"></button>
				</div>
			</div>
			<!--注销成功，显示注销原因-->
			<div id="cancelReason" class="mui-hidden">
				<div id="topDiv" class="ui-wite ui-top">
					<img class="ui-img" src="../images/cancel_reason.png"></img>
					<img class="ui-js"></img>
					<textarea readonly="readonly" class="ui-area ui-large-btn1" data-text="WEB_cancel_tip4"></textarea>
				</div>
				<div class="ui-wite ui-group">
					<div class="mui-input-row mui-checkbox mui-left">
						<label data-text="WEB_cancel_reason1"></label>
						<input name="checkbox1" value="1" type="checkbox">
					</div>
					<div class="mui-input-row mui-checkbox mui-left">
						<label data-text="WEB_cancel_reason2"></label>
						<input name="checkbox2" value="2" type="checkbox">
					</div>
					<div class="mui-input-row mui-checkbox mui-left">
						<label data-text="WEB_cancel_reason3"></label>
						<input name="checkbox3" value="3" type="checkbox">
					</div>
					<div class="mui-input-row mui-checkbox mui-left">
						<label data-text="WEB_cancel_reason4"></label>
						<input name="checkbox4" value="4" type="checkbox">
					</div>
				</div>
				<div class="mui-input-row ui-top ">
					<label data-text="WEB_cancel_reason_other"></label>
					<input id="otherReason" data-placeholder="cancel_select" type="text" oninput="checkVal1()" autocomplete="off" value="">
				</div>
				<p class="ui-tishi" data-text="WEB_channel_suggestion1"></p>
				<div class="ui-center">
					<button id="cancelSend" class="mui-btn ui-large-btn ui-large-btn1" data-text="WEB_cancel_send"></button>
				</div>
			</div>
			<!--注销失败，提示注销失败原因-->
			<div id="cancelFail" class="ui-placeholder-full mui-hidden">
				<div class="ui-placeholder-imgbox2">
					<img src="../images/cancel_fail.png" />
					<p class="ui-p1" data-text="WEB_cancel_fail"></p>
					<p data-text="WEB_cancel_tip1"></p>
					<p data-text="WEB_cancel_tip2"></p>
				</div>
				<div class="ui-iknow">
					<button id="delete_device" class="mui-btn mui-btn-outlined" data-text="WEB_cancel_delete"></button>
				</div>
			</div>
		</div>
		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/cancel_en.js"></script>
		<script src="../js/cancel_zh.js"></script>
		<script src="../js/loadCss.js "></script>
		<script id="langScript"></script>
		<script>
			// Native跳转进入web页面后先获取设备+云账号所有信息（原启动参数）
			var argsObj = dsBridgeFuncSyn.getAllInfo();
			dsBridgeFuncSyn.printH5Log("Z --- 字符串" + argsObj);
			var argsObj = JSON.parse(argsObj);
			getNativeInfo(argsObj);
		</script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/immersed.js"></script>
		<script>
			var langTip;
			checkType(localStorage.AppType); //加载特定样式
			var cancelState;
			var codeTime = 60;
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;
			if(typeLan.type == "zh") {
				cancelState = cancel_state_zh;
			} else {
				cancelState = cancel_state_en;
			}
			dsBridgeFuncSyn.dismiss();
			initPage();
			initData();
			initEvent();
  getShareUserList()
          // 获取用户列表
            function getShareUserList() {

              var sendData = {}
              CloudSendAjax(localStorage.serverAddress + openAPI.shareUserList, 'post', function (code, message, data) {
                if (code == 200) {
                console.log(data);
                  dsBridgeFuncSyn.dismiss();
                } else {
                  addBitmap(0);
                  showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
                  dsBridgeFuncSyn.dismiss();
                }
              }, sendData)
            }

			function initPage() {
				document.getElementById('concent').innerHTML = cancelState;
			}

			function initData() {
				var accountType = localStorage.accountType == 1 ? langTip["WEB_email"] : langTip["WEB_phone"];
				const cloudName = localStorage.areaCode === 'undefined' || localStorage.areaCode === '' ? '' : '+' + localStorage.areaCode + ' ';
				document.getElementById('tip1').innerText = langTip["WEB_cancel_tip3"] + accountType;
				document.getElementById('tip2').innerText = cloudName + localStorage.cloudUserName1;
				document.getElementById('accountName').value = cloudName + localStorage.cloudUserName1;
				if(localStorage.firstArea === 'true' && localStorage.areaCode !== 'undefined' && localStorage.areaCode !== '') {
					localStorage.firstArea = false;
					localStorage.cloudUserName = localStorage.areaCode + localStorage.cloudUserName;
				}
			}

			function initEvent() {
				document.getElementById('cancelAccount').addEventListener('tap', cancelAccount);
				document.getElementById('cancelCode').addEventListener('tap', cancelCode); //获取验证码
				document.getElementById("cancelConfirm").addEventListener('tap', cancelConfirm); //验证验证码
				document.getElementById("back1").addEventListener('tap', backToCancelContent); //关闭返回注册页面
				document.getElementById("close").addEventListener('tap', cancel_suc); //关闭返回注册页面
				document.getElementById('delete_device').addEventListener('tap', delete_device); //跳转到删除设备页面
				document.getElementById('cancelSend').addEventListener('tap', cancelSend); //跳转到删除设备页面
				document.getElementById('codeTime').addEventListener('tap', cancelCode); //获取验证码

			}

			/**
			 * 注销账号
			 */
			function cancelAccount() {
				var Map = {};
				dsBridgeFuncSyn.showLoading();
				CloudSendAjax(localStorage.serverAddress + LAPI.CheckUnregister, 'post', function(code) {
					dsBridgeFuncSyn.dismiss();
					if(code == 200) {
						//隐藏注销详细内容
						$("#placeholderImg").addClass("mui-hidden");
						//显示手机号与获取验证码
						$("#accountInfo").removeClass("mui-hidden");

						$("#back").addClass("mui-hidden");

						$("#back1").removeClass("mui-hidden");
					} else if(code == 2024 || code == 2029) {
						$("#accountInfo").addClass("mui-hidden");
						$("#inputCode").addClass("mui-hidden");
						//显示注销失败背景
						$("#cancelFail").removeClass("mui-hidden");
					} else if(code == 1001 || code == 1002) {
						dsBridgeFuncSyn.setAccountLogoutResult(1);
						dsBridgeFuncSyn.setAccountLogoutResult(0);
					} else {
						showToast(langTip["WEB_search_device_is_added_failed"], code);
					}
				}, Map);

			}

			/**
			 * 返回注销账号内容
			 */
			function backToCancelContent() {
				//隐藏注销详细内容
				$("#placeholderImg").removeClass("mui-hidden");
				//显示手机号与获取验证码
				$("#accountInfo").addClass("mui-hidden");

				$("#back").removeClass("mui-hidden");

				$("#back1").addClass("mui-hidden");
			}

			/**
			 * 获取注销验证码
			 */
			function cancelCode() {
				var headers = {};
				headers["Content-Type"] = 'application/json';
				var map = {
					IsCheckRepeat: false,
					Email: '',
					MobileNum: ''
				}
				var accountType = localStorage.accountType == 1 ? 'Email' : 'MobileNum';
				map[accountType] = localStorage.cloudUserName;
				dsBridgeFuncSyn.showLoading();
				mui.ajax(localStorage.serverAddress + LAPI.GetCode, {
					data: map,
					dataType: "json",
					type: 'post',
					timeout: 10000,
					headers: headers,
					success: function(data, textStatus, xhr) {
						dsBridgeFuncSyn.dismiss();
						if(0 == data.Result) {
							showToast(langTip["WEB_cancel_alSend"]);
							//显示验证码输入框
							$("#back").removeClass("mui-hidden");
							$("#back1").addClass("mui-hidden");
							$("#inputCode").removeClass("mui-hidden");
							$("#accountInfo").addClass("mui-hidden");
							codeTime = 60;
							document.getElementById("codeTime").disabled = true;
							document.getElementById("codeTime").innerText = "60s";
							setTimeout(function() {
								countDown();
							}, 1000);
						} else if(11 == data.Result || 13 == data.Result || 17 == data.Result || 137 == data.Result || 138 == data.Result) {
							showToast("", data.Result);
						} else if(data.Result == 135) {
							showToast(langTip["WEB_err_135"]);
						} else {
							showToast(langTip["WEB_err_17"]);
						}
					},
					error: function(xhr, type, err) {
						dsBridgeFuncSyn.dismiss();
						if((type == "timeout") || (type == "abort")) {
							showToast(langTip["WEB_api_server_is_timeout"]);
						} else {
							showToast(langTip["WEB_err_17"]);
						}
					}
				})
			}

			/**
			 * 验证验证码输入框输入的文字
			 */
			function checkVal() {
				var e1 = document.getElementById('code');
				var e2 = document.getElementById('cancelConfirm');
				e1.value = e1.value.replace(/[^\d]/g, '');

				if(e1.value.length > 0) {
					e2.removeAttribute('disabled')
				} else {
					e2.setAttribute('disabled', true);
				}
				if(e1.value.length > 6) {
					e1.value = oldCode;
				} else {
					oldCode = e1.value;
				}
			}

			/**
			 * 验证输入字符长度
			 */
			function checkVal1() {
				var el = document.getElementById('otherReason');
				if(el.value.length > 128) {
					el.value = oldReason;
				} else {
					oldReason = el.value;
				}
			}

			/**
			 * 注销验证码验证
			 */
			function cancelConfirm() {

				var headers = {};
				headers["Content-Type"] = 'application/json';
				var url = localStorage.serverAddress;
				if(localStorage.accountType == 1) {
					url = url + LAPI.AccountCode.replace(/<Email>/, localStorage.cloudUserName).replace(/<MobileNum>/, '');
				} else {
					url = url + LAPI.AccountCode.replace(/<MobileNum>/, localStorage.cloudUserName).replace(/<Email>/, '');
				}
				url = url.replace(/<Code>/, document.getElementById('code').value);
				dsBridgeFuncSyn.showLoading();
				mui.ajax(url, {
					dataType: "json",
					type: 'get',
					timeout: 10000,
					headers: headers,
					success: function(data) {
						dsBridgeFuncSyn.dismiss();
						if(0 == data.Result) {
							var map = {
								verifyGuid: data.Data.VertifyResultGuid,
								email: '',
								phone: ''
							}
							var accountType = localStorage.accountType == 1 ? 'email' : 'phone';
							map[accountType] = localStorage.cloudUserName;
							CloudSendAjax(localStorage.serverAddress + LAPI.CancelAccount, 'post', function(code) {
								dsBridgeFuncSyn.dismiss();
								if(code == 200) {
									showToast(langTip["WEB_cancel_tip_success"], code);
									dsBridgeFuncSyn.setAccountLogoutResult(1);
									setTimeout(function() {
										$("#accountInfo").addClass("mui-hidden");
										$("#inputCode").addClass("mui-hidden");
										//隐藏返回图标，显示关闭图标
										$("#back").addClass("mui-hidden");
										$("#close").removeClass("mui-hidden");
										$("label").css({
											"float": "left"
										});
										$("#cancelReason").removeClass("mui-hidden");
									}, 800);
								} else if(code == 2024 || code == 2029 || code == 2030) {
									$("#accountInfo").addClass("mui-hidden");
									$("#inputCode").addClass("mui-hidden");
									//显示注销失败背景
									$("#cancelFail").removeClass("mui-hidden");

								} else {
									showToast(langTip["WEB_cancel_fail"], code);
								}
							}, map);
						} else {
							showToast(langTip["WEB_err_26"], data.Result);
						}
					},
					error: function(xhr, type, err) {
						dsBridgeFuncSyn.dismiss();
						if((type == "timeout") || (type == "abort")) {
							showToast(langTip["WEB_api_server_is_timeout"]);
						} else {
							showToast(langTip["WEB_cancel_fail"]);
						}
					}
				})
			}

			/**
			 * 倒计时
			 */
			function countDown() {
				var text;
				text = --codeTime + 's';
				if(codeTime < 0) {
					text = langTip["WEB_cancel_code"];
					document.getElementById("codeTime").disabled = false;
				} else {
					setTimeout(function() {
						countDown();
					}, 1000);
				}
				document.getElementById('codeTime').innerText = text;
			}

			/**
			 * 注销成功跳转登录页
			 */
			function cancel_suc() {
				// TODO：添加告知原生关闭当前页面，跳转至登录页流程
				dsBridgeFuncSyn.setAccountLogoutResult(0);
			}

			/**
			 * 删除设备
			 */
			function delete_device() {
				// TODO：添加告知原生需要删除设备才能注销，跳转至设备列表页面
				dsBridgeFuncSyn.setAccountLogoutResult(-1);
			}

			/**
			 * 发送注销原因
			 */
			function cancelSend() {
				var res = getCheckBoxRes('mui-checkbox');
				var newResson = document.getElementById('otherReason').value;
				if(res.length < 1 && newResson.length < 1) {
					showToast(langTip["WEB_cancel_tip_reason"]);
					return;
				}
				dsBridgeFuncSyn.showLoading();
				var map = {
					reasonList: res,
					description: newResson
				}
				CloudSendAjax(localStorage.serverAddress + LAPI.CancelReason, 'post', function(code) {
					dsBridgeFuncSyn.dismiss();
					cancel_suc();
				}, map);
			}

			function getCheckBoxRes(className) {
				var rdsObj = document.getElementsByClassName(className);
				var checkVal = [];
				for(var i = 0; i < rdsObj.length; i++) {
					var checkObj = rdsObj[i].children[1];
					if(checkObj.checked) {
						checkVal.push(Number(checkObj.value));
					}
				}
				return checkVal;
			}
		</script>
	</body>

</html>