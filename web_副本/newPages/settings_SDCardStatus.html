<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<link href="../css/theme_normal.css" rel="stylesheet" />
		<script src="../js/customSetting.js"></script>
		<style>
			html,
			body,
			.mui-bar-nav~.mui-content {
				height: 100%;
				background: #ffffff;
			}
			
			.ui-status-imgbox {
				float: left;
				height: 100%;
				padding: 16px 25px 16px 42px;
			}
			
			.ui-status-imgbox img {
				height: 100%;
			}
			
			.ui-status-text {
				padding: 9px 0;
			}
			
			.ui-status-text p {
				font-family: simhei;
				font-size: 16px;
				font-weight: 650;
				color: #424242;
				padding: 2px 0;
				margin: 0;
			}
			
			.ui-status-text p:nth-child(2) {
				color: #4d97e4;
			}
			
			.ui-placeholder-full {
				width: 100%;
				height: 100%;
				position: absolute;
				top: 0;
				left: 0;
				background: #ffffff;
			}
			
			.ui-placeholder-imgbox p {
				font-family: simhei;
				text-align: center;
				margin-top: 5px;
				color: #999999;
			}
			
			.ui-infocontain {
				background-color: #ffffff;
			}
			
			.ui-status-textbox {
				background-color: #f3f3f3;
			}
			
			@media all and (orientation:landscape) {
				/*横屏*/
				.ui-infocontain {
					display: flex;
					display: -webkit-flex;
					flex-direction: row;
					padding: 52px 0;
					height: 100%;
				}
				.ui-status-textbox {
					width: 50%;
					height: 69px;
					border-radius: 5px;
					background: #f3f3f3;
					padding-left: 40px;
				}
				.ui-circle-box {
					width: 50%;
					height: 100%;
					padding-left: 50px;
				}
				.ui-placeholder-imgbox {
					width: 60%;
					margin: 0 auto;
					padding: 150px 50px 50px;
				}
				.ui-placeholder-imgbox img {
					width: 100%;
				}
			}
			
			@media all and (orientation: portrait) {
				/*竖屏*/
				.ui-infocontain {
					height: 100%;
					display: flex;
					display: -webkit-flex;
					flex-direction: column;
				}
				.ui-status-textbox {
					height: 69px;
					border-radius: 5px;
					background: #f3f3f3;
					margin: 52px 35px 76px;
				}
				.ui-circle-box {
					width: 60%;
					height: 0;
					padding-bottom: 60%;
					margin: 0 auto;
				}
				.ui-circle-box canvas {
					margin: 0 auto;
					display: block;
				}
				.ui-placeholder-imgbox {
					margin-left: 71px;
					margin-right: 61px;
					margin-top: 197px;
				}
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_device_manager_storage_status">&nbsp;</h1>
		</header>
		<div class="mui-content">
			<div class="ui-infocontain">
				<div id="sdinfo" class="ui-status-textbox mui-hidden">
					<div class="ui-status-imgbox">
						<img id="storage-icon" src="../images/ezView/iocn@3x.png" alt="" />
					</div>
					<div class="ui-status-text">
						<p id="total">&nbsp;</p>
						<p id="remain">&nbsp;</p>
					</div>
				</div>
				<div id="circlebox" class="ui-circle-box">
					<canvas id="circle" width="60" height="60"></canvas>
				</div>
			</div>

			<div id="placeholderImg" class="ui-placeholder-full mui-hidden">
				<div class="ui-placeholder-imgbox">
					<img alt="" />
					<p id="placeholderTxt">&nbsp;</p>
				</div>
			</div>
		</div>
		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/libs/sha2.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/loadCss.js"></script>
    <script id="langScript"></script>
		<script>
			var langTip;
			canvas = document.getElementById("circle");
			var total = document.getElementById("total");
			var remain = document.getElementById("remain");
			var TotalMemory = 0;
			var SpareMemory = 0;
			checkType(localStorage.AppType); //加载特定样式
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;
			setTimeout(function() {
				initData();
			}, 500);

			function initData() {
				//调接口获取数据初始化界面
				//先判断是否有SD卡然后，若有则调状态接口
				SendAjax(LAPI.StatusSD, 'get', function(code, data) {
					if(code == 0) {
						switch(data.StatusParam.SDStatus) {
							case 0:
								dsBridgeFuncSyn.dismiss();
								showPlaceholderImg(langTip["WEB_web_sd_noSD"]);
								break;
							case 1:
								dsBridgeFuncSyn.dismiss();
								showPlaceholderImg(langTip["WEB_web_sd_errSD"]);
								break;
							case 2:
								dsBridgeFuncSyn.dismiss();
								showPlaceholderImg(langTip["WEB_web_sd_noformatSD"]);
								break;
							case 3:
								SendAjax(LAPI.Storage, 'get', function(code, data) {
									dsBridgeFuncSyn.dismiss();
									if(code == 0) {
										for(var i = 0; i < data.StorageResource.Nums; i++) {
											TotalMemory = TotalMemory + data.StorageResource.MemInfos[i].TotalMemory;
											SpareMemory = SpareMemory + data.StorageResource.MemInfos[i].SpareMemory;
										}
										if(data.StorageResource.StorageType != 0 || (data.StorageResource.StorageType == 0 && TotalMemory == 0)) {
											showPlaceholderImg(langTip["WEB_sd_without"]);
											return;
										}
										document.getElementById("sdinfo").classList.remove("mui-hidden");
										total.innerText = langTip["WEB_sd_total_capacity"] + ":" + TotalMemory + "MB";
										remain.innerText = langTip["WEB_sd_capacity_usable"] + ":" + SpareMemory + "MB";
										if(localStorage.AppType == '1' || localStorage.AppType == '3') {
											remain.style.color = '#50d0c1';
										} else if(localStorage.AppType == '2') {
											remain.style.color = '#5BD5C7';
										}
										var store = ((TotalMemory - SpareMemory) / TotalMemory * 100).toFixed(2);
										console.log('store', store);
										var startColor = "#5ba7f6";
										var bColor = "#deedfd";
										var endClor = "#bbe3ff";
										if(localStorage.AppType == '1' || localStorage.AppType == '3') {
											var startColor = "#4ad0c5";
											var bColor = "#dbf6f3";
											var endClor = "#c0ffe4";
											document.getElementById('remain').style.color = '#4ad0c5'
											document.getElementById('storage-icon').setAttribute('src', '../images/ezLive/iocn@3x.png')
										} else if(localStorage.AppType == '2') {
											var startColor = "#40acd4";
											var bColor = "#ddf2f7";
											var endClor = "#a5e2eb";
											document.getElementById('remain').style.color = '#53BDD5'
											document.getElementById('storage-icon').setAttribute('src', '../images/uniarch/iocn@3x.png')
										}
										if(store >= 90) {
											startColor = "#f85350";
											endClor = "#ffbca8";
											bColor = "#fddfdf";
										}
										drawMain(canvas, store, startColor, endClor, bColor);
									} else {
										showPlaceholderImg(langTip["WEB_networkerror_text"]);
										showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
									}
								});
								break;
							default:
								dsBridgeFuncSyn.dismiss();
								showPlaceholderImg(langTip["WEB_api_error_operation_fails"]);
						}
					} else {
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						addBitmap(0);
						dsBridgeFuncSyn.dismiss();
					}
				});

			}
			/*
			 *@drawing_elem: 绘制对象
			 *@percent：绘制圆环百分比, 范围[0, 100]
			 *@forecolor1: 绘制圆环的前景色渐变开始，颜色代码
			 *@forecolor2: 绘制圆环的前景色渐变结束，颜色代码
			 *@bgcolor: 绘制圆环的背景色，颜色代码
			*/
			function drawMain(drawing_elem, percent, forecolor1, forecolor2, bgcolor) {
				var context = drawing_elem.getContext("2d");
				var circleboxWidth = document.getElementById("circlebox").offsetWidth;
				var circleboxHeight = document.getElementById("circlebox").offsetHeight;
				var canvasWidth;
				var canvasHeight;
				if(circleboxWidth > circleboxHeight) {
					canvasWidth = circleboxHeight;
					canvasHeight = circleboxHeight;
				} else {
					canvasWidth = circleboxWidth;
					canvasHeight = circleboxWidth;
				}
				var ratio = getPixelRatio(context);
				canvas.width = canvasWidth * ratio;
				canvas.height = canvasHeight * ratio;
				canvas.style.width = canvasWidth + 'px';
				canvas.style.height = canvasWidth + 'px';
				var center_x = canvas.width / 2;
				var center_y = canvas.height / 2;
				var rad = Math.PI * 2 / 100;
				var speed = 0;

				/*
				 *	绘制背景圆圈
				 * */
				function backgroundCircle() {
					context.save();
					context.beginPath();
					context.lineWidth = 16 * ratio; //设置线宽
					var radius = center_x - context.lineWidth;
					context.lineCap = "round";
					context.strokeStyle = bgcolor;
					context.arc(center_x, center_y, radius, 0, Math.PI * 2, false);
					context.scale(1.2, 1.2);
					context.stroke();
					context.closePath();
					context.restore();
				}
				/*
				 *绘制运动圆环
				 * n{Number}:进度
				 * */
				function foregroundCircle(n) {
					var s = 0;
					if(n > 25) {
						s = n - 25;
						foregroundCircle2(n);
					} else {
						foregroundCircle2(n);
						return;
					}
					var startRad = -Math.PI / 2;
					var endRad = -Math.PI / 2 + s * rad;
					context.save();
					context.strokeStyle = forecolor1;
					context.lineWidth = 16 * ratio;
					context.lineCap = "round";
					var radius = center_x - context.lineWidth;
					context.beginPath();
					context.arc(center_x, center_y, radius, startRad, endRad, false); //用于绘制圆弧context.arc(x坐标，y坐标，半径，起始角度，终止角度，顺时针/逆时针)
					context.stroke();
					context.closePath();
					context.restore();
				}
				/*
				 *绘制运动圆环
				 * n{Number}:进度
				 * */
				function foregroundCircle2(n) {
					var s = 0;
					var startRad = -Math.PI / 2;
					var endRad = -Math.PI / 2 + n * rad;
					var x1 = getX(endRad - 20 * rad),
						y1 = getY(endRad - 20 * rad),
						x2 = getX(endRad),
						y2 = getY(endRad);
					if(n < 25 || n == 25) {
						x1 = getX(startRad);
						y1 = getY(startRad)
					};
					var g = context.createLinearGradient(x1, y1, x2, y2); //创建渐变对象  渐变开始点和渐变结束点
					g.addColorStop(0, forecolor1); //添加颜色点
					g.addColorStop(1, forecolor2); //添加颜色点

					context.save();
					context.strokeStyle = g; //使用渐变对象作为圆环的颜色
					context.lineWidth = 16 * ratio;
					context.lineCap = "round";
					var radius = center_x - context.lineWidth;
					context.beginPath();
					context.arc(center_x, center_y, radius, startRad, endRad, false); //用于绘制圆弧context.arc(x坐标，y坐标，半径，起始角度，终止角度，顺时针/逆时针)
					context.stroke();
					context.closePath();
					context.restore();
				}

				/*
				 *绘制文字
				 * n{Number}:位置
				 * */
				function text(n) {
					var n = 100 - n;
					if((n % parseInt(n)) == 0) {
						n = n.toFixed(0);
					} else {
						n = n.toFixed(2);
					}
					context.save(); //save和restore可以保证样式属性只运用于该段canvas元素
					context.fillStyle = forecolor1;
					var font_size1 = 35 * ratio;
					context.font = font_size1 + "px simhei";
					var text_width = context.measureText(n + "%").width;
					context.fillText(n + "%", center_x - text_width / 2, center_y);
					font_size2 = 16 * ratio;
					var text2 = langTip["WEB_sd_available"];
					context.font = font_size2 + "px simhei";
					var text2_width = context.measureText(text2).width;
					context.fillText(text2, center_x - text2_width / 2, center_y + font_size2 * 1.5);
					context.restore();
				}

				function getX(Rad) {
					var A = 0;
					var x = 0;
					if(Rad >= -(Math.PI / 2) && Rad <= Math.PI / 2) {
						A = Math.abs(Rad);
						x = center_x * Math.cos(A) + center_x;
					} else if(Rad >= (Math.PI / 2) && (Rad <= (Math.PI / 2) * 3)) {
						A = Math.abs(Math.PI - Rad);
						x = center_x - center_x * Math.cos(A);
					} else if(Rad >= 0 && Rad <= Math.PI) {
						A = Math.abs(Math.PI - Rad);
						x = center_x - center_x * Math.cos(A);
					}
					return x;
				}

				function getY(Rad) {
					var A = 0;
					var y = 0;
					if(Rad >= 0 && Rad <= Math.PI) {
						A = Math.abs(Rad - Math.PI / 2);
						y = center_y * Math.cos(A) + center_y;
					} else if(Rad >= Math.PI && Rad <= (Math.PI / 2) * 3) {
						A = Math.abs((Math.PI / 2) * 3 - Rad);
						y = center_y - center_y * Math.cos(A);
					} else if(Rad <= 0 && Rad >= -(Math.PI / 2)) {
						A = Math.abs((Math.PI / 2) + Rad);
						y = center_y - center_y * Math.cos(A);
					}
					return y;
				}

				/**
				 * 执行动画
				 */
				(function drawFrame() {
					window.requestAnimationFrame(drawFrame);
					context.clearRect(0, 0, drawing_elem.width, drawing_elem.height);
					backgroundCircle();
					text(speed);
					foregroundCircle(speed);
					if(speed >= percent) return;
					if(percent - speed >= 5) {
						speed += 5;
					} else if(percent - speed < 5 && percent - speed >= 1) {
						speed += 1;
					} else if(percent - speed < 1 && percent - speed >= 0.1) {
						speed += 0.1;
					} else {
						speed += 0.01;
					}
				}());
			}

			function getPixelRatio(context) {
				var backingStore = context.backingStorePixelRatio ||
					context.webkitBackingStorePixelRatio ||
					context.mozBackingStorePixelRatio ||
					context.msBackingStorePixelRatio ||
					context.oBackingStorePixelRatio ||
					context.backingStorePixelRatio || 1;
				return(window.devicePixelRatio || 1) / backingStore;
			};

			/**
			 * 显示占位图
			 * @param {Object} txt
			 */
			function showPlaceholderImg(txt) {
				var placeholderImg = document.getElementById("placeholderImg");
				var placeholderTxt = document.getElementById("placeholderTxt");
				placeholderImg.classList.remove("mui-hidden");
				placeholderTxt.innerText = txt;
			}
		</script>
	</body>

</html>