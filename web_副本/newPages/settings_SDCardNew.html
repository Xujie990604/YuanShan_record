<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<link href="../css/theme_normal.css" rel="stylesheet" />
		<style>
			.mui-radio input[type='radio']:checked:before {
				content: '\e442';
			}
			.sd-card-name {
				display: flex;
				flex-direction: row;
				justify-content: space-between;
				font-size: 18px;
				color: #333333;
			}
			
			.sd-card-status {
				display: flex;
				flex-direction: row;
				align-items: center;
				font-size: 12px;
			}
			
			.sd-card-status-circle {
				width: 8px;
				height: 8px;
				border-radius: 50%;
			}
			.mui-card {
				box-shadow: none;
			}
			
			.normal-color {
				color: #93E283;
			}
			
			.abnormal-color {
				color: #EE5D5D;
			}
			
			.unformatted-color {
				color: #EEA55D;
			}
			
			.normal-color-circle {
				background-color: #93E283;
			}
			
			.abnormal-color-circle {
				background-color: #EE5D5D;
			}
			
			.unformatted-color-circle {
				background-color: #EEA55D;
			}
			
			.sd-card-status-circle {
				margin-right: 8px;
			}
			
			.sd-card-status-text {
				font-size: 12px;
			}
			
			.sd-card-capacity-title {
				font-size: 16px;
				color: rgba(51, 51, 51, 0.7);
			}
			
			.mui-progressbar {
				height: 8px;
				border-radius: 4px;
				background: rgba(51, 51, 51, 0.08);
			}
			
			.mui-progressbar span {
				background: #50D0C1;
			}
			
			.sd-card-info-detail {
				color: rgba(51, 51, 51, 0.4);
				display: flex;
				justify-content: space-between;
				padding-top: 6px;
			}
			
			.sd-card-capacity {
				padding-top: 6px;
			}
			
			.sd-card-capacity-title {
				padding-bottom: 8px;
			}
			
			.mui-card {
				margin-bottom: 6px;
				padding-left: 5px;
			}
			
			.SDcard-title-style {
				font-size: 14px;
				padding-top: 5px;
				padding-bottom: 8px;
				padding-left: 10px;
				color: #000000;
				opacity: 0.4;
			}
			
			#SDSettingUl {
				margin-top: 0px;
				margin-bottom: 0px;
			}
			
			.padding-left-15 {
				padding-left: 0px;
			}
			
			#formatUl {
				margin-top: 44px;
			}
      
      .card-background {
        margin-left: 16px;
        margin-right: 16px;
        border-radius: 8px;
        padding: 1px 0px;
				background-color: white;
      }
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_sd_config">&nbsp;</h1>
		</header>
		<div class="mui-content">
			<div id="EZView-content" class="mui-hidden">
				<div class="SDcard-title-style mui-hidden" id="SDSettingUlTip" data-text="WEB_SDCardConfig">
					&nbsp;
				</div>
				<ul class="mui-table-view mui-hidden" id="SDSettingUl">
					<li id="setSDcard" class="mui-table-view-cell" style="padding-left:30px;">
						<span data-text="WEB_Full_Coverage" class="mainStyle padding-left-15">&nbsp;</span>
						<div id="setSDcardSwitch" class="mui-switch mui-switch-mini">
							<div class="mui-switch-handle" id="setSDcardCircle"></div>
						</div>
						<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
					</li>

					<li class="mui-table-view-cell" id="setImageVivid">
						<a id="ImageVivid" class="mui-navigate-right">&nbsp;
							<span data-text="WEB_Image_vivid" class="mainStyle padding-left-15">&nbsp;</span>
							<span class="mui-badge"></span>
						</a>
					</li>
				</ul>
				<ul id="VideoPlan" class="mui-table-view ui-siwtchlist">
					<li class="mui-table-view-cell" id="setType">
						<a href="#VideoType" id="resetType" class="mui-navigate-right">&nbsp;
							<span data-text="WEB_record_type" class="mainStyle">&nbsp;</span>
							<span id="VideoTypeVal" class="mui-badge">&nbsp;</span>
						</a>
						<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
					</li>
					<li class="mui-table-view-cell mui-hidden" id="showDate">
						<a href="#VideoDate" id="resetDate" class="mui-navigate-right">&nbsp;
							<span data-text="WEB_device_manager_record_schedule" class="mainStyle">&nbsp;</span>
							<span id="VideoDateVal" class="mui-badge">&nbsp;</span>
						</a>
						<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
					</li>
				</ul>
				<ul class="mui-table-view ui-siwtchlist" id="formatUl">
					<li class="mui-table-view-cell" id="format">
						<a>
							<span class="ui-devicereboot" data-text="WEB_sd_format">&nbsp;</span>
						</a>
					</li>
				</ul>
			</div>
					<!--录像类型弹框-->
		<div id="VideoType" class="mui-popover mui-popover-action mui-popover-bottom ui-radio-list">
			<form class="mui-input-group">
				<div class="mui-input-row mui-checkbox ui-list-titile" id="swipedownDiv2">
					<label data-text="WEB_record_type">&nbsp;</label>
				</div>
				<div id="VideoTypeList" class="VideoTypeList">
					<div class="mui-input-row mui-radio">
						<label data-text="WEB_ScheduledRecording"></label>
						<input name="radio1" value="0" type="radio">
					</div>
					<div class="mui-input-row mui-radio" id="eventDetection">
						<label data-text="WEB_EventRecording">&nbsp;</label>
						<input name="radio1" value="2" type="radio">
					</div>
				</div>
			</form>
			<button id="VideoTypeOk" class="mui-btn mui-btn-block ui-dateok" data-text="WEB_button_ok">&nbsp;</button>
		</div>
		</div>

		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/libs/sha2.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/loadCss.js"></script>
    <script id="langScript"></script>
		<script>
			var langTip;
			checkType(localStorage.AppType); //加载特定样式
			var SDCardNum = 1;
			var StoreStrategy;
			var sendUrl;
			var SDcardServiceData;
			var coverObjs ; // 拷贝录像策略数据
			var storeData ; // 拷贝存储计划数据
			var VideoTypeCheckedID = -1; // 录像类型下发参数
			var VideoTypeChecked = ''; 
			// IPC录像计划
			var sportcheck;
			var isAuto = true;
			var CheckTimeServiceData;// 录像计划时间数据
			var editionFlag = false; //SDk版本是否大于1.9.0，大于1.9.0使用新接口
			mui.init();
			var oldStatus;
			var typeLan = initLang();
			langTip = typeLan.lang;
			//根据设备版本号判断是否支持SD卡新接口
			var devVersionNumberList = ["GIHOS-B2101.2.3.220905", "GIHOS-B2101.2.2.220810", "GIHOS-B2101.2.1.220802", "GIHOS-B2101.2.0.220713", "GIHOS-B2101.1.5.220712"];
			if(devVersionNumberList.indexOf(localStorage.versionNumber) == -1) {
				if(localStorage.sdkVer && (localStorage.versionNumber.indexOf("CIPC-B2303") == -1)) {
					if(judgeSDkVersion("1.9.0")) {
						editionFlag = true;
					}
				}
			}
			if(editionFlag) {
					sendUrl = LAPI.StoreStrategy;
				} else {
					sendUrl = LAPI.Storage;
				}

			if(editionFlag) {
				initPageNew();
				initDataNew();
				initEventNew();
			} else {
				initPageOld();
				initDataOld();
				initEventOld();
			}
        
			function initPageOld() {
				//门铃设备暂不支持图像清晰度配置
				if(localStorage.dvt == 100) {
					document.getElementById("setImageVivid").classList.add("mui-hidden")
				}
				initSD();

			}
            // 初始化录像类型
			function initStorageMode(data) {
				coverObjs = deepCopy(data);
				initPlanCheck();

			}

			/*
			 * IPC  发请求获取录像计划数据初始化
			 */
			 function initPlanCheck() {
				SendAjax(LAPI.RecordScheduleInfo, 'get', function(code, data) {
					if(code == 0) {
						CheckTimeServiceData = deepCopy(data);
						sportcheck = data.Enabled;
						if(editionFlag) {
							if(coverObjs.RecordStrategy.StoreEnabled == 0) { //手动存储，显示全部录像和每天
								isAuto = false;
								VideoTypeCheckedID = 0;
								document.getElementById("VideoTypeVal").innerText = langTip["WEB_ScheduledRecording"];
								document.getElementById("showDate").classList.remove('mui-hidden');
							} else { //计划存储
								isAuto = true;
								if(sportcheck == 1) { //全部录像
									VideoTypeCheckedID = 0;
									document.getElementById("showDate").classList.remove('mui-hidden');
									document.getElementById("VideoTypeVal").innerText = langTip["WEB_ScheduledRecording"];
								} else { //报警录像
									VideoTypeCheckedID = 2;
									document.getElementById("VideoTypeVal").innerText = langTip["WEB_EventRecording"];
								}
							}
						} else {
							if(coverObjs.VideoStorage.StorageMode == 10 && sportcheck == 0) { //手动存储，显示全部录像和每天
								VideoTypeCheckedID = 0;
								isAuto = false;
								document.getElementById("VideoTypeVal").innerText = langTip["WEB_ScheduledRecording"];
								document.getElementById("showDate").classList.remove('mui-hidden');
							} else { //计划存储
								isAuto = true;
								if(sportcheck == 1) { //全部录像
									VideoTypeCheckedID = 0;
									document.getElementById("showDate").classList.remove('mui-hidden');
									document.getElementById("VideoTypeVal").innerText = langTip["WEB_ScheduledRecording"];
								} else { //报警录像
									VideoTypeCheckedID = 2;
									document.getElementById("VideoTypeVal").innerText = langTip["WEB_EventRecording"];
								}
							}
						}
						// getRecordInfo(data);
						dsBridgeFuncSyn.dismiss();
					} else {
						// //数据获取失败的处理

						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						addBitmap(0);
						dsBridgeFuncSyn.dismiss();
					}
				});
			}

				// 录像类型确定按钮
			  document.getElementById('VideoTypeOk').addEventListener('tap', function() {
					mui('#VideoType').popover('toggle');
					var typeAlls = document.querySelectorAll('#VideoTypeList input');
					for(var i = 0; i < typeAlls.length; i++) {
						if(typeAlls[i].checked) {
							VideoTypeCheckedID = Number(typeAlls[i].value);
							VideoTypeChecked = typeAlls[i].previousElementSibling.innerHTML;
						  }
					    }
						if(VideoTypeCheckedID == 2) {
							sportcheck = 0;
							// document.getElementById("showDate").classList.add("mui-hidden");
						} else {
							sportcheck = 1;
							// document.getElementById("showDate").classList.remove("mui-hidden");
						}
						// document.getElementById('VideoTypeVal').innerText = VideoTypeChecked;
						if(editionFlag) {
							if(coverObjs.RecordStrategy.StoreEnabled == 0) {
								coverObjs.RecordStrategy.StoreEnabled = 1;
								SendAjax(sendUrl, 'put', function(code, data) {
								if(code == 0) {
									isAuto = true;
									if(sportcheck == 1){
										document.getElementById("showDate").classList.remove("mui-hidden");
									} else{
										document.getElementById("showDate").classList.add("mui-hidden");
									}
									showToast(langTip["WEB_logcat_save_successful"]);
									document.getElementById('VideoTypeVal').innerText = VideoTypeChecked;
								} else {
									showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
								}
							}, coverObjs);
							}
						} else {
							if(coverObjs.VideoStorage.StorageMode == 10 && sportcheck == 0) {
								coverObjs.VideoStorage.StorageMode = 11;
								SendAjax(sendUrl, 'put', function(code, data) {
								if(code == 0) {
									isAuto = true;
									if(sportcheck == 1){
										document.getElementById("showDate").classList.remove("mui-hidden");
									} else{
										document.getElementById("showDate").classList.add("mui-hidden");
									}
									showToast(langTip["WEB_logcat_save_successful"]);
									document.getElementById('VideoTypeVal').innerText = VideoTypeChecked;
								} else {
									showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
								}
							}, coverObjs);
							}
					    }

					if(CheckTimeServiceData.Enabled != sportcheck) {
						dsBridgeFuncSyn.showLoading();
					    setPlanCheck()
					}
				}, false);




			function setPlanCheck() {
				// var sendDataON = deepCopy(CheckTimeServiceData);
				CheckTimeServiceData.Enabled = sportcheck;
				// sportcheck = sendData.Enabled;
				// CheckTimeServiceData.Enabled
				SendAjax(LAPI.RecordScheduleInfo, 'put', function(code, data) {
					dsBridgeFuncSyn.dismiss();
					if(code == 0) {
						if(sportcheck == 1){
							document.getElementById("showDate").classList.remove("mui-hidden");
						} else{
							document.getElementById("showDate").classList.add("mui-hidden");
						}
						showToast(langTip["WEB_logcat_save_successful"]);
						document.getElementById('VideoTypeVal').innerText = VideoTypeChecked;
					} else {
							showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
					  }
				}, CheckTimeServiceData)
			}

				// 录像类型选择
			    document.getElementById('resetType').addEventListener('tap', function() {
					var TypeAlls = document.querySelectorAll('#VideoTypeList input');
					for(var i = 0; i < TypeAlls.length; i++) {
						if(VideoTypeCheckedID == 0) {
							TypeAlls[0].checked = true;
						} else if(VideoTypeCheckedID == -1) {
							TypeAlls[i].checked = false;
						} else if(VideoTypeCheckedID == 2) {
							TypeAlls[1].checked = true;
						}
					}
				})
			function initDataOld() {

			}

			function initEventOld() {
				document.getElementById("format").addEventListener("tap", formatStorage); //格式化点击事件
				document.getElementById("ImageVivid").addEventListener("tap", ImageVivid); //图像清晰度点击事件
				document.getElementById("resetDate").addEventListener("tap", function(){
				var Extras = {
					isAuto:isAuto,
					coverObjs:coverObjs
				}
				// 页面跳转+传参
				jumpToWebPage("settings_VideoPlan", JSON.stringify(Extras))
				}); 
			}

			function initPageNew() {

			}

			function initDataNew() {
				if(localStorage.dvt == 100) {
					document.getElementById("setImageVivid").classList.add("mui-hidden")
				}
				initNewSD();
			}

			function initEventNew() {
				document.getElementById("format").addEventListener("tap", formatStorage); //格式化点击事件
				document.getElementById("ImageVivid").addEventListener("tap", ImageVivid); //图像清晰度点击事件
				document.getElementById("resetDate").addEventListener("tap", function(){
				var Extras = {
					isAuto:isAuto,
					coverObjs:coverObjs
				}
				// 页面跳转+传参
				jumpToWebPage("settings_VideoPlan", JSON.stringify(Extras))
				}); 

			}

			function getCapaticyGB(capacity) {
				return Math.round(capacity / 1024 * 100) / 100 + "GB";
			}

			function initSDCardList(status, totalCapacity, remainCapatity, index) {
				var par = document.getElementById("EZView-content");
				var Sibling = document.getElementById("SDSettingUlTip");
				var SDCardInfoDiv = document.createElement("div");
				SDCardInfoDiv.id = "SDCardInfo" + index;
				var SDCardIndexDiv = document.createElement("div");
				SDCardIndexDiv.className = "SDcard-title-style";
				SDCardIndexDiv.innerText = langTip["WEB_SDCardCapacity"];
				var SDCardBack = document.createElement("div");
				SDCardBack.className = "card-background";
				var muiCardDiv = document.createElement("div");
				muiCardDiv.className = "mui-card";
				var muiCardDivContent = document.createElement("div");
				muiCardDivContent.className = "mui-card-content";
				var sdCardNamediv = document.createElement("div");
				sdCardNamediv.className = "sd-card-name";
				var sdCardNameDetaildiv = document.createElement("div");
				sdCardNameDetaildiv.innerText = langTip["WEB_SDCardNum"].replace("%s", SDCardNum);
				SDCardNum++;
				var sdCardStatusDiv = document.createElement("div");
				sdCardStatusDiv.className = "sd-card-status";
				var statusCircle = document.createElement("div");
				var statusText = document.createElement("div");
				statusCircle.className = "sd-card-status-circle";

				switch(status) {
					case "normal":
						sdCardStatusDiv.classList.add("normal-color");
						statusCircle.classList.add("normal-color-circle");
						statusText.innerText = langTip["WEB_normal"];
						break;
					case "abnormal":
						sdCardStatusDiv.classList.add("abnormal-color");
						statusCircle.classList.add("abnormal-color-circle");
						statusText.innerText = langTip["WEB_abnormal"];
						break;
					case "unformatted":
						sdCardStatusDiv.classList.add('unformatted-color');
						statusCircle.classList.add("unformatted-color-circle");
						statusText.innerText = langTip["WEB_unformatted"];
						break;
					default:
						break;
				}
				if(status == "normal") {
					var sdCardCapacityDiv = document.createElement("div");
					sdCardCapacityDiv.className = "sd-card-capacity";
					var muiProgressbarDiv = document.createElement("div");
					muiProgressbarDiv.className = "mui-progressbar";
					muiProgressbarDiv.id = "progressbar" + index;
					var muiProgressbarSpan = document.createElement("span");
					muiProgressbarDiv.appendChild(muiProgressbarSpan);
					sdCardCapacityDiv.appendChild(muiProgressbarDiv);
				}

				sdCardStatusDiv.appendChild(statusCircle);
				sdCardStatusDiv.appendChild(statusText);
				sdCardNamediv.appendChild(sdCardNameDetaildiv);
				sdCardNamediv.appendChild(sdCardStatusDiv);

				if(status == "normal") {
					var sdCardInfoDetail = document.createElement("div");
					sdCardInfoDetail.className = "sd-card-info-detail";
					var usedDiv = document.createElement("div");
					var remainedDiv = document.createElement("div");
					usedDiv.innerText = langTip["WEB_used"] + getCapaticyGB(totalCapacity - remainCapatity) + "/" + getCapaticyGB(totalCapacity);
					var remainText;
					if(remainCapatity >= 1024) {
						remainText = getCapaticyGB(remainCapatity);
					} else {
						remainText = remainCapatity + "MB";
					}
					remainedDiv.innerText = langTip["WEB_remains"] + remainText;
					sdCardInfoDetail.appendChild(usedDiv);
					sdCardInfoDetail.appendChild(remainedDiv);
				}

				muiCardDivContent.appendChild(sdCardNamediv);
				if(status == "normal") {
					muiCardDivContent.appendChild(sdCardCapacityDiv);
					muiCardDivContent.appendChild(sdCardInfoDetail);
				}

				muiCardDiv.appendChild(muiCardDivContent);
				SDCardBack.appendChild(muiCardDiv);

				SDCardInfoDiv.appendChild(SDCardIndexDiv);
				SDCardInfoDiv.appendChild(SDCardBack);

				par.insertBefore(SDCardInfoDiv, Sibling);
				if(status == "normal") {
					var actualProgress = (totalCapacity - remainCapatity) / totalCapacity * 100;
					console.log(mui("#" + SDCardInfoDiv.id + " mui-progressbar"));
					mui("#" + muiProgressbarDiv.id).progressbar({
						progress: actualProgress
					}).show();
				}
			}

			function initSD() {
				SendAjax(LAPI.StatusSD, "get", function(code, data) {
					if(code == 0) {

						switch(data.StatusParam.SDStatus) {
							case 0:
								addBitmap(2, langTip["WEB_NoSDCard"]);
								dsBridgeFuncSyn.dismiss();
								break;
							case 1:
								oldStatus = "unformatted";
								$("#EZView-content").removeClass("mui-hidden");
								initSDCardList(oldStatus, 0, 0, 0);
								dsBridgeFuncSyn.dismiss();
								//								initSDcardData();
								break;
							case 2:
								oldStatus = "abnormal";
								$("#EZView-content").removeClass("mui-hidden");
								initSDCardList(oldStatus, 0, 0, 0);
								dsBridgeFuncSyn.dismiss();
								//								initSDcardData();
								break;
							case 3:
								oldStatus = "normal";
								$("#SDSettingUl").removeClass("mui-hidden");
								$("#SDSettingUlTip").removeClass("mui-hidden");
								initSDcardData();
								break;
							default:
								oldStatus = "abnormal";
								$("#EZView-content").removeClass("mui-hidden");
								initSDCardList(oldStatus, 0, 0, 0);
								dsBridgeFuncSyn.dismiss();
								//								initSDcardData();
								break;

						}
					} else {
						//数据获取失败的处理
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						addBitmap(0);
						dsBridgeFuncSyn.dismiss();
					}
				})
			}

			function initNewSD() {
				SendAjax(LAPI.StorageDetailInfos, "get", function(code, data) {
					if(code == 0) {
						if(data.SDNum > 0) {
							var isNoSDCard = true;
							if(data.SDNum > 0) {
								for(var i = 0; i < data.SDNum; i++) {
									if(data.SDList[i].Status != 0) {
										isNoSDCard = false;
									}
								}
							}
							if(isNoSDCard) {
								addBitmap(2, langTip["WEB_NoSDCard"]);
								dsBridgeFuncSyn.dismiss();
							} else {
								var isHaveNomalSD = false;
								for(var i = 0; i < data.SDNum; i++) {
									if(data.SDList[i].Status != 0) {
										if(data.SDList[i].Status == 3) {
											isHaveNomalSD = true;
										}
										var sdStatus = getNewSdCardStatus(data.SDList[i].Status);
										initSDCardList(sdStatus, data.SDList[i].TotalCapacity, data.SDList[i].RemainCapacity, i);
									}
								}
								if(isHaveNomalSD) {
									initNewFullCoverage();
								} else {
									dsBridgeFuncSyn.dismiss();
									$("#EZView-content").removeClass("mui-hidden");
								}
							}
						} else {
							addBitmap(2, langTip["WEB_NoSDCard"]);
							dsBridgeFuncSyn.dismiss();
						}
					} else {
						//数据获取失败的处理
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						addBitmap(0);
						dsBridgeFuncSyn.dismiss();
					}
				})
			}

			function getNewSdCardStatus(statusNum) {
				switch(statusNum) {
					case 1:
						return "unformatted";
						break;
					case 2:
					case 5:
						return "abnormal";
						break;
					case 3:
						$("#SDSettingUl").removeClass("mui-hidden");
						$("#SDSettingUlTip").removeClass("mui-hidden");
						return "normal";
						break;
					default:
						return "abnormal";
						break;
				}
			}

			function initNewFullCoverage() {
				SendAjax(LAPI.StoreStrategy, "get", function(code, data) {
					if(code == 0) {
						StoreStrategy = JSON.parse(JSON.stringify(data));
						var status = StoreStrategy.RecordStrategy.FullStrategy == 0 ? 1 : 0;
						setFullCoverage(status);
                        initStorageMode(data);
						$("#EZView-content").removeClass("mui-hidden");
						dsBridgeFuncSyn.dismiss();
					} else {
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						addBitmap(0);
						dsBridgeFuncSyn.dismiss();
					}
				})
			}

			function initSDcardData() {
				SendAjax(LAPI.Storage, "get", function(code, data) {
					if(code == 0) {
						var TotalMemory = 0;
						var SpareMemory = 0;
						for(var i = 0; i < data.StorageResource.Nums; i++) {
							TotalMemory = TotalMemory + data.StorageResource.MemInfos[i].TotalMemory;
							SpareMemory = SpareMemory + data.StorageResource.MemInfos[i].SpareMemory;
						}
						if(data.StorageResource.StorageType != 0 || (data.StorageResource.StorageType == 0 && TotalMemory == 0)) {
							addBitmap(2, langTip["WEB_sd_without"]);
							return;
						}
						$("#EZView-content").removeClass("mui-hidden");
						SDcardServiceData = deepCopy(data);
						overStoreCheck = data.VideoStorage.StoragePolicy;
						setFullCoverage(overStoreCheck);
						initStorageMode(data);
						// coverObj = data;
						initSDCardList(oldStatus, TotalMemory, SpareMemory, 0);
						dsBridgeFuncSyn.dismiss();
					} else {
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						addBitmap(0);
						dsBridgeFuncSyn.dismiss();
					}
				})
			}
			/*
			 * 配置满覆盖按钮状态
			 * */
			function setFullCoverage(overStoreCheck) {
				document.getElementById("setSDcardSwitch").style.zIndex = 20;
				document.getElementById("setSDcardSwitch").style.visibility = "visible";
				setSDcardConfirm = false;
				setSwitchStatus("setSDcardSwitch", overStoreCheck);
				setSDcardConfirm = true;
				var setSDcardActive = document.getElementById("setSDcardSwitch").classList.contains("mui-active")
				if(setSDcardActive) {
					document.getElementById("setSDcardCircle").style.transform = "translate(16px, 0px)";
				}
			}
			/*
			 *  监听满覆盖开关
			 */
			document.getElementById("setSDcardSwitch").addEventListener("toggle", function(event) {
				if(event.detail.isActive && setSDcardConfirm) {
					var sendUrl;
					var sendDataON;
					if(editionFlag) {
						sendDataON = deepCopy(StoreStrategy);
						sendDataON.RecordStrategy.FullStrategy = 0;
						StoreStrategy.RecordStrategy.FullStrategy = 0;
						sendUrl = LAPI.StoreStrategy;
					} else {
						sendDataON = deepCopy(SDcardServiceData);
						sendDataON.VideoStorage.StoragePolicy = 1;
						SDcardServiceData.VideoStorage.StoragePolicy = 1 ;
						sendUrl = LAPI.Storage;
					}
					dsBridgeFuncSyn.showLoading();
					SendAjax(sendUrl, "put", function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {

						} else {
							setSDcardConfirm = false;
							showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
							setTimeout(function() {
								mui("#setSDcardSwitch").switch().toggle();
							}, 200)
						}
					}, sendDataON)
				} else if(!event.detail.isActive && setSDcardConfirm) {
					var sendUrl;
					var sendDataOFF;
					if(editionFlag) {
						sendDataOFF = deepCopy(StoreStrategy);
						sendDataOFF.RecordStrategy.FullStrategy = 1;
						StoreStrategy.RecordStrategy.FullStrategy = 1 // 保证下发录像类型时不会覆盖满覆盖的数据
						sendUrl = LAPI.StoreStrategy;
					} else {
						sendDataOFF = deepCopy(SDcardServiceData);
						sendDataOFF.VideoStorage.StoragePolicy = 0;
						SDcardServiceData.VideoStorage.StoragePolicy = 0;
						sendUrl = LAPI.Storage;
					}
					dsBridgeFuncSyn.showLoading();
					SendAjax(sendUrl, "put", function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {

						} else {
							setSDcardConfirm = false;
							showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
							setTimeout(function() {
								mui("#setSDcardSwitch").switch().toggle()
							}, 200)
						}
					}, sendDataOFF)
				} else {
					setSDcardConfirm = true;
				}

			})

			function storageStatus() {
				// TODO:页面跳转+传参
				jumpToWebPage("settings_SDCardStatus", "");
			}
			/*
			 *  录像计划
			 */
			// setVideo.addEventListener("tap", function() {
			// 	// TODO:页面跳转+传参
			// 	jumpToWebPage("settings_VideoPlan", "");

			// });

			function formatStorage() {
				var btnArray = [langTip["WEB_text_no"], langTip["WEB_text_yes"]];
				mui.confirm(langTip["WEB_sd_format_tip"], langTip["WEB_dialog_title_notify"], btnArray, function(e) {
					if(e.index == 1) {
						if(editionFlag) {
							newFormat();
						} else {
							oldFormat();
						}
					}
				}, 'div');
			}

			function oldFormat() {
				dsBridgeFuncSyn.showLoading();
				//先判断是否有SD卡然后，若有则调格式化接口
				SendAjax(LAPI.StatusSD, 'get', function(code, data) {
					if(code == 0) {
						switch(data.StatusParam.SDStatus) {
							case 0:
								dsBridgeFuncSyn.dismiss();
								showToast(langTip["WEB_web_sd_noSD"]);
								break;
								//									case 1:
								//										dsBridgeFuncSyn.dismiss();
								//										showToast(langTip["WEB_web_sd_errSD"]);
								//										break;
							default:
								format();
						}
					} else {
						dsBridgeFuncSyn.dismiss();
						showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
					}
				});
			}

			function newFormat() {
				dsBridgeFuncSyn.showLoading();
				SendAjax(LAPI.StorageDetailInfos, "get", function(code, data) {
					if(code == 0) {
						var isNoSDCard = true;
						if(data.SDNum > 0) {
							for(var i = 0; i < data.SDNum; i++) {
								if(data.SDList[i].Status != 0) {
									isNoSDCard = false;
								}
							}
						}
						if(isNoSDCard) {
							dsBridgeFuncSyn.dismiss();
							showToast(langTip["WEB_web_sd_noSD"]);
						} else {
							format();
						}

					} else {
						//数据获取失败的处理
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						dsBridgeFuncSyn.dismiss();
					}
				})
			}

			function format() {
				SendAjax(LAPI.SDFormat, 'put', function(code, data) {
					if(code == 0) { //格式化下发成功后告知原生页面关闭web页面，返回上一页
						showToast(langTip["WEB_api_error_succeededAndRebooting"]);
						dsBridgeFuncSyn.dismiss();
						// TODO:
						dsBridgeFuncSyn.deviceOffLine();
						//												webAppClose();
					} else {
						dsBridgeFuncSyn.dismiss();
						showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
					}
				});
			}

			/**
			 * 图像清晰度
			 */
			function ImageVivid() {
				// TODO:页面跳转+传参
				jumpToWebPage("settings_SDCardVideoImage", "");
			}


			/******************原生App上报Web功能接口******************/
dsBridge.register("callWebDoFuncAsyn", function(args) {
	var webInfo = JSON.parse(args);
	for(var key in webInfo) {
		switch(webInfo[key].whichInfo) {
			case "deviceStatus": // 更新设备在线状态
				localStorage.deviceStatus = webInfo[key].infoValue;
				break;
			case "ip": // 更新ip
				localStorage.Ip = webInfo[key].infoValue;
				break;
			case "port": // 更新port
				localStorage.Port = webInfo[key].infoValue;
				break;
			case "logInfo": //更新登录信息
				localStorage.logInfo = webInfo[key].infoValue;
				break;
			case "deviceName": //更新设备名称
				localStorage.deviceName = webInfo[key].infoValue;
				break;
			case "sdkType": //更新SDK类型
				localStorage.sdkType = webInfo[key].infoValue;
				break;
			case "isNetConnect": //更新手机是否联网
				localStorage.isNetConnect = webInfo[key].infoValue;
				break;
			case "hasNewVersion": //是否有新版本
				localStorage.hasNewVersion = webInfo[key].infoValue;
				break;
			case "versionNumber": //当前版本号
				localStorage.versionNumber = webInfo[key].infoValue;
				break;
			case "LocalDeviceUname": //免注册设备用户名更新
				localStorage.LocalDeviceUname = webInfo[key].infoValue;
				break;
			case "deviceOs": //设备云端在线状态 “true”在线，“false”离线
				localStorage.deviceOs = webInfo[key].infoValue;
				break;
			case "updateChannelName": // TODO：通道名称修改成功后，主页同步更新
				localStorage.deviceName = webInfo[key].infoValue;
				break;
			case "workingStatus":
				localStorage.workingStatus = webInfo[key].infoValue;
				break;
			case "channelStatus":
		        localStorage.channelStatus = webInfo[key].infoValue;
				break;
			case "modifyVideoType": 
			   isAuto = true
			   break;
			default:
				break;
		}
	}
})
		</script>
	</body>

</html>