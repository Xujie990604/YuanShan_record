<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<link href="../css/theme_normal.css" rel="stylesheet" />
	</head>
	<style>
		.mui-table-view-radio .mui-table-view-cell.mui-selected .mui-navigate-right:after {
			content: '\e442';
		}

		.mui-table-view-radio .mui-table-view-cell .mui-navigate-right:after {
			font-weight: 200;
		}

		.mode-style {
			font-size: 16px;
			color: #333;
		}

		.mode-detail-style {
			font-size: 14px;
			color: rgba(51, 51, 51, 0.4);
		}

		.mui-table-view-radio .mui-table-view-cell {
			height: 100%;
		}

		.mui-table-view-radio .mui-table-view-cell .mui-navigate-right:after {
			content: '\e411';
		}
	</style>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_Intelligent_light_supply">&nbsp;</h1>
		</header>
		<div class="mui-content">
			<div id="EZView-content" class="mui-hidden">
				<ul id="Image" class="mui-table-view ui-siwtchlist">
					<li id="setImage" class="mui-table-view-cell">
						<span data-text="WEB_Intelligent_light_supply" class="mainStyle">&nbsp;</span>
						<div id="setImageSwitch" class="mui-switch mui-switch-mini">
							<div class="mui-switch-handle" id="setImageCircle"></div>
						</div>
						<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
					</li>
					<!--<li id="setImageLightItem" class="mui-table-view-cell mui-hidden">
						<a href="#setImageLight" class="mui-navigate-right">&nbsp;
							<span data-text="WEB_Light_mode" class="mainStyle padding-left-15">&nbsp;</span>
							<span id="setImageLightVal" class="mui-badge"></span>
						</a>
					</li>-->
				</ul>
				<ul id="LightModeList" class="mui-table-view mui-table-view-radio mui-hidden">
					<li id="whiteMode" class="mui-table-view-cell mui-hidden" data-switch="1">
						<div class="mode-style mui-navigate-right" data-text="WEB_white_mode">
							&nbsp;
						</div>
						<div class="mode-detail-style" data-text="WEB_whiteLightMode">
							&nbsp;
						</div>
						<!--补光灯模式-->
					</li>
					<li id="redMode" class="mui-table-view-cell mui-hidden" data-switch="2">
						<div class="mode-style mui-navigate-right" data-text="WEB_infra_red_mode">
							&nbsp;
						</div>
						<div class="mode-detail-style" data-text="WEB_infraredMode">
							&nbsp;
						</div>
					</li>
					<li id="doubleMode" class="mui-table-view-cell mui-hidden" data-switch="6">
						<div class="mode-style mui-navigate-right" data-text="WEB_Intelligent_double_light">
							&nbsp;
						</div>
						<div class="mode-detail-style" data-text="WEB_dualLightMode">
							&nbsp;
						</div>
					</li>
					<li id="smartWhite" class="mui-table-view-cell mui-hidden" data-switch="8">
						<div class="mode-style mui-navigate-right" data-text="WEB_Intelligent_white_light">
							&nbsp;
						</div>
						<div class="mode-detail-style" data-text="WEB_IntelligentWhiteLightMode">
							&nbsp;
						</div>
					</li>
				</ul>
			</div>
		</div>

		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/libs/sha2.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/loadCss.js "></script>
    <script id="langScript"></script>
		<script>
			var langTip;
			checkType(localStorage.AppType); //加载特定样式
			var setImageConfirm = true; //补灯光模开关状态变化时是否调接口提交
			var setImageServiceData; //补灯光模使能服务端数据
			var setImageCapabilities;
			var setImageCheck; // 图像设置开关是否开启
			var LightModeChecked;
			var LightModeVal; //补灯光模式取值
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;
			initData();
			initEvent();

			function initData() {
				initsetImage();
			}

			function initEvent() {
				//				document.getElementById('LightModeList').addEventListener('selected', function(e) {
				//					LightModeChecked = e.detail.el.innerText.trim();
				//				});
				//				document.getElementById('closeLightMode').addEventListener('tap', closeLightMode);
				//				document.getElementById('LightModeOk').addEventListener('tap', LightModeOk);
				//
				//				// 手势操作：向下滑动关闭弹框
				//				document.getElementById("swipedownDiv").addEventListener("swipedown", function() {
				//					mui('#setImageLight').popover('toggle');
				//				});
				var list = document.querySelector('.mui-table-view.mui-table-view-radio');
				list.addEventListener('selected', function(e) {
					var sendData = deepCopy(setImageServiceData);
					sendData.Type = Number(e.detail.el.getAttribute("data-switch"));
					//					if(LightModeChecked == langTip["WEB_white_mode"]) {
					//						sendData.Type = 1;
					//					} else if(LightModeChecked == langTip["WEB_infra_red_mode"]) {
					//						sendData.Type = 2;
					//					} else if(LightModeChecked == langTip["WEB_Intelligent_double_light"]) {
					//						sendData.Type = 6;
					//					}
					dsBridgeFuncSyn.showLoading();
					SendAjax(LAPI.ImageLampCtrl, 'put', function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {
							setImageServiceData = deepCopy(sendData);
							showToast(langTip["WEB_api_error_succeeded"]);
							//							document.getElementById('setImageLightVal').innerText = LightModeChecked;
						} else {
							setMode(setImageServiceData.Type);
							showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
						}
					}, sendData);
					//					if(e.detail.el.getAttribute("data-switch") == 2) {
					//						sendData = {
					//							ModeSwitchType: 2
					//						}
					//					} else if(e.detail.el.getAttribute("data-switch") == 1) {
					//						sendData = {
					//							ModeSwitchType: 1,
					//							Mode: Number(e.detail.el.getAttribute("data-mode"))
					//						}
					//					}
					//					console.log(sendData);
					//					dsBridgeFuncSyn.showLoading();
					//					SendAjax(LAPI.PowerMode, 'put', function(code, data) {
					//						dsBridgeFuncSyn.dismiss();
					//						if(code == 0) {
					//							powerModeInfo = sendData;
					//						} else {
					//							showToast(langTip["WEB_loadFailed"], code);
					//							setSelectMode(powerModeInfo);
					//						}
					//					}, sendData);
				});
			}

			/**
			 * 图像设置使能
			 */
			function initsetImage() {
				var Url = "web/newPages/settings_IntelligentLight.html";
				var self = dsBridgeFuncSyn.getWebParam(Url);
				self = JSON.parse(self);
				var data = self.capacityData;
				setImageCapabilities = deepCopy(data);
				setImageData(setImageCapabilities.LampCtrl.LampInfos);

			}

			/**
			 * 报警音列表在页面中显示
			 * @param {Object} data
			 */
			function getLightModeList(data) {
				var LightModeList = document.getElementById('LightModeList');
				for(var i = 0; i < data.length; i++) {
					if(data[i].LampType == 1 || data[i].LampType == 2 || data[i].LampType == 6 || data[i].LampType == 8) {
						if(data[i].LampType == 1) {
							$("#whiteMode").removeClass("mui-hidden");
						} else if(data[i].LampType == 2) {
							$("#redMode").removeClass("mui-hidden");
						} else if(data[i].LampType == 6) {
							$("#doubleMode").removeClass("mui-hidden");
						} else if(data[i].LampType == 8) {
							$("#smartWhite").removeClass("mui-hidden");
						}
					}
				}
			}

			/**
			 * 发请求获取图像设置使能数据初始化
			 * @param {Object} list
			 */
			function setImageData(list) {
				SendAjax(LAPI.ImageLampCtrl, 'get', function(code, data) {
					if(code == 0) {
						$("#EZView-content").removeClass("mui-hidden");
						getLightModeList(list);
						setImageServiceData = deepCopy(data);
						setImageCheck = data.Enabled; // 0：关闭，1：开启
						//初始化运动检测开关
						document.getElementById("setImageSwitch").style.zIndex = 20;
						document.getElementById("setImageSwitch").style.visibility = "visible";
						setImageConfirm = false;
						setSwitchStatus("setImageSwitch", setImageCheck);
						setImageConfirm = true;
						LightModeVal = setImageServiceData.Type;
						setMode(LightModeVal);
						//						if(LightModeVal == 1 || LightModeVal == 2 || LightModeVal == 6) {
						//							document.getElementById('setImageLightVal').innerText = LightModeChecked;
						//						}
						//						mui('#LightModeList a').each(function(index, El) {
						//							if(El.innerText.trim() == LightModeChecked) {
						//								El.parentNode.classList.add('mui-selected');
						//							}
						//						});
						if(setImageCheck == 1) {
							$("#LightModeList").removeClass("mui-hidden");
							//显示运动检测配置选项
							//							mui("#Image .mui-table-view-cell").each(function(index, El) {
							//								if(index != 0) {
							//									El.classList.remove('mui-hidden');
							//								}
							//							});
						}
						dsBridgeFuncSyn.dismiss();
					} else {
						//数据获取失败的处理
						addBitmap(0);
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						dsBridgeFuncSyn.dismiss();
					}
				});
			}
			/*
			 * 监听图像设置开关
			 */
			document.getElementById("setImageSwitch").addEventListener("toggle", function(event) {
				if(event.detail.isActive && setImageConfirm) {
					var sendDataON = deepCopy(setImageServiceData);
					sendDataON.Enabled = 1; // 0：图像设置关闭，1：图像设置开启
					dsBridgeFuncSyn.showLoading();
					SendAjax(LAPI.ImageLampCtrl, 'put', function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {
							$("#LightModeList").removeClass("mui-hidden");
							setImageServiceData.Enabled = 1;
							showToast(langTip["WEB_api_error_succeeded"]);
							//							mui("#Image .mui-table-view-cell").each(function(index, El) {
							//								if(index != 0) {
							//									El.classList.remove('mui-hidden');
							//								}
							//							});
						} else {
							setImageConfirm = false;
							showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
							setTimeout(function() {
								mui("#setImageSwitch").switch().toggle();
							}, 200);
						}
					}, sendDataON);
				} else if(!event.detail.isActive && setImageConfirm) {
					$("#LightModeList").addClass("mui-hidden");
					mui("#Image .mui-table-view-cell").each(function(index, El) {
						if(index != 0) {
							El.classList.add('mui-hidden');
						}
					});
					var sendDataOFF = deepCopy(setImageServiceData);
					sendDataOFF.Enabled = 0; // 0：图像设置关闭，1：图像设置开启
					dsBridgeFuncSyn.showLoading();
					SendAjax(LAPI.ImageLampCtrl, 'put', function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {
							setImageServiceData.Enabled = 0;
							showToast(langTip["WEB_api_error_succeeded"]);
						} else {
							setImageConfirm = false;
							showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
							setTimeout(function() {
								mui("#setImageSwitch").switch().toggle();
								$("#LightModeList").removeClass("mui-hidden");
								//								mui("#Image .mui-table-view-cell").each(function(index, El) {
								//									if(index != 0) {
								//										El.classList.remove('mui-hidden');
								//									}
								//								});
							}, 300);
						}
					}, sendDataOFF);
				} else {
					setImageConfirm = true;
				};
			});

			function closeLightMode() {
				mui('#setImageLight').popover('toggle');
				if(LightModeChecked == document.getElementById('setImageLightVal').innerText.trim()) return;
				mui('#LightModeList a').each(function(index, El) {
					if(El.innerText.trim() == document.getElementById('setImageLightVal').innerText.trim()) {
						El.parentNode.classList.add('mui-selected');
					} else {
						El.parentNode.classList.remove('mui-selected');
					}
				});
			}

			function LightModeOk() {
				mui('#setImageLight').popover('toggle');
				var sendData = deepCopy(setImageServiceData);
				if(LightModeChecked == langTip["WEB_white_mode"]) {
					sendData.Type = 1;
				} else if(LightModeChecked == langTip["WEB_infra_red_mode"]) {
					sendData.Type = 2;
				} else if(LightModeChecked == langTip["WEB_Intelligent_double_light"]) {
					sendData.Type = 6;
				}
				dsBridgeFuncSyn.showLoading();
				SendAjax(LAPI.ImageLampCtrl, 'put', function(code, data) {
					dsBridgeFuncSyn.dismiss();
					if(code == 0) {
						setImageServiceData = deepCopy(sendData);
						document.getElementById('setImageLightVal').innerText = LightModeChecked;
					} else {
						if(LightModeChecked != document.getElementById('setImageLightVal').innerText.trim()) {
							mui('#LightModeList a').each(function(index, El) {
								if(El.innerText.trim() == document.getElementById('setImageLightVal').innerText.trim()) {
									El.parentNode.classList.add('mui-selected');
								} else {
									El.parentNode.classList.remove('mui-selected');
								}
							});
						}
						showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
					}
				}, sendData);
			}

			function setMode(LightModeVal) {
				$("#LightModeList li").removeClass("mui-selected");
				if(LightModeVal == 1) {
					$("#whiteMode").addClass("mui-selected");
				} else if(LightModeVal == 2) {
					$("#redMode").addClass("mui-selected");
				} else if(LightModeVal == 6) {
					$("#doubleMode").addClass("mui-selected");
				} else if(LightModeVal == 8) {
					$("#smartWhite").addClass("mui-selected");
				}
			}
		</script>
	</body>

</html>