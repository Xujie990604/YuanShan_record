<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<link href="../css/theme_normal.css" rel="stylesheet" />
		<style>

		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_doorMagnetSetting">&nbsp;</h1>
		</header>
		<div class="mui-content">
			<ul class="mui-table-view" id="messageUl">
				<!--接受告警消息-->
				<li class="mui-table-view-cell">
					<span data-text="WEB_alarmNoti">&nbsp;</span>
					<div id="alarmMsgSwitch" class="mui-switch mui-switch-mini">
						<div class="mui-switch-handle" id="alarmMsgSwitchCircle"></div>
					</div>
				</li>
				<li id="modify_name" class="mui-table-view-cell">
					<a class="mui-navigate-right">
						<span data-text="WEB_doorMagnetName">&nbsp;</span>
						<span id="doorLockNname" class="mui-badge">&nbsp;</span>
					</a>
				</li>
			</ul>
		</div>

		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/libs/sha2.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/loadCss.js"></script>
    <script id="langScript"></script>
		<script>
			var isShowNoFunction; //无功能占位图
			var doorLockInfo;
			var sendDoorLockInfo = {};
			var setAlarmConfirm = true; //告警通知开关状态变化时是否调接口提交
			checkType(localStorage.AppType); //加载特定样式
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;

			initPage();
			initData();
			initEvent();
			dsBridgeFuncSyn.dismiss();

			function initPage() {
				var Url = "web/newPages/settings_doorLockConfig.html";
				var self = dsBridgeFuncSyn.getWebParam(Url);
				doorLockInfo = JSON.parse(self);
				document.getElementById("doorLockNname").innerText = doorLockInfo.name;
				sendDoorLockInfo.imei = doorLockInfo.imei;
				sendDoorLockInfo.sensorType = 0;
				sendDoorLockInfo.deviceSerial = localStorage.devSn20;
				sendDoorLockInfo.channelNo = Number(localStorage.channelId);

			}

			function initData() {
				document.getElementById("alarmMsgSwitch").style.zIndex = 20;
				document.getElementById("alarmMsgSwitch").style.visibility = "visible";
				setWideDynamicConfirm = false;
				setSwitchStatus("alarmMsgSwitch", doorLockInfo.alarmEnable);
				setWideDynamicConfirm = true;
				var setWideDynamicActive = document.getElementById("alarmMsgSwitch").classList.contains("mui-active")
				if(setWideDynamicActive) {
					document.getElementById("alarmMsgSwitchCircle").style.transform = 'translate(16px, 0px)';
				}
			}

			function initEvent() {
				document.getElementById("alarmMsgSwitch").addEventListener('toggle', function(event) {
					if(event.detail.isActive && setAlarmConfirm) {
						var sendDataON = deepCopy(sendDoorLockInfo);
						sendDataON.alarmEnable = 1;
						dsBridgeFuncSyn.showLoading();
						CloudSendAjax("https://" + localStorage.serverAddress + openAPI.SetSensor, 'post', function(code, data) {
							dsBridgeFuncSyn.dismiss();
							if(code == 200) {
								doorLockInfo.alarmEnable = 1;
//								dsBridgeFuncSyn.sendDataToReport("refreshDoorLockEnable", JSON.stringify(doorLockInfo));
								dsBridgeFuncSyn.sendDataToReport("refreshDoorLockList", "");
							} else {
								setAlarmConfirm = false
								showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
								setTimeout(function() {
									mui("#alarmMsgSwitch").switch().toggle()
								}, 200)
							}
						}, sendDataON)
					} else if(!event.detail.isActive && setAlarmConfirm) {
						var sendDataOFF = deepCopy(sendDoorLockInfo);
						sendDataOFF.alarmEnable = 0;
						dsBridgeFuncSyn.showLoading();
						CloudSendAjax("https://" + localStorage.serverAddress + openAPI.SetSensor, 'post', function(code, data) {
							dsBridgeFuncSyn.dismiss();
							if(code == 200) {
								doorLockInfo.alarmEnable = 0;
//								dsBridgeFuncSyn.sendDataToReport("refreshDoorLockEnable", JSON.stringify(doorLockInfo));
								dsBridgeFuncSyn.sendDataToReport("refreshDoorLockList", "");
							} else {
								setAlarmConfirm = false;
								showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
								setTimeout(function() {
									mui("#alarmMsgSwitch").switch().toggle();
								}, 200)
							}
						}, sendDataOFF)
					} else {
						setAlarmConfirm = true;
					}
				});

				document.getElementById("modify_name").addEventListener("tap", function() {
					var id = "settings_doorLockModifyName";
					var Url = "web/newPages/" + id + ".html";
					var param = deepCopy(doorLockInfo);
					dsBridgeFuncSyn.pageTo(Url, JSON.stringify(param));
				});

			}

			/******************新增原生App上报Web功能接口******************/
			dsBridge.register("callWebDoFuncAsyn", function(args) {
				appLog("Web --- args: " + args);
				var webInfo = JSON.parse(args);
				for(var key in webInfo) {
					switch(webInfo[key].whichInfo) {
						case "updateDoorLockName": // TODO：通道名称修改成功后，详情页同步更新
							document.getElementById("doorLockNname").innerText = webInfo[key].infoValue;
							doorLockInfo.name = webInfo[key].infoValue;
							break;
						case "deviceStatus": // 更新设备在线状态
							localStorage.deviceStatus = webInfo[key].infoValue;
							break;
						case "deviceName": //更新设备名称
							localStorage.deviceName = webInfo[key].infoValue;
							deviceNameVal.innerText = localStorage.deviceName;
							break;
						case "sdkType": //更新SDK类型
							localStorage.sdkType = webInfo[key].infoValue;
							accessProtocolVal.innerHTML = localStorage.sdkType;
							break;
						case "hasNewVersion": //是否有新版本
							localStorage.hasNewVersion = webInfo[key].infoValue;
							break;
						case "versionNumber": //当前版本号
							localStorage.versionNumber = webInfo[key].infoValue;
							deviceEditionVal.innerHTML = localStorage.versionNumber;
							break;
						case "LocalDeviceUname": //免注册设备用户名更新
							localStorage.LocalDeviceUname = webInfo[key].infoValue;
							deviceInfosVal.innerHTML = localStorage.LocalDeviceUname;
							break;
						default:
							break;
					}
				}
			})
		</script>
	</body>

</html>