<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<link href="../css/theme_normal.css" rel="stylesheet" />
		<style>
			.private-settings-img {
				width: 24px;
			}
			
			.mui-row .mui-table-view-cell {
				text-align: center;
				font-size: 12px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_generalDetection">&nbsp;</h1>
		</header>
		<div class="mui-content">
			<div class="mui-row mui-hidden" id="intelligentTop">
				<!--运动检测-->
				<div class="mui-col-xs-3 mui-hidden" id="settings_Motion">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell" id="checkChannel_tap">
							<image src="../images/motion_detection.png" class="private-settings-img"></image>
							<div data-text="WEB_motion_detection" class="imgTitles private-ellipsis">&nbsp;</div>
						</li>
					</ul>
				</div>
				<!--人形检测-->
				<div class="mui-col-xs-3 mui-hidden" id="settings_Human">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell" id="settings_Human_tap">
							<image src="../images/human_detection.png" class="private-settings-img"></image>
							<div data-text="WEB_device_manager_HumanDetection_setting" class="imgTitles private-ellipsis">&nbsp;</div>
						</li>
					</ul>
				</div>
				<div class="mui-col-xs-3 mui-hidden" id="settings_AudioDetecion">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell" id="settings_AudioDetecion_tap">
							<image src="../images/sound_detection3x.png" class="private-settings-img"></image>
							<div data-text="WEB_soundDetecion" class="imgTitles private-ellipsis">&nbsp;</div>
						</li>
					</ul>
				</div>

			</div>
		</div>

		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/libs/sha2.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/loadCss.js "></script>
		<script id="langScript"></script>
		<script>
			var isShowNoFunction; //无功能占位图
			var isSupportNum = 0; //默认支持功能数目
			checkType(localStorage.AppType); //加载特定样式
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;
			var alarmData = {};
			var systemCap = {};
			initData();
			initEvent();

			function initData() {
				isShowNoFunction = true;
				//NVR不支持配置检测功能
				if(localStorage.dvt == 100) { // 接入设备为门铃时显示时间配置、扬声器音量、人形检测使能；同时屏蔽运动检测所有功能
					document.getElementById("settings_Human").classList.remove("mui-hidden");
					document.getElementById("settings_Motion").classList.add("mui-hidden"); //动检
					isShowNoFunction = false;
					isSupportNum += 1;
					addOccupationMap();
					dsBridgeFuncSyn.dismiss();
				} else {
					SendAjax(LAPI.AlarmCapabilities, 'get', function(code, data) {
						if(code == 0) {
							//判断是否支持运动检测
							alarmData = JSON.parse(JSON.stringify(data));
							if(data.MotionDetection && data.MotionDetection.IsSupportCfg && data.MotionDetection.IsSupportCfg == 1) {
								isShowNoFunction = false;
								isSupportNum += 1;
								$("#settings_Motion").removeClass("mui-hidden");
							}

							//现版本通道不支持人形检测功能
							//							if(!(localStorage.deviceType == "1" && localStorage.channelId != "0")) {
							//判断人形检测支持与否
							if(data.HumanShapeDetection && data.HumanShapeDetection.SupportCfg && data.HumanShapeDetection.SupportCfg == 1 && data.HumanShapeDetection.RectangleAreaNum > 0) { // 当前IPC支持人形检测, 当前门铃不支持人形检测，data.HumanShapeDetection当这个字段存在说明支持人形检测否则不支持
								isShowNoFunction = false;
								isSupportNum += 1;
								$("#settings_Human").removeClass("mui-hidden");
								getSystemCapability();
							} else {

								if(localStorage.deviceType == "0" && localStorage.isMultiChannelIPC == "0") {
									getSystemCapability();
								} else {
									dsBridgeFuncSyn.dismiss();
									addOccupationMap();
								}
							}
						} else if(code == 4 || code == 8 || code == 1006) {
							if(localStorage.deviceType == "0" && localStorage.isMultiChannelIPC == "0") {
								getSystemCapability();
							} else {
								dsBridgeFuncSyn.dismiss();
								showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
								addBitmap(1, langTip["WEB_unSupported"]);
							}
						} else {
							//TODO:加载失败显示加载失败占位图
							dsBridgeFuncSyn.dismiss();
							addBitmap(0);
							showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						}
					})

				}
			}

			function initEvent() {
				document.getElementById("settings_Motion").addEventListener('tap', function() {
					//IPC
					if(localStorage.deviceType == "0") {
						jumpToWebPage("settings_Motion");
					}
					//NVR通道
					if(localStorage.deviceType == "1" && localStorage.channelId != "0") {
						jumpToWebPage("settings_MotionChannel");
					}

				});
				document.getElementById("settings_Human").addEventListener('tap', function() {
					var SupportAudioLinkagePlan = 0;
					var SupportLightLinkagePlan = 0;
					var IsSupportedLightAlarm = 0;
					var IsSupportedAudioAlarm = 0;
					var SupportLinkageDayNightMode = 0;
					if(alarmData.HumanShapeDetection && alarmData.HumanShapeDetection.LinkagePlanCfg && alarmData.HumanShapeDetection.LinkagePlanCfg.SupportAudioLinkagePlan && alarmData.HumanShapeDetection.LinkagePlanCfg.SupportAudioLinkagePlan == 1) {
						SupportAudioLinkagePlan = 1;
					}
					if(alarmData.HumanShapeDetection && alarmData.HumanShapeDetection.LinkagePlanCfg && alarmData.HumanShapeDetection.LinkagePlanCfg.SupportLightLinkagePlan && alarmData.HumanShapeDetection.LinkagePlanCfg.SupportLightLinkagePlan == 1) {
						SupportLightLinkagePlan = 1;
					}
					if(systemCap.IsSupportedLightAlarm != 0) {
						IsSupportedLightAlarm = 1;
					}
					if(systemCap.IsSupportedAudioAlarm != 0) {
						IsSupportedAudioAlarm = 1;
					}
					if(alarmData.HumanShapeDetection && alarmData.HumanShapeDetection.SupportDayNightCfg && alarmData.HumanShapeDetection.SupportDayNightCfg == 1) {
						SupportLinkageDayNightMode = 1;
					}
					var capacityData = {
						SupportAudioLinkagePlan: SupportAudioLinkagePlan,
						SupportLightLinkagePlan: SupportLightLinkagePlan,
						IsSupportedLightAlarm: IsSupportedLightAlarm,
						IsSupportedAudioAlarm: IsSupportedAudioAlarm,
						SupportLinkageDayNightMode: SupportLinkageDayNightMode
					};
					jumpToWebPage("settings_Human", JSON.stringify(capacityData));
				});
				document.getElementById("settings_AudioDetecion").addEventListener('tap', function() {
					jumpToWebPage("settings_AudioDetecion");
				});
			}

			/*
			 * @parent父元素
			 */
			function addFirstLine(parent) {
				var div1 = document.createElement("div1");
				var ul = document.createElement("ul");
				var li = document.createElement("li");
				div1.className = "mui-col-xs-3";
				ul.className = "mui-table-view";
				li.className = "mui-table-view-cell";
				ul.appendChild(li);
				div1.appendChild(ul);
				parent.appendChild(div1);
			}

			/*
			 * @parent父元素
			 */
			function addNoFirstLine(parent) {
				var div1 = document.createElement("div1");
				var ul = document.createElement("ul");
				var li = document.createElement("li");
				div1.className = "mui-col-xs-3 non-first";
				ul.className = "mui-table-view ";
				li.className = "mui-table-view-cell";
				ul.appendChild(li);
				div1.appendChild(ul);
				parent.appendChild(div1);

			}

			function getSystemCapability() {
				SendAjax(LAPI.IPCorChannelCapabilities, 'get', function(code, data) {
					dsBridgeFuncSyn.dismiss();
					if(code == 0) {
						if(localStorage.deviceType == "0" && localStorage.isMultiChannelIPC == "0") {
							if(data.AudioDetectionCapInfo && data.AudioDetectionCapInfo.IsSupport == 1) { // 当前IPC支持越界检测, 当前门铃不支持越界检测，data.AudioDetecionShapeDetection当这个字段存在说明支持越界检测否则不支持
								isShowNoFunction = false;
								isSupportNum += 1;
								$("#settings_AudioDetecion").removeClass("mui-hidden");
							}
						}
						if(alarmData.HumanShapeDetection && alarmData.HumanShapeDetection.SupportCfg && alarmData.HumanShapeDetection.SupportCfg == 1 && alarmData.HumanShapeDetection.RectangleAreaNum > 0) {
							systemCap = JSON.parse(JSON.stringify(data));
						}
						addOccupationMap();
					} else {
						if(code == 4 || code == 8 || code == 1006) {
							if(isSupportNum == 0) {
								addBitmap(1, langTip["WEB_unSupported"]);
								showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
							} else {
								addOccupationMap();
							}
						} else {
							addBitmap(0);
							showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						}
					}
				})
			}

			function addOccupationMap() {
				if(isShowNoFunction) {
					//TODO:无功能占位图
					addBitmap(1, langTip["WEB_noConfigAvailable"]);
				} else {
					$("#intelligentTop").removeClass("mui-hidden");
					var par = document.getElementById("intelligentTop");
					if(isSupportNum <= 4) {
						for(var i = 0; i < 4 - isSupportNum; i++) {
							addFirstLine(par);
						}
					} else {
						//最多两行8个，一行4个
						for(var i = 0; i < 8 - isSupportNum; i++) {
							addNoFirstLine(par);
						}
					}
				}
			}
		</script>
	</body>

</html>