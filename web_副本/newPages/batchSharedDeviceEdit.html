<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title></title>
  <link href="../css/mui.css" rel="stylesheet" />
  <link href="../css/iconfont.css" rel="stylesheet" />
  <!-- <link href="../css/Common.css" rel="stylesheet" /> -->
  <link href="../css/theme_normal.css" rel="stylesheet" />
  <style>
    .info-card {
      width: 94%;
      margin-left: 3%;
      background-color: #fff;
      height: 50px;
      margin-bottom: 12px;
    }

    .user-info {
      display: flex;
      flex-direction: row;
      align-items: center;
    }

    .user-info img {
      height: 48px;
      margin-right: 12px;
    }

    .remark {
      line-height: 50px;
    }

    .device-manage-content {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
    }

    /* 分页器 + 列表 */
    #selectDeviceChannelListContent {
      position: relative;
      height: 600px;
    }

    #selectDeviceChannelListContent ul {
      list-style: none;
      padding: 0;
      margin: 0;
      background-color: transparent;
    }

    /* 设备列表 */
    #selectDeviceListContent {
      position: relative;
      height: 400px;
    }

    /* 被分享的设备的样式 */
    .device-card {
      height: 90px;
      width: 94%;
      margin-bottom: 12px;
      flex-direction: row;
      border-radius: 8px;
      background-color: #fff;
    }

    .device-card a {
      position: relative;
      display: flex;
      flex-direction: row;
      align-items: center;
      height: 100%;
    }

    .device-logo {
      height: 48px;
      margin: 0 10px 0 12px;
    }

    .device-card .device-info {
      display: flex;
      flex-direction: column;
    }

    .device-name {
      font-size: 17px;
    }

    .device-permissions {
      font-size: 12px;
    }

    .device-endTime {
      font-size: 12px;
    }

    /* 通道列表 */
    #selectChannelListContent {
      height: 400px;
    }

    /* 被分享的 NVR 通道的样式 */
    .channels-list-card {
      width: 94%;
      background-color: #fff !important;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .channels-list-card .line {
      height: 1px;
      background-color: rgba(51, 51, 51, 0.15);
      margin-bottom: 5px;
    }

    .channels-list-card a {
      position: relative;
      display: flex;
      flex-direction: row;
      align-items: center;
      height: 100%;
    }

    /* NVR 通道列表的折叠按钮 */
    .collapse-btn::after {
      position: absolute;
      top: 50%;
      left: 0;
      font-size: 30px;
    }

    .channel-info {
      display: flex;
      flex-direction: column;
    }

    .channel-name {
      font-size: 17px;
      color: black;
    }

    .channel-permissions {
      font-size: 12px;
    }

    .channel-endTime {
      font-size: 12px;
    }

    /* 底部的批量分享按钮 */
    #EZView-content .batch-share-btn-content {
      position: fixed;
      bottom: 0;
      height: 86px;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #fff;
    }

    #EZView-content .batch-share-btn {
      height: 44px;
      width: 78%;
      border-radius: 22px !important;
      background-color: #50d0c1 !important;
      font-size: 17px;
      color: #fff !important;
      font-weight: 400;
    }
  </style>
</head>

<body>
  <!-- 页面标题 -->
  <header class="mui-bar mui-bar-nav">
    <a id="back" class="mui-icon iconfont icon-back1"></a>
    <h1 id="title" class="mui-title" data-text="">编辑分享</h1>
  </header>
  <div class="mui-content">
    <div id="EZView-content" class="">
      <div class="share-user">
        接收者
      </div>
      <div class="user-info info-card">
        <img src="../images/check_half.png">
        <div id="userName" class="user-name">coder_xujie@163.com</div>
      </div>
      <div id="userRemark" class="remark info-card">默认的备注</div>

      <div class="device-manage-content">
        <div class="shared-device">
          被分享的设备
        </div>
        <button id="editDeviceBtn">管理设备</button>
      </div>

      <!-- 列表：用户勾选的设备 -->
      <div id="selectDeviceChannelListContent">
        <!-- 选项卡：设备/通道切换 -->
        <div class="tab-card">
          <div id="segmentedControl" class="mui-segmented-control">
            <a href="#item1" class="mui-control-item mui-active">设备</a>
            <a href="#item2" class="mui-control-item ">通道</a>
          </div>
        </div>
        <!-- 内容区域：设备/通道列表 -->
        <div class="mui-content-padded">
          <!-- 选项卡内容：设备的信息 -->
          <div id="item1" class="mui-control-content mui-active">
            <div id="selectDeviceListContent">
              <div class="mui-scroll-wrapper">
                <div class="mui-scroll">
                  <ul id="selectDeviceListUL" class="mui-table-view">
                    <!-- 设备模版 -->
                    <li class="device-card-template device-card mui-hidden">
                      <a class="mui-navigate-right">
                        <img class="device-logo" src="../images/appConfig/IPC3x.png">
                        <div class="device-info">
                          <span class="device-name">IPC-001</span>
                          <span class="device-permissions">实况查看/云台控制/语音对讲/告警消息/录像查看/设备配置</span>
                          <span class="device-endTime">永久的模板</span>
                        </div>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <!-- 选项卡内容：通道的信息 -->
          <div id="item2" class="mui-control-content ">
            <div id="selectChannelListContent">
              <div class="mui-scroll-wrapper">
                <div class="mui-scroll">
                  <ul id="selectChannelListUL" class="mui-table-view">
                    <!-- NVR通道列表模版 -->
                    <li
                      class="mui-table-view-cell mui-collapse NVR-channels-list-card-template channels-list-card mui-active mui-hidden">
                      <a class="mui-navigate-right collapse-btn" href="#">
                        <img class="device-logo" src="../images/appConfig/NVR3x.png">
                        <span class="NVR-channels-list-name">NVR-001</span>
                      </a>
                      <div class="mui-collapse-content">
                        <!-- 分割线 -->
                        <div class="line"></div>
                        <!-- 通道列表 -->
                        <ul class="mui-table-view NVR-channel-list-ul">
                          <!-- 把 NVR 通道卡片的 DOM 结构放到这里面 -->

                        </ul>
                      </div>
                    </li>
                    <!-- NVR 通道卡片模板 -->
                    <li class="NVR-channels-card-template channel-card mui-hidden">
                      <a class="mui-navigate-right">
                        <img class="device-logo" src="../images/appConfig/IPC3x.png">
                        <div class="channel-info">
                          <span class="channel-name">IPC-001</span>
                          <span class="channel-permissions">实况查看/云台控制/语音对讲/告警消息/录像查看/设备配置</span>
                          <span class="channel-endTime">永久的模板</span>
                        </div>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 按钮：分享按钮 -->
      <div class="batch-share-btn-content">
        <button id="editShareBtn" type="button" class="mui-btn batch-share-btn">确定</button>
      </div>

    </div>
  </div>
  <script src="../js/dsbridge.min.js"></script>
  <script src="../js/common.js"></script>
  <script src="../js/libs/md5.js"></script>
  <script src="../js/libs/jquery-3.4.1.min.js"></script>
  <script src="../js/libs/sha2.js"></script>
  <script src="../js/resource.js"></script>
  <script src="../js/Utils.js"></script>
  <script src="../js/mui.js"></script>
  <script src="../js/immersed.js"></script>
  <script src="../js/customSetting.js"></script>
  <script src="../js/loadCss.js"></script>
  <script src="../js/batchShareDeviceUtil.js"></script>
  <script id="langScript"></script>
  <script>
    var langTip;
    checkType(localStorage.AppType); //加载特定样式
    mui.init();
    // 获取语言文件
    var typeLan = initLang();
    langTip = typeLan.lang;

    dsBridgeFuncSyn.dismiss();

    var currentUserID; // 当前用户ID

    var oldSelectDeviceList = [];  // 在编辑前，该用户拥有的被分享设备数据
    var oldSelectChannelList = []; // 在编辑前，该用户拥有的被分享通道数据

    var allDevicesInfo = [];   // 所有的设备数据
    var allChannelsInfo = [];  // 所有的通道数据

    var isFirstToDeviceManage = true  // 是否为第一次进入设备管理页面

    // 初始化页面
    initPage()
    // 初始化数据
    initData();
    // 初始化事件
    initEvent()


    function initPage() {
      // 初始化滚动列表
      mui('.mui-scroll-wrapper').scroll();
      // 从上一个跳转页面中拿到用户 ID
      var Url = "web/newPages/batchSharedDeviceEdit.html";
      var self = dsBridgeFuncSyn.getWebParam(Url);
      // TODO:模拟数据
      if (isMock) {
        data = {
          userId: 111111111111111,
          userName: 'xujie',
          remark: '默认的备注'
        }
      } else {
        data = JSON.parse(self);
      }
      currentUserID = data.userId;
      $("#userName").text(data.userName);
      $("#userRemark").text(data.remark);
    }

    function initData() {
      getDeviceListByUserID()
    }

    function initEvent() {
      // 事件绑定：设备管理按钮的 tap 事件
      $('#editDeviceBtn').on('tap', function () {
        // 跳转页面：跳转到设备管理页面
        // 第一次进入设备管理页面不需要携带设备数据，直接在设备管理页面调用接口
        if (isFirstToDeviceManage) {
          var param = {
            operateType: 'edit-first',
            userId: currentUserID
          }
          isFirstToDeviceManage = false;
        } else {
          var param = {
            operateType: 'edit-more',
            userId: currentUserID,
            deviceList: allDevicesInfo,
            channelsList: allChannelsInfo
          }
        }
        dsBridgeFuncSyn.pageTo("web/newPages/manageDevice.html", JSON.stringify(param));
      })

      // 事件绑定：确定按钮的 tap  事件
      $('#editShareBtn').on('tap', editBatchDevice)
    }

    // 事件处理函数：批量编辑分享记录操作
    function editBatchDevice() {
      var sendData = {}
      sendData.shareUserId = currentUserID
      sendData.remark = $("#userRemark").text();
      var selectInfo = filterSelectedDevice(allDevicesInfo, allChannelsInfo)
      var editDeviceList = getEditRecordInfo(selectInfo.selectDeviceInfoArray, selectInfo.selectChannelsInfoArray);
      // 如果本次未修改任何设备信息，不调用接口，直接返回上一个页面
      if(editDeviceList.length == 0) {
        dsBridgeFuncSyn.backTo()
        return;
      }
      sendData.deviceList = editDeviceList
      console.log('最终得到的编辑列表%o', sendData.deviceList);
      editBatchDeviceAPI(sendData)
    }

    // 通过对比最初的数据，和最终的数据
    // 得到有哪些设备的信息发生了变化 增 删 改
    function getEditRecordInfo(selectDeviceInfoArray, selectChannelsInfoArray) {
      var allEditDeviceInfoList = []

      // 设备增加的数据
      selectDeviceInfoArray.forEach(function (deviceInfo) {
        var filterArray = oldSelectDeviceList.filter(function (oldDevice) {
          return oldDevice.deviceSerial == deviceInfo.deviceSerial;
        })
        if (filterArray.length == 0) {
          var deviceTmp = {}
          deviceTmp.deviceSerial = deviceInfo.deviceSerial;
          deviceTmp.shareName = deviceInfo.deviceName;
          deviceTmp.permission = deviceInfo.permission;
          deviceTmp.endTime = deviceInfo.endTime;
          deviceTmp.operateType = 0;
          allEditDeviceInfoList.push(deviceTmp)
        }
      })

      // 设备删除的数据
      oldSelectDeviceList.forEach(function (oldDevice) {
        var filterArray = selectDeviceInfoArray.filter(function (deviceInfo) {
          return deviceInfo.deviceSerial == oldDevice.deviceSerial;
        })
        if (filterArray.length == 0) {
          var deviceTmp = {}
          deviceTmp.deviceSerial = oldDevice.deviceSerial;
          deviceTmp.shareName = oldDevice.deviceName;
          deviceTmp.permission = oldDevice.permission;
          deviceTmp.endTime = oldDevice.endTime;
          deviceTmp.operateType = 1;
          allEditDeviceInfoList.push(deviceTmp)
        }
      })

      // 设备编辑的数据
      selectDeviceInfoArray.forEach(function (deviceInfo) {
        var filterArray = oldSelectDeviceList.filter(function (oldDevice) {
          return oldDevice.deviceSerial == deviceInfo.deviceSerial;
        })
        if (filterArray.length != 0) {
          if (!(isSamePermission(deviceInfo.permission, filterArray[0].permission) && deviceInfo.endTime == filterArray[0].endTime)) {
            var deviceTmp = {}
            deviceTmp.deviceSerial = deviceInfo.deviceSerial;
            deviceTmp.shareName = deviceInfo.deviceName;
            deviceTmp.permission = deviceInfo.permission;
            deviceTmp.endTime = deviceInfo.endTime;
            deviceTmp.operateType = 2;
            allEditDeviceInfoList.push(deviceTmp)
          }
        }
      })

      // 通道新增的数据
      selectChannelsInfoArray.forEach(function (channelsListInfo) {
        var filterArray = oldSelectChannelList.filter(function (oldChannelsList) {
          return channelsListInfo.deviceSerial == oldChannelsList.deviceSerial
        })
        // 整个 NVR通道 列表都是新增的
        if (filterArray.length == 0) {
          channelsListInfo.channelList.forEach(function (channelInfo) {
            var channelTmp = {}
            channelTmp.deviceSerial = channelsListInfo.deviceSerial;
            channelTmp.shareName = channelInfo.channelName;
            channelTmp.permission = channelInfo.permission;
            channelTmp.endTime = channelInfo.endTime;
            channelTmp.channelNo = channelInfo.channelNo;
            channelTmp.operateType = 0;
            allEditDeviceInfoList.push(channelTmp)
          })
        } else {
          // 可能其中的某个通道是新增的
          channelsListInfo.channelList.forEach(function (channelInfo) {
            var filterChannelArray = filterArray[0].channelList.filter(function (oldChannelInfo) {
              return channelInfo.channelNo == oldChannelInfo.channelNo
            })
            if (filterChannelArray.length == 0) {
              var channelTmp = {}
              channelTmp.deviceSerial = channelsListInfo.deviceSerial;
              channelTmp.shareName = channelInfo.channelName;
              channelTmp.permission = channelInfo.permission;
              channelTmp.endTime = channelInfo.endTime;
              channelTmp.channelNo = channelInfo.channelNo;
              channelTmp.operateType = 0;
              allEditDeviceInfoList.push(channelTmp)
            }
          })
        }
      })

      // 通道删除的数据
      oldSelectChannelList.forEach(function (oldChannelsList) {
        var filterArray = selectChannelsInfoArray.filter(function (channelsListInfo) {
          return channelsListInfo.deviceSerial == oldChannelsList.deviceSerial
        })
        // 整个 NVR 通道都被删除了
        if (filterArray.length == 0) {
          oldChannelsList.channelList.forEach(function (oldChannelInfo) {
            var channelTmp = {}
            channelTmp.deviceSerial = oldChannelsList.deviceSerial;
            channelTmp.shareName = oldChannelInfo.channelName;
            channelTmp.permission = oldChannelInfo.permission;
            channelTmp.endTime = oldChannelInfo.endTime;
            channelTmp.channelNo = oldChannelInfo.channelNo;
            channelTmp.operateType = 1;
            allEditDeviceInfoList.push(channelTmp)
          })
        } else {
          // 可能只是某个通道被删除了
          oldChannelsList.channelList.forEach(function (oldChannelInfo) {
            var filterChannelArray = filterArray[0].channelList.filter(function (channelInfo) {
              return channelInfo.channelNo == oldChannelInfo.channelNo
            })
            if (filterChannelArray.length == 0) {
              var channelTmp = {}
              channelTmp.deviceSerial = oldChannelsList.deviceSerial;
              channelTmp.shareName = oldChannelInfo.channelName;
              channelTmp.permission = oldChannelInfo.permission;
              channelTmp.endTime = oldChannelInfo.endTime;
              channelTmp.channelNo = oldChannelInfo.channelNo;
              channelTmp.operateType = 1;
              allEditDeviceInfoList.push(channelTmp)
            }
          })
        }
      })

      // 通道修改的数据
      selectChannelsInfoArray.forEach(function (channelsListInfo) {
        var filterArray = oldSelectChannelList.filter(function (oldChannelsList) {
          return channelsListInfo.deviceSerial == oldChannelsList.deviceSerial
        })
        //通过设备序列号找到相同的NVR通道列表
        if (filterArray.length != 0) {
          channelsListInfo.channelList.forEach(function (channelInfo) {
            var filterChannelArray = filterArray[0].channelList.filter(function (oldChannelInfo) {
              return channelInfo.channelNo == oldChannelInfo.channelNo
            })
            // 再次通过通道号找到相同的通道
            if (filterChannelArray.length != 0) {
              if (!(isSamePermission(channelInfo.permission, filterChannelArray[0].permission) && channelInfo.endTime == filterChannelArray[0].endTime)) {
                var channelTmp = {}
                channelTmp.deviceSerial = channelsListInfo.deviceSerial;
                channelTmp.shareName = channelInfo.channelName;
                channelTmp.permission = channelInfo.permission;
                channelTmp.endTime = channelInfo.endTime;
                channelTmp.channelNo = channelInfo.channelNo;
                channelTmp.operateType = 2;
                allEditDeviceInfoList.push(channelTmp)
              }
            }
          })
        }
      })

      return allEditDeviceInfoList;
    }

    // 判断两个字符串是否相等
    function isSamePermission(permission1, permission2) {
      var result = false
      var permission1Arr = permission1.split(",").sort()
      var permission2Arr = permission2.split(",").sort()
      if (permission1Arr.join("") == permission2Arr.join("")) {
        result = true
      }
      return result
    }

    // 接口：批量编辑分享记录接口
    function editBatchDeviceAPI(sendData) {
      dsBridgeFuncSyn.showLoading()
      CloudSendAjax(localStorage.serverAddress + openAPI.updateDeviceBatchShare, 'post', function (code, message, data) {
        if (code == 200) {
          // 编辑失败的设备信息
          var batchEditFailedDevice = data.updateResultList.filter(function(deviceInfo) {
            return deviceInfo.code != 200
          })
          if(batchEditFailedDevice.length == 0) {
            showToast("编辑信息成功")
          } else {
            batchEditFailedDevice.forEach(function(deviceInfo) {
              showToast("", deviceInfo.code);
            })
          }
          dsBridgeFuncSyn.dismiss();
          // 返回设备详情页面，并通知详情页面刷新数据
          dsBridgeFuncSyn.sendDataToReport("editDeviceInfoSuccess", "");
          dsBridgeFuncSyn.backTo()
        } else {
          // TODO: 需要补充当前没有的错误码
          addBitmap(0);
          showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
          dsBridgeFuncSyn.dismiss();
        }
      }, sendData)
    }



    // 根据 ID 获取设备信息
    function getDeviceListByUserID() {
      var sendData = {
        shareUserId: currentUserID
      }
      CloudSendAjax(localStorage.serverAddress + openAPI.getDeviceListByID, 'post', function (code, message, data) {
        // TODO:模拟数据
        if (isMock) {
          code = 200
          data = {
            shareDeviceList: [
              {
                "deviceSerial": "222222XXXXXXXXXXXXX1",
                "deviceName": "IPC被分享",
                "deviceType": 0,
                "shareChannelList": [
                  {
                    "shareId": "1",
                    "channelName": null,
                    "channelNo": null,
                    "endTime": 1575269125,
                    "permission": "Realplay,Replay,Talk,PtzControl,AlarmPush"
                  }
                ]
              },
              {
                "deviceSerial": "233333XXXXXXXXXXXXX1",
                "deviceName": "NVR卧室",
                "deviceType": 1,
                "shareChannelList": [
                  {
                    "shareId": "2",
                    "channelName": "通道1",
                    "channelNo": 1,
                    "endTime": 1575269125,
                    "permission": "Realplay,Replay,Talk,PtzControl,AlarmPush"
                  },
                  {
                    "shareId": "3",
                    "channelName": "通道2",
                    "channelNo": 2,
                    "endTime": 1575288869,
                    "permission": "Realplay,Replay,Talk"
                  }
                ]
              },
              {
                "deviceSerial": "244444XXXXXXXXXXXXX1",
                "deviceName": "NVR2在卧室",
                "deviceType": 1,
                "shareChannelList": [
                  {
                    "shareId": "4",
                    "channelName": null,
                    "channelNo": null,
                    "endTime": 1575269125,
                    "permission": "Realplay,Replay,Talk,PtzControl,AlarmPush,Config"
                  },
                  {
                    "shareId": "5",
                    "channelName": "通道3",
                    "channelNo": 3,
                    "endTime": 1575288869,
                    "permission": "Realplay,Replay,Talk,PtzControl,AlarmPush"
                  }
                ]
              }
            ]
          }
        }
        if (code == 200) {
          // 加工数据
          var selectInfo = transformData(data.shareDeviceList)
          oldSelectDeviceList = deepCopy(selectInfo.selectDeviceInfoList)
          allDevicesInfo = deepCopy(selectInfo.selectDeviceInfoList)
          oldSelectChannelList = deepCopy(selectInfo.selectChannelInfoList)
          allChannelsInfo = deepCopy(selectInfo.selectChannelInfoList)
          console.log('编辑前的设备列表%o', oldSelectDeviceList);
          console.log('编辑前的通道列表%o', oldSelectChannelList);
          buildSelectDeviceList(oldSelectDeviceList)
          buildSelectChannelsList(oldSelectChannelList)
          $('#EZView-content').removeClass('mui-hidden')
          dsBridgeFuncSyn.dismiss();
        } else {
          addBitmap(0);
          showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
          dsBridgeFuncSyn.dismiss();
        }
      }, sendData)
    }

    // 将服务端的数据加工成合适的结构
    function transformData(shareDeviceList) {
      var selectDeviceInfoList = [];
      var selectChannelInfoList = [];
      shareDeviceList.forEach((item) => {
        // 设备类型为1时，NVR通道和NVR设备的信息都放在一起，需要挑选出来
        if (item.deviceType == 1) {
          item.shareChannelList.forEach(function (channelInfo, index) {
            // NVR 设备信息
            if (channelInfo.channelNo == null) {
              var deviceInfoTmp = {}
              deviceInfoTmp.deviceSerial = item.deviceSerial;
              deviceInfoTmp.deviceName = item.deviceName;
              deviceInfoTmp.deviceType = item.deviceType;
              deviceInfoTmp.permission = channelInfo.permission;
              deviceInfoTmp.endTime = channelInfo.endTime;
              deviceInfoTmp.isShared = 1;
              item.shareChannelList.splice(index, 1)
              selectDeviceInfoList.push(deviceInfoTmp)
            }
          })
          // 如果余下的数组中还有数据，则说明是NVR通道的数据
          if (item.shareChannelList.length > 0) {
            var channelListInfoTmp = {}
            channelListInfoTmp.deviceSerial = item.deviceSerial;
            channelListInfoTmp.deviceName = item.deviceName;
            channelListInfoTmp.deviceType = item.deviceType;
            channelListInfoTmp.channelList = [];
            item.shareChannelList.forEach(function (channelInfo) {
              var channelInfoTmp = {}
              channelInfoTmp.channelName = channelInfo.channelName;
              channelInfoTmp.channelNo = channelInfo.channelNo;
              channelInfoTmp.permission = channelInfo.permission;
              channelInfoTmp.endTime = channelInfo.endTime;
              channelInfoTmp.isShared = 1;
              channelListInfoTmp.channelList.push(channelInfoTmp)
            })
            selectChannelInfoList.push(channelListInfoTmp)
          }
        } else {
          var deviceInfoTmp = {}
          deviceInfoTmp.deviceSerial = item.deviceSerial;
          deviceInfoTmp.deviceName = item.deviceName;
          deviceInfoTmp.deviceType = item.deviceType;
          deviceInfoTmp.permission = item.shareChannelList[0].permission;
          deviceInfoTmp.endTime = item.shareChannelList[0].endTime;
          deviceInfoTmp.isShared = 1;
          selectDeviceInfoList.push(deviceInfoTmp)
        }
      });
      return {
        selectDeviceInfoList: selectDeviceInfoList,
        selectChannelInfoList: selectChannelInfoList
      }
    }



    // 生成设备列表
    function buildSelectDeviceList(selectDeviceInfoList) {
      // 避免数据叠加：每次渲染前将之前的生成的 DOM 结构清除
      $('#selectDeviceListUL li:not(.mui-hidden)').remove()
      var ulDom = $('#selectDeviceListUL');
      selectDeviceInfoList.forEach((deviceInfo) => {
        // 克隆模板
        var deviceTemplate = $('.device-card-template').clone();
        deviceTemplate.removeClass('device-card-template mui-hidden');
        var imgUrl = ""
        // TODO: 后续门铃门禁可能会有自己的专属图标
        switch (deviceInfo.deviceType) {
          case 0:
            imgUrl = "../images/appConfig/IPC3x.png"
            break;
          case 1:
            imgUrl = "../images/appConfig/NVR3x.png"
            break;
          case 6:
            imgUrl = "../images/appConfig/IPC3x.png"
            break;
          case 7:
            imgUrl = "../images/appConfig/IPC3x.png"
            break;
          default:
            imgUrl = "../images/appConfig/IPC3x.png"
        }
        // 填充值：设备图片信息
        deviceTemplate.find("img").attr("src", imgUrl)
        // 填充值：设备名称
        deviceTemplate.find(".device-name").text(deviceInfo.deviceName)
        // 填充值：设备权限
        deviceTemplate.find(".device-permissions").text(changePermissionToText(deviceInfo.permission))
        // 填充值：设备有效期
        deviceTemplate.find(".device-endTime").text(deviceInfo.endTime)
        // 事件绑定：点击设备卡片的 tap 事件
        deviceTemplate.on('tap', updateDevicePermission)
        // 添加属性：设备序列号
        deviceTemplate.attr("data-deviceSerial", deviceInfo.deviceSerial)
        // 插入列表中
        ulDom.append(deviceTemplate)
      })
    }

    // 事件处理函数；点击设备卡片，想要修改权限
    function updateDevicePermission() {
      var currentDeviceSerial = $(this).attr("data-deviceSerial")
      var currentDeviceInfo = allDevicesInfo.filter(function (deviceInfo) {
        return deviceInfo.deviceSerial == currentDeviceSerial
      })
      // 跳转页面：跳转到权限管路页面, 携带被点击设备的信息
      var param = {
        deviceInfo: currentDeviceInfo[0],
        operateType: 'updateTimeAndPermission'
      }
      console.log("被点击设备卡片的数据%o", param.deviceInfo);
      dsBridgeFuncSyn.pageTo("web/newPages/devicePermissionManage.html", JSON.stringify(param));
    }

    function buildSelectChannelsList(selectChannelsInfoList) {
      // 避免数据叠加：每次渲染前将之前的生成的 DOM 结构清除
      $('#selectChannelListUL li:not(.mui-hidden)').remove()
      var ulDom = $('#selectChannelListUL');
      selectChannelsInfoList.forEach(function (channelsListInfo) {
        // 克隆模版: 通道列表
        var channelsListTemplate = $('.NVR-channels-list-card-template').clone();
        channelsListTemplate.removeClass('NVR-channels-list-card-template mui-hidden');
        // 移除掉通道数据的模版
        channelsListTemplate.remove(".NVR-channels-card-template.mui-hidden")
        // 填充值：通道所属 NVR 设备的名字
        channelsListTemplate.find('.NVR-channels-list-name').text(channelsListInfo.deviceName);
        // 添加属性：NVR 的设备序列号
        channelsListTemplate.attr("data-deviceSerial", channelsListInfo.deviceSerial)

        channelsListInfo.channelList.forEach(function (channelInfo) {
          var NVRListUlDom = channelsListTemplate.find('.NVR-channel-list-ul');
          // 克隆模版：通道
          var channelTemplate = $('.NVR-channels-card-template').clone();
          channelTemplate.removeClass('NVR-channels-card-template mui-hidden');
          // 填充值：NVR 通道的名字
          channelTemplate.find(".channel-name").text(channelInfo.channelName);
          // 填充值：通道的权限信息
          channelTemplate.find(".channel-permissions").text(changePermissionToText(channelInfo.permission))
          // 填充值：通道的有效期
          channelTemplate.find(".channel-endTime").text(channelInfo.endTime)
          // 添加属性：通道号
          channelTemplate.attr("data-channelNo", channelInfo.channelNo)
          // 事件绑定：点击通道卡片的 tap 事件
          channelTemplate.on('tap', updateChannelPermission)
          // 通道插入通道 List 中
          NVRListUlDom.append(channelTemplate);
        })
        ulDom.append(channelsListTemplate);
      })
    }

    // 事件处理函数：更改被点击通道的权限
    function updateChannelPermission() {
      currentDeviceSerial = $(this).parents(".mui-collapse").attr("data-deviceSerial")
      currentChannelNo = $(this).attr("data-channelNo")
      var channelInfoTemp = {}
      allChannelsInfo.forEach(function (channelListInfo) {
        if (channelListInfo.deviceSerial == currentDeviceSerial) {
          channelListInfo.channelList.forEach(function (channelInfo) {
            if (channelInfo.channelNo == currentChannelNo) {
              channelInfoTemp = deepCopy(channelInfo)
              channelInfoTemp.deviceSerial = currentDeviceSerial
            }
          })
        }
      })
      // 跳转页面：跳转到权限管路页面, 携带被点击设备的信息
      var param = {
        deviceInfo: channelInfoTemp,
        operateType: 'updateTimeAndPermission'
      }
      console.log("被点击通道卡片的数据%o", param.deviceInfo);
      dsBridgeFuncSyn.pageTo("web/newPages/devicePermissionManage.html", JSON.stringify(param));
    }

    // 函数是有副作用的，直接在实参的基础上添加有效期
    function addEndTimeToNewDevice(deviceInfoArray, channelInfoArray) {
      // 使用 2023-12-31 23:59:59 来代表永久
      var forever = 4102415999

      // 给设备信息上添加有效期
      deviceInfoArray.forEach(function (deviceInfo) {
        // 设备目前被勾选，给设备正确的有效时间
        if (deviceInfo.isShared == 1) {
          var filterArray = allDevicesInfo.filter(function (oldDevice) {
            return oldDevice.deviceSerial == deviceInfo.deviceSerial && oldDevice.isShared == 1
          })
          // 该设备在本次编辑前就被勾选，将之前的权限赋值给当前设备
          if (filterArray.length > 0) {
            deviceInfo.endTime = filterArray[0].endTime
          } else { // 该设备在本次编辑前未被勾选过，给默认的永久权限
            deviceInfo.endTime = forever
          }
        } else { // 设备目前未被勾选，去掉设备上的有效时间
          deviceInfo.endTime = undefined
        }
      })

      // 给通道信息上添加有效期
      channelInfoArray.forEach(function (channelsListInfo) {
        channelsListInfo.channelList.forEach(function (channelInfo) {
          // 1. 只对被选中的通道进行操作
          if (channelInfo.isShared == 1) {
            var filterListArray = allChannelsInfo.filter(function (oldChannelsList) {
              return oldChannelsList.deviceSerial == channelsListInfo.deviceSerial;
            })
            // 1.1 在本次操作前就存在该 NVR 列表数据
            // ！！！本次操作指的进入管理设备页面并点击 “下一步”
            if (filterListArray.length > 0) {
              var filterArray = filterListArray[0].channelList.filter(function (oldChannel) {
                return oldChannel.channelNo == channelInfo.channelNo && oldChannel.isShared == 1
              })
                // 1.1.1 在本次操作前就存在该 NVR 通道数据。将本次操作前的分享有效期赋值给当前
              if (filterArray.length > 0) {
                channelInfo.endTime = filterArray[0].endTime
              } else {
                // 1.1.2 在本次操作前不存在该 NVR 通道数据。赋值默认值： “永久”
                channelInfo.endTime = forever
              }
            } else {
              // 1.2 在本次操作前不存在该 NVR 列表数据。赋值默认值： “永久”
              channelInfo.endTime = forever
            }
          } else {
          // 2. 未被选中的通道需要将有效时间清空
            channelInfo.endTime = undefined
          }
        })
      })
    }

    /******************新增原生App上报Web功能接口******************/
    // 监听原生侧上报数据
    dsBridge.register("callWebDoFuncAsyn", function (args) {
      appLog("Web --- args: " + args);
      var webInfo = JSON.parse(args);
      for (var key in webInfo) {
        switch (webInfo[key].whichInfo) {
          // 管理界面选择的数据在当前页面进行展示
          case "addSelectDeviceChannels":
            var param = JSON.parse(webInfo[key].infoValue);
            addEndTimeToNewDevice(param.deviceList, param.channelsList)
            allDevicesInfo = param.deviceList;
            allChannelsInfo = param.channelsList;
            // 首次被添加的数据上需要被添加默认最全的权限
            addPermissionToNewDevice(allDevicesInfo, allChannelsInfo)
            // 从所有的设备&&通道信息中筛选中 被选中的
            var selectDeviceChannelInfo = filterSelectedDevice(allDevicesInfo, allChannelsInfo)
            // 生成设备列表
            buildSelectDeviceList(selectDeviceChannelInfo.selectDeviceInfoArray);
            // 生成通道列表
            buildSelectChannelsList(selectDeviceChannelInfo.selectChannelsInfoArray);
            break;
          // 修改设备的权限
          case "updateDevicePermission":
            var param = JSON.parse(webInfo[key].infoValue);
            if (param.deviceInfo.channelNo != undefined) {
              // 更新通道的数据
              allChannelsInfo.forEach(function (channelsListInfo) {
                if (channelsListInfo.deviceSerial == param.deviceInfo.deviceSerial) {
                  channelsListInfo.channelList.forEach(function (channelInfo) {
                    if (channelInfo.channelNo == param.deviceInfo.channelNo) {
                      channelInfo.permission = param.deviceInfo.permission;
                      channelInfo.endTime = param.deviceInfo.endTime;
                    }
                  })
                }
              })
              var selectInfo = filterSelectedDevice(allDevicesInfo, allChannelsInfo)
              buildSelectChannelsList(selectInfo.selectChannelsInfoArray)
            } else {
              // 更新设备的信息
              allDevicesInfo.forEach(function (deviceInfo) {
                if (deviceInfo.deviceSerial == param.deviceInfo.deviceSerial) {
                  deviceInfo.permission = param.deviceInfo.permission;
                  deviceInfo.endTime = param.deviceInfo.endTime;
                }
              })
              var selectInfo = filterSelectedDevice(allDevicesInfo, allChannelsInfo)
              buildSelectDeviceList(selectInfo.selectDeviceInfoArray)
            }
            break;
          case "deviceStatus": // 更新设备在线状态
            localStorage.deviceStatus = webInfo[key].infoValue;
            break;
          case "ip": // 更新ip
            localStorage.Ip = webInfo[key].infoValue;
            break;
          case "port": // 更新port
            localStorage.Port = webInfo[key].infoValue;
            break;
          case "logInfo": //更新登录信息
            localStorage.logInfo = webInfo[key].infoValue;
            break;
          case "deviceName": //更新设备名称
            var deviceName = document.getElementById("deviceName");
            break;
          case "sdkType": //更新SDK类型
            localStorage.sdkType = webInfo[key].infoValue;
            break;
          case "isNetConnect": //更新手机是否联网
            localStorage.isNetConnect = webInfo[key].infoValue;
            break;
          case "hasNewVersion": //是否有新版本
            localStorage.hasNewVersion = webInfo[key].infoValue;
            break;
          case "versionNumber": //当前版本号
            localStorage.versionNumber = webInfo[key].infoValue;
            break;
          case "LocalDeviceUname": //免注册设备用户名更新
            localStorage.LocalDeviceUname = webInfo[key].infoValue;
            break;
          case "deviceOs": //设备云端在线状态 “true”在线，“false”离线
            localStorage.deviceOs = webInfo[key].infoValue;
            break;
          case "updateChannelName": // TODO：通道名称修改成功后，主页同步更新
            localStorage.deviceName = webInfo[key].infoValue;
            break;
          case "workingStatus":
            localStorage.workingStatus = webInfo[key].infoValue;
            break;
          case "channelStatus":
            localStorage.channelStatus = webInfo[key].infoValue;
            break;
          default:
            break;
        }
      }
    })

  </script>
</body>

</html>