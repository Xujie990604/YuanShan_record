<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title></title>
  <link href="../css/mui.css" rel="stylesheet" />
  <link href="../css/iconfont.css" rel="stylesheet" />
  <link href="../css/Common.css" rel="stylesheet" />
  <link href="../css/theme_normal.css" rel="stylesheet" />
  <style>
    .mui-table-view-cell .ui-tip {
      position: absolute;
      right: 0px;
      z-index: 100;
      width: 100% !important;
      background: transparent !important;
    }

    .noFileImg {
      position: absolute;
      top: 30%;
      width: 60%;
      left: 20%;
    }

    .noFileImg img {
      width: 100%;
    }

    .mui-checkbox input[type='checkbox']:before {
      content: '';
    }

    .mui-input-row.mui-input-range {
      padding-left: 15px;
      padding-right: 15px;
    }

    .mui-input-range input[type='range']::-webkit-slider-thumb {
      width: 15px !important;
      height: 15px !important;
      background: #fff !important;
      border: solid 1px #50D0C1 !important;
    }

    .InputDiv {
      margin-top: 10px;
      margin-left: 16px;
      margin-right: 16px;
      border-radius: 8px;
      background-color: #FFFFFF;
    }

    .low-height-style {
      display: flex;
      justify-content: space-between;
      margin: 0px 15px;
      font-size: 14px;
    }

    .mui-input-range .mui-tooltip {
      display: none !important;
    }

    #SensitivityText {
      font-size: 16px;
      padding-left: 15px;
      padding-top: 8px;
    }

    .height-text {
      margin-bottom: 12px;
    }

    input[type=range] {
      -webkit-appearance: none;
      height: 3px;
    }

    .mui-input-range input[type='range'] {
      height: 4px;
      background: -webkit-linear-gradient(#50D0C1, #50D0C1) no-repeat, rgba(51, 51, 51, 0.08);
      background-color: rgba(51, 51, 51, 0.08);
    }
  </style>
</head>

<body>
  <header class="mui-bar mui-bar-nav">
    <a id="back" class="mui-icon iconfont icon-back1"></a>
    <h1 id="title" class="mui-title" data-text="WEB_soundDetecion">&nbsp;</h1>
  </header>
  <div class="mui-content">
    <div id="EZView-content" class="mui-hidden">
      <!--越界检测-->
      <ul id="setAudioDetecionCheck" class="mui-table-view ui-siwtchlist">
        <li id="setAudioDetecionDetection" class="mui-table-view-cell">
          <span data-text="WEB_soundDetecion" class="mainStyle">&nbsp;</span>
          <div id="setAudioDetecionDetectionSwitch" class="mui-switch mui-switch-mini">
            <div class="mui-switch-handle" id="setAudioDetecionDetectionCircle"></div>
          </div>
          <div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
        </li>
      </ul>
      <div class="InputDiv mui-hidden" id="InputDiv">
        <div id="SensitivityText" data-text="WEB_Sensitivity">
          &nbsp;
        </div>
        <div class="mui-input-row mui-input-range">
          <input type="range" min="0" max="400" id="audioDetecionSensitivityValue">
        </div>
        <div id="" class="low-height-style">
          <div id="" class="height-text" data-text="WEB_Low">
            &nbsp;
          </div>
          <div id="" data-text="WEB_High">
            &nbsp;
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="../js/dsbridge.min.js"></script>
  <script src="../js/common.js"></script>
  <script src="../js/libs/md5.js"></script>
  <script src="../js/libs/jquery-3.4.1.min.js"></script>
  <script src="../js/resource.js"></script>
  <script src="../js/Utils.js"></script>
  <script src="../js/mui.js"></script>
  <script src="../js/immersed.js"></script>
  <script src="../js/customSetting.js"></script>
  <script src="../js/loadCss.js "></script>
  <script id="langScript"></script>
  <script>
    var langTip;
    checkType(localStorage.AppType); //加载特定样式
    //越界检测
    var AudioDetecionGridService = {};
    var setAudioDetecionDetectionConfirm = true; //越界检测开关状态变化时是否调接口提交
    var AudioDetecionDetectionServiceData; //越界检测使能服务端数据
    var AudioDetecionDetectionCheck; // 越界检测开关是否开启
    var audioDetecionSensitivityEl;
    mui.init();
    var typeLan = initLang();
    langTip = typeLan.lang;
    initPage();
    initData();
    initEvent();

    function initPage() {
      audioDetecionSensitivityEl = document.getElementById("audioDetecionSensitivityValue");
    }

    function initData() {
      initAudioDetecionDetection();
    }

    function initEvent() {
      $("#audioDetecionSensitivityValue").on('touchend', function () {
        rangeVal = this.value;
        var percent = Math.round(rangeVal) / 4 + "%";
        audioDetecionSensitivityEl.style.backgroundSize = percent + " 100%";
        console.log(rangeVal);
        setAudioDetecionSensitivityValue(rangeVal);
      });
      $("#audioDetecionSensitivityValue").on('touchmove', function () {
        rangeVal = this.value;
        var percent = Math.round(rangeVal) / 4 + "%";
        audioDetecionSensitivityEl.style.backgroundSize = percent + " 100%";
      });
    }

    /******************************************越界检测-使能********************************************/
    /*
     * 初始化  越界检测使能
     */
    function initAudioDetecionDetection() {
      initAudioDetecionDetectionData();
    }

    /**
     * 初始化 越界检测使能数据
     * @param {Object} 
     */
    function initAudioDetecionDetectionData() {
      SendAjax(LAPI.AudioDetectionRule, 'get', function (code, data) {
        if (code == 0) {
          $("#EZView-content").removeClass("mui-hidden");
          AudioDetecionDetectionServiceData = deepCopy(data);
          AudioDetecionDetectionCheck = data.Enabled; // 0：关闭，1：开启
          //初始化运动检测开关
          document.getElementById("setAudioDetecionDetectionSwitch").style.zIndex = 20;
          document.getElementById("setAudioDetecionDetectionSwitch").style.visibility = "visible";
          setAudioDetecionDetectionConfirm = false;
          setSwitchStatus("setAudioDetecionDetectionSwitch", AudioDetecionDetectionCheck);
          setAudioDetecionDetectionConfirm = true;
          var setAudioDetecionDetectionActive = document.getElementById("setAudioDetecionDetectionSwitch").classList.contains("mui-active");
          if (setAudioDetecionDetectionActive) {
            document.getElementById("setAudioDetecionDetectionCircle").style.transform = 'translate(16px, 0px)';
            $("#InputDiv").removeClass("mui-hidden");
          }
          var value;
          //初始化音量配置
          if (AudioDetecionDetectionServiceData.DetectType == 3) {
            value = AudioDetecionDetectionServiceData.Threshold;
          } else {
            value = AudioDetecionDetectionServiceData.DiffValue;
          }
          audioDetecionSensitivityEl.value = 400 - value;
          var percent = Math.round(400 - value) / 4 + "%";
          audioDetecionSensitivityEl.style.backgroundSize = percent + " 100%";
          dsBridgeFuncSyn.dismiss();
        } else {
          //数据获取失败的处理
						if(code == 4 || code == 8 || code == 1006) {
            addBitmap(1, langTip["WEB_unSupported"]);
          } else {
            addBitmap(0);
          }
          showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
          dsBridgeFuncSyn.dismiss();
        }
      });
    }
    /*
     * 监听越界检测开关
     */
    document.getElementById("setAudioDetecionDetectionSwitch").addEventListener("toggle", function (event) {
      if (event.detail.isActive && setAudioDetecionDetectionConfirm) {
        var sendDataON = deepCopy(AudioDetecionDetectionServiceData);
        sendDataON.Enabled = 1; // 0：越界检测关闭，1：越界检测开启
        dsBridgeFuncSyn.showLoading();
        SendAjax(LAPI.AudioDetectionRule, 'put', function (code, data) {
          dsBridgeFuncSyn.dismiss();
          if (code == 0) {
            AudioDetecionDetectionServiceData.Enabled = 1;
            $("#InputDiv").removeClass("mui-hidden");
            showToast(langTip["WEB_api_error_succeeded"]);
          } else {
            setAudioDetecionDetectionConfirm = false;
            showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
            setTimeout(function () {
              mui("#setAudioDetecionDetectionSwitch").switch().toggle();
            }, 200);
          }
        }, sendDataON);
      } else if (!event.detail.isActive && setAudioDetecionDetectionConfirm) {
        if (localStorage.dvt != 100) {
          mui("#setAudioDetecionCheck .mui-table-view-cell").each(function (index, El) {
            if (index != 0) {
              El.classList.add('mui-hidden');
            }
          });
        }
        var sendDataOFF = deepCopy(AudioDetecionDetectionServiceData);
        $("#InputDiv").addClass("mui-hidden");
        sendDataOFF.Enabled = 0; // 0：越界检测关闭，1：越界检测开启
        dsBridgeFuncSyn.showLoading();
        SendAjax(LAPI.AudioDetectionRule, 'put', function (code, data) {
          dsBridgeFuncSyn.dismiss();
          if (code == 0) {
            AudioDetecionDetectionServiceData.Enabled = 0;
            showToast(langTip["WEB_api_error_succeeded"]);
          } else {
            $("#InputDiv").removeClass("mui-hidden");
            setAudioDetecionDetectionConfirm = false;
            showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
            setTimeout(function () {
              mui("#setAudioDetecionDetectionSwitch").switch().toggle();
            }, 300);
          }
        }, sendDataOFF);
      } else {
        setAudioDetecionDetectionConfirm = true;
      };
    });
    /**
     * 配置灵敏度
     * @param {Number} vals 
     */
    function setAudioDetecionSensitivityValue(vals) {
      dsBridgeFuncSyn.showLoading();
      var outPutValue = 400 - vals;
      outPutValue = Math.round(outPutValue);
      var sendData = deepCopy(AudioDetecionDetectionServiceData);
      var value = outPutValue;
      //初始化音量配置
      if (sendData.DetectType == 3) {
        sendData.Threshold = value;
      } else {
        sendData.DiffValue = value;
      }
      SendAjax(LAPI.AudioDetectionRule, 'put', function (code, data) {
        dsBridgeFuncSyn.dismiss();
        if (code == 0) {
          if (sendData.DetectType == 3) {
            AudioDetecionDetectionServiceData.Threshold = value;
          } else {
            AudioDetecionDetectionServiceData.DiffValue = value;
          }
          showToast(langTip["WEB_api_error_succeeded"], code);
        } else {
          if (sendData.DetectType == 3) {
            audioDetecionSensitivityEl.value = AudioDetecionDetectionServiceData.Threshold;
          } else {
            audioDetecionSensitivityEl.value = AudioDetecionDetectionServiceData.DiffValue;
          }
          var value = audioDetecionSensitivityEl.value;
          audioDetecionSensitivityEl.value = 400 - value;
          var percent = Math.round(400 - value) / 4 + "%";
          audioDetecionSensitivityEl.style.backgroundSize = percent + " 100%";
          showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
        }
      }, sendData)
    }

    /**
     * 监听绘图数据变更并记录
     */
    window.addEventListener('updateAudioDetecionGrid', function (event) {
      //获得事件参数
      var AudioDetecionGrid_Bak = event.detail.AudioDetecionGrid_Bak;
      AudioDetecionGridService = AudioDetecionGrid_Bak;
    });

    /******************新增原生App上报Web功能接口******************/
    //TODO:监听原生侧上报事件
    dsBridge.register("callWebDoFuncAsyn", function (args) {
      appLog("Web --- args: " + args);
      var webInfo = JSON.parse(args);
      for (var key in webInfo) {
        switch (webInfo[key].whichInfo) {
          case "updateAudioDetecionGrid": // 绘图数据发还给运检测配置页面
            var param = JSON.parse(webInfo[key].infoValue);
            AudioDetecionGridService = param.AudioDetecionGrid_Bak;
            break;
          case "deviceStatus": // 更新设备在线状态
            localStorage.deviceStatus = webInfo[key].infoValue;
            break;
          case "ip": // 更新ip
            localStorage.Ip = webInfo[key].infoValue;
            break;
          case "port": // 更新port
            localStorage.Port = webInfo[key].infoValue;
            break;
          case "logInfo": //更新登录信息
            localStorage.logInfo = webInfo[key].infoValue;
            break;
          case "deviceName": //更新设备名称
            var deviceName = document.getElementById("deviceName");
            break;
          case "sdkType": //更新SDK类型
            localStorage.sdkType = webInfo[key].infoValue;
            break;
          case "isNetConnect": //更新手机是否联网
            localStorage.isNetConnect = webInfo[key].infoValue;
            break;
          case "hasNewVersion": //是否有新版本
            localStorage.hasNewVersion = webInfo[key].infoValue;
            break;
          case "versionNumber": //当前版本号
            localStorage.versionNumber = webInfo[key].infoValue;
            break;
          case "LocalDeviceUname": //免注册设备用户名更新
            localStorage.LocalDeviceUname = webInfo[key].infoValue;
            break;
          case "deviceOs": //设备云端在线状态 “true”在线，“false”离线
            localStorage.deviceOs = webInfo[key].infoValue;
            break;
          case "updateChannelName": // TODO：通道名称修改成功后，主页同步更新
            localStorage.deviceName = webInfo[key].infoValue;
            break;
						case "workingStatus":
							localStorage.workingStatus = webInfo[key].infoValue;
							break;
						case "channelStatus":
							localStorage.channelStatus = webInfo[key].infoValue;
							break;
          default:
            break;
        }
      }
    })
  </script>
</body>

</html>