<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title></title>
  <link href="../css/mui.css" rel="stylesheet" />
  <link href="../css/iconfont.css" rel="stylesheet" />
  <link href="../css/Common.css" rel="stylesheet" />
  <link href="../css/theme_normal.css" rel="stylesheet" />
  <style>
    .device-info {
      display: flex;
      flex-direction: row;
      justify-self: center;
      align-items: center;
      width: 94%;
      margin-left: 3%;
      background-color: #fff;
      border-radius: 8px;
      margin-top: 20px;
    }

    .device-info img {
      height: 48px;
    }

    .tip {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      margin: 12px 0;
    }

    .select-all {
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      align-items: center;
      width: 100px;
    }

    .device-permission-list {
      display: flex;
      flex-direction: column;
      width: 96%;
      margin-left: 3%;
    }

    .device-permission-list .mui-input-row {
      border-radius: 8px;
      background-color: #fff;
      display: flex;
      flex-direction: row;
      justify-content: center;
      margin-bottom: 12px;
    }

    .device-permission-list img {
      height: 48px;
    }
  </style>
</head>

<body>
  <!-- 页面标题 -->
  <header class="mui-bar mui-bar-nav">
    <a id="back" class="mui-icon iconfont icon-back1"></a>
    <h1 id="title" class="mui-title" data-text="">权限管理</h1>
    <a id="saveBtn" class="save-permission-btn mui-pull-right">保存</a>
  </header>
  <div class="mui-content">
    <div id="EZView-content" class="">
      <!-- 设备信息 -->
      <div class="device-info">
        <img id="deviceImg" src="">
        <div id="deviceName" class="device-name"></div>
      </div>
      <div class="endTime-tip">
        分享有效期
      </div>
      <input id="endTimeInput" class="mui-hidden" type="text">
      <div class="tip">
        <span>选择你想要分享的权限</span>
        <div class="mui-input-row mui-checkbox select-all">
          <input id="selectAllBtn" type="checkbox">
          <label>全选</label>
        </div>
      </div>
      <!-- 设备权限列表 -->
      <div id="devicePermissionList" class="device-permission-list">
        <div class="mui-input-row mui-checkbox mui-hidden">
          <img src="../images/automatic_tracking.png">
          <label>实况查看</label>
          <input value="Realplay" type="checkbox">
        </div>
        <div class="mui-input-row mui-checkbox mui-hidden">
          <img src="../images/automatic_tracking.png">
          <label>云台控制</label>
          <input value="PtzControl" type="checkbox">
        </div>
        <div class="mui-input-row mui-checkbox mui-hidden">
          <img src="../images/automatic_tracking.png">
          <label>语音对讲</label>
          <input value="Talk" type="checkbox">
        </div>
        <div class="mui-input-row mui-checkbox mui-hidden">
          <img src="../images/automatic_tracking.png">
          <label>告警消息</label>
          <input value="AlarmPush" type="checkbox">
        </div>
        <div class="mui-input-row mui-checkbox mui-hidden">
          <img src="../images/automatic_tracking.png">
          <label>录像查看</label>
          <input value="Replay" type="checkbox">
        </div>
        <div class="mui-input-row mui-checkbox mui-hidden">
          <img src="../images/automatic_tracking.png">
          <label>设备配置</label>
          <input value="Config" type="checkbox">
        </div>
      </div>
    </div>
  </div>
  <script src="../js/dsbridge.min.js"></script>
  <script src="../js/common.js"></script>
  <script src="../js/libs/md5.js"></script>
  <script src="../js/libs/jquery-3.4.1.min.js"></script>
  <script src="../js/libs/sha2.js"></script>
  <script src="../js/resource.js"></script>
  <script src="../js/Utils.js"></script>
  <script src="../js/mui.js"></script>
  <script src="../js/immersed.js"></script>
  <script src="../js/customSetting.js"></script>
  <script src="../js/loadCss.js"></script>
  <script src="../js/batchShareDeviceUtil.js"></script>
  <script id="langScript"></script>
  <script>
    var langTip;
    checkType(localStorage.AppType); //加载特定样式
    mui.init();
    // 获取语言文件
    var typeLan = initLang();
    langTip = typeLan.lang;


    var deviceInfo = {} // 当前被编辑设备的信息
      var operateType = ""  
    var permissionString = "" // 当前设备类型拥有的最大权限集合


    // 初始化页面
    initPage()
    // 初始化事件
    initEvent()


    function initPage() {
      if (isMock) {
        deviceInfo = {
          deviceName: "IPC被分享",
          deviceSerial: "222222XXXXXXXXXXXXX1",
          deviceType: 0,
          isShared: 1,
          permission: "Realplay,Replay,Talk,PtzControl,AlarmPush,Config",
          endTime: 1697766880
        }

        operateType = 'updateTimeAndPermission'
        operateType = 'updatePermission'
        // deviceInfo = {
        //   channelName: "通道1",
        //   channelNo: "1",
        //   isShared: 1,
        //   permission: "Realplay,Replay,Talk,PtzControl",
        //   deviceSerial: "233333XXXXXXXXXXXXX1"
        // }
      } else {
        // 从上一个跳转页面中拿取数据
        var Url = "web/newPages/devicePermissionManage.html";
        var self = dsBridgeFuncSyn.getWebParam(Url);
        data = JSON.parse(self)
        deviceInfo = data.deviceInfo
        operateType = data.operateType
      }

      if (operateType == 'updateTimeAndPermission') {
        $('#endTimeInput').val(deviceInfo.endTime)
        $('#endTimeInput').removeClass('mui-hidden');
      }


      // 更改图片：根据设备类型
      if (deviceInfo.deviceType == 1) {
        $("#deviceImg").attr("src", "../images/appConfig/NVR3x.png")
      } else {
        $("#deviceImg").attr("src", "../images/appConfig/IPC3x.png")
      }

      // 更改设备名称
      deviceInfo.deviceName ? $("#deviceName").text(deviceInfo.deviceName) : $("#deviceName").text(deviceInfo.channelName)

      // 根据不同的设备类型，来渲染权限列表的展示
      var deviceTypePermissionEnum = {
        IPC: 'Realplay,Replay,Talk,PtzControl,AlarmPush,Config', // IPC  deviceType 0
        NVR: 'Realplay,Replay,Talk,PtzControl,AlarmPush,Config', // NVR  deviceType 1
        channel: 'Realplay,Replay,Talk,PtzControl,AlarmPush',              // NVR 通道  channelNo 
        Access: "Realplay,Replay,Talk,AlarmPush",                // 门禁设备   deviceType 6
        doorbell: "Realplay,Replay,Talk,AlarmPush,Config"        // 门铃  deviceType 7
      }
      if (deviceInfo.channelNo != undefined) {
        permissionString = deviceTypePermissionEnum.channel
      } else {
        switch (deviceInfo.deviceType) {
          case "0":
            permissionString = deviceTypePermissionEnum.IPC;
            break;
          case "1":
            permissionString = deviceTypePermissionEnum.NVR;
            break;
          case "6":
            permissionString = deviceTypePermissionEnum.Access;
            break;
          case "7":
            permissionString = deviceTypePermissionEnum.doorbell;
            break;
          default:
            // 如果有未适配的设备类型，默认基于 IPC 的权限
            permissionString = deviceTypePermissionEnum.IPC;
        }
      }

      // 根据设备类型的最大 permission 字段来渲染权限列表的展示
      $("#devicePermissionList .mui-input-row").each(function () {
        var currentValue = $(this).find("input").val()
        var permissionArray = permissionString.split(",")
        var isHasPermission = false
        permissionArray.forEach(function (permission) {
          if (permission == currentValue) {
            isHasPermission = true
          }
        });
        if (isHasPermission) {
          $(this).removeClass('mui-hidden')
        }
      })

      // 根据设备的 permission 字段来渲染权限列表的选中 
      $("#devicePermissionList input").each(function () {
        var currentValue = $(this).val()
        var permissionArray = deviceInfo.permission.split(",")
        var isHasPermission = false
        permissionArray.forEach(function (permission) {
          if (permission == currentValue) {
            isHasPermission = true
          }
        });
        if (isHasPermission) {
          $(this).prop("checked", true)
        }
      })

      // 首次渲染界面时，判断全选按钮的被选中状态
      changeSelectAllBtnStatus();



      dsBridgeFuncSyn.dismiss();
    }

    function initEvent() {
      // 绑定事件：全选按钮
      $("#selectAllBtn").on('tap', selectAllBtnHandler)

      // 绑定事件：保存按钮
      $("#saveBtn").on('tap', savePermissionHandler)

      // 绑定事件：单选按钮
      $("#devicePermissionList input").each(function () {
        $(this).on('change', changeCheckboxHandler)
      })
    }

    // 事件处理函数：权限的单选框状态被改变
    function changeCheckboxHandler() {
      changeSelectAllBtnStatus()
    }

    // 判断当前全选按钮是否应该为被选中状态
    function changeSelectAllBtnStatus() {
      var currentSelectPermission = []
      $("#devicePermissionList input").each(function () {
        if ($(this).prop("checked")) {
          currentSelectPermission.push($(this).val())
        }
      })
      if (currentSelectPermission.length == permissionString.split(",").length) {
        $("#selectAllBtn").prop("checked", true)
      } else {
        $("#selectAllBtn").prop("checked", false)
      }
    }

    // 事件处理函数：全选按钮的逻辑
    function selectAllBtnHandler() {
      var turnToStatus = !($(this).prop("checked"))
      $("#devicePermissionList .mui-input-row").each(function () {
        $(this).find("input").prop("checked", turnToStatus ? true : false)
      })
    }

    // 事件处理函数：将修改后的权限发给批量分享页面，并返回批量分享页面
    function savePermissionHandler() {
      var currentPermission = [] // 获取用户编辑过后的权限
      $("#devicePermissionList .mui-input-row").each(function () {
        if ($(this).find("input").prop("checked")) {
          currentPermission.push($(this).find("input").val())
        }
        deviceInfo.permission = currentPermission.join(",");
      })
      
      if (operateType == 'updateTimeAndPermission') {
        deviceInfo.endTime = $("#endTimeInput").val();
      }
      
      // 跳转页面，传递数据
      var param = {
        deviceInfo: deviceInfo
      }
      console.log('设备修改后的权限为：%o', param.deviceInfo.permission);
      // 传递数据
      dsBridgeFuncSyn.sendDataToReport("updateDevicePermission", JSON.stringify(param));
      // 返回上一个页面
      dsBridgeFuncSyn.backTo();
    }








  </script>
</body>

</html>