<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title></title>
  <link href="../css/mui.css" rel="stylesheet" />
  <link href="../css/iconfont.css" rel="stylesheet" />
  <link href="../css/Common.css" rel="stylesheet" />
  <link href="../css/theme_normal.css" rel="stylesheet" />
  <style>
    #baseUI .mui-table-view-radio .mui-table-view-cell.mui-selected .mui-navigate-right:after {
      content: '\e442';
    }

    #baseUI .mui-table-view-radio .mui-table-view-cell .mui-navigate-right:after {
      content: '\e411';
      font-weight: 200;
    }

    .radio-list {
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <header class="mui-bar mui-bar-nav">
    <a id="back" class="mui-icon iconfont icon-back1"></a>
    <h1 id="title" class="mui-title" data-text="WEB_videoConfig">&nbsp;</h1>
  </header>
  <!-- 页面内容区 -->
  <div class="mui-content">
    <!-- 页面功能区 -->
    <div id="baseUI" class="mui-hidden">

      <!-- 编码格式功能 -->
      <div id="settings_CodeFormat" class="mui-hidden">
        <!-- 编码格式功能显示区 -->
        <div id="codeFormatContent" class="mui-hidden">

          <!-- 高清 -->
          <ul id="HDcodeFormat0" class="mui-table-view mui-hidden">
            <!-- 列表标题 - 高清 -->
            <li class="mui-table-view-cell">
              <span data-text="WEB_HD_main_stream" class="mainStyle">&nbsp;</span>
            </li>
            <!-- 列表内容 - 单选项 -->
            <div class="mui-table-view-radio radio-list" id="HDcodeFormat0List" data-value="0">
              <!-- H.264 -->
              <li class="mui-table-view-cell mui-hidden">
                <div class="mui-navigate-right" data-value="1" data-details="H.264">&nbsp;H.264</div>
              </li>
              <!-- H.265 -->
              <li class="mui-table-view-cell mui-hidden">
                <div class="mui-navigate-right" data-value="2" data-details="H.265">&nbsp;H.265</div>
              </li>
            </div>
          </ul>

          <!-- 标清 -->
          <ul id="HDcodeFormat1" class="mui-table-view mui-hidden">
            <!-- 列表标题 - 标清 -->
            <li class="mui-table-view-cell">
              <span data-text="WEB_SD_auxiliary_code_stream" class="mainStyle">&nbsp;</span>
            </li>
            <!-- 列表内容 - 单选项 -->
            <div class="mui-table-view-radio radio-list" id="HDcodeFormat1List" data-value="1">
              <!-- H.264 -->
              <li class="mui-table-view-cell mui-hidden">
                <div class="mui-navigate-right" data-value="1" data-details="H.264">&nbsp;H.264</div>
              </li>
              <!-- H.265 -->
              <li class="mui-table-view-cell mui-hidden">
                <div class="mui-navigate-right" data-value="2" data-details="H.265">&nbsp;H.265</div>
              </li>
            </div>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/dsbridge.min.js"></script>
  <script src="../js/common.js"></script>
  <script src="../js/libs/md5.js"></script>
  <script src="../js/libs/jquery-3.4.1.min.js"></script>
  <script src="../js/libs/sha2.js"></script>
  <script src="../js/resource.js"></script>
  <script src="../js/Utils.js"></script>
  <script src="../js/mui.js"></script>
  <script src="../js/immersed.js"></script>
  <script src="../js/customSetting.js"></script>
  <script src="../js/loadCss.js "></script>
  <script id="langScript"></script>
  <script>

    checkType(localStorage.AppType); //加载特定样式
    mui.init();
    var typeLan = initLang();
    langTip = typeLan.lang;

    var isShowNoFunction; //无功能占位图

    // 编码格式功能
    var HDcodeFormatData;  // 保存的设备视频流数据
    var HDcodeFormatArr;   // 保存的设备视频流数据中的视频编码参数信息数组

    var BitRateList = [{
      BitRate: 128,
      width: 352,
      height: 288
    },
    {
      BitRate: 1024,
      width: 704,
      height: 288
    },
    {
      BitRate: 1024,
      width: 640,
      height: 360
    },
    {
      BitRate: 1024,
      width: 704,
      height: 576
    },
    {
      BitRate: 1024,
      width: 720,
      height: 576
    },
    {
      BitRate: 1024,
      width: 720,
      height: 316
    },
    {
      BitRate: 1024,
      width: 720,
      height: 480
    },
    {
      BitRate: 2048,
      width: 1024,
      height: 452
    },
    {
      BitRate: 2048,
      width: 1280,
      height: 560
    },
    {
      BitRate: 2048,
      width: 1280,
      height: 720
    },
    {
      BitRate: 2048,
      width: 1280,
      height: 960
    },
    {
      BitRate: 2048,
      width: 1280,
      height: 1024
    },
    {
      BitRate: 4096,
      width: 1600,
      height: 1200
    },
    {
      BitRate: 4096,
      width: 1920,
      height: 832
    },
    {
      BitRate: 4096,
      width: 1920,
      height: 1080
    },
    {
      BitRate: 6144,
      width: 2000,
      height: 2000
    },
    {
      BitRate: 5120,
      width: 2000,
      height: 1500
    },
    {
      BitRate: 5120,
      width: 2048,
      height: 1520
    },
    {
      BitRate: 5120,
      width: 2048,
      height: 1536
    },
    {
      BitRate: 5120,
      width: 2304,
      height: 1296
    },
    {
      BitRate: 6144,
      width: 2560,
      height: 1440
    },
    {
      BitRate: 6144,
      width: 2560,
      height: 1920
    },
    {
      BitRate: 6144,
      width: 2560,
      height: 2048
    },
    {
      BitRate: 6144,
      width: 2880,
      height: 1264
    },
    {
      BitRate: 7168,
      width: 2560,
      height: 2560
    },
    {
      BitRate: 6144,
      width: 2592,
      height: 1520
    },
    {
      BitRate: 6144,
      width: 2688,
      height: 1520
    },
    {
      BitRate: 6144,
      width: 2592,
      height: 1944
    },
    {
      BitRate: 6144,
      width: 2592,
      height: 2048
    },
    {
      BitRate: 6144,
      width: 2944,
      height: 1656
    },
    {
      BitRate: 6144,
      width: 3000,
      height: 1500
    },
    {
      BitRate: 7168,
      width: 3000,
      height: 2000
    },
    {
      BitRate: 8192,
      width: 3000,
      height: 3000
    },
    {
      BitRate: 6144,
      width: 3072,
      height: 1728
    },
    {
      BitRate: 7168,
      width: 3072,
      height: 2048
    },
    {
      BitRate: 8192,
      width: 3840,
      height: 2160
    },
    {
      BitRate: 12288,
      width: 4000,
      height: 3000
    },
    {
      BitRate: 7168,
      width: 4096,
      height: 1800
    },
    {
      BitRate: 12288,
      width: 5952,
      height: 2684
    },
    {
      BitRate: 12288,
      width: 7296,
      height: 3288
    },
    {
      BitRate: 12288,
      width: 8192,
      height: 3840
    },
    {
      BitRate: 12288,
      width: 8640,
      height: 3840
    }
    ];
    var IntervalResolutionList = [4096, 5120, 6144, 7168, 8192, 10240, 12288];

    initPage();
    initEvent();

    function initPage() {
      // 1. 初始化页面中的功能展示
      initShowFunction()
    }

    function initEvent() {
      // 1. 高清视频流 下切换 视频编码格式 时触发的事件
      document.getElementById("HDcodeFormat0List").addEventListener('selected', changeHDcodeFormat)

      // 2. 标清视频流 下切换 视频编码格式 时触发的事件
      document.getElementById("HDcodeFormat1List").addEventListener('selected', changeHDcodeFormat);
    }


    // 根据设备的视频能力集，初始化页面中的功能展示
    function initShowFunction() {
      isShowNoFunction = true;
      SendAjax(LAPI.VideoCapabilities, "get", function (code, data) {
        dsBridgeFuncSyn.dismiss();
        if (code == 0) {
          var videoCapabilities = deepCopy(data);
          if (videoCapabilities.IsSupportCfg == 1 && videoCapabilities.EncodeFormatNum && videoCapabilities.EncodeFormatNum > 0 && videoCapabilities.StreamCapabilityNum && videoCapabilities.StreamCapabilityNum > 0) {
            var isHasAvailableEncodeFormat = false; // 接口数据是否含有有效的 视频编码格式
            for (var i = 0; i < videoCapabilities.EncodeFormatNum; i++) {
              // 宇视云界面仅支持展示   1: H264   2: H265
              if (videoCapabilities.EncodeFormatList[i] == 1 || videoCapabilities.EncodeFormatList[i] == 2) {
                isHasAvailableEncodeFormat = true;
              }
            }
            if (isHasAvailableEncodeFormat) {
              isShowNoFunction = false;
              $("#settings_CodeFormat").removeClass("mui-hidden");
              //  1.根据能力接口数据，控制配置项的显隐
              for (var streamIndex = 0; streamIndex < videoCapabilities.StreamCapabilityNum; streamIndex++) {
                for (var encodeFormatIndex = 0; encodeFormatIndex < videoCapabilities.EncodeFormatNum; encodeFormatIndex++) {
                  // 根据 videoCapabilities.EncodeFormatList 来进行 视频编码格式的展示
                  $('#HDcodeFormat' + videoCapabilities.StreamCapabilityList[streamIndex].ID + " li").each(function (index, el) {
                    if ($(el).find('div').attr("data-value") == videoCapabilities.EncodeFormatList[encodeFormatIndex]) {
                      $(el).removeClass("mui-hidden");
                    }
                  })
                }
              }
              // 2. 初始化页面中的数据
              initHDcodeFormatData();
            }
          }

          if (isShowNoFunction) {
            //TODO:无功能占位图
            addBitmap(1, langTip["WEB_noConfigAvailable"]);
          } else {
            $("#baseUI").removeClass("mui-hidden");
          }
					} else if(code == 4 || code == 8 || code == 1006) {
          addBitmap(1, langTip["WEB_unSupported"]);
        } else {
          //TODO:加载失败显示加载失败占位图
          addBitmap(0);
          showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
        }
      })
    }

    // 调用设备能力接口，根据服务端返回的数据，初始化页面中的数据展示
    function initHDcodeFormatData() {
      // 调用接口，获取设备的视频流信息
      SendAjax(LAPI.StreamsDetailInfo, 'get', function (code, data) {
        dsBridgeFuncSyn.dismiss();
        if (code == 0) {
          $("#codeFormatContent").removeClass("mui-hidden");
          HDcodeFormatData = deepCopy(data);
          HDcodeFormatArr = HDcodeFormatData.VideoStreamInfos;
          // 设备类型为 门铃
          if (localStorage.dvt == 100) {
            for (var i = 0; i < HDcodeFormatArr.length; i++) {
              if (i == 0 || HDcodeFormatArr[i].Enabled == 1) {
                $("#HDcodeFormat" + i).removeClass("mui-hidden");
              }
              if (HDcodeFormatArr[i].ID == i) {
                // 根据接受的服务端数据，给界面中的 格式编码单选框 添加选中状态
                var isH264 = HDcodeFormatArr[i].VideoEncodeInfo.EncodeFormat == 1 ? true : false;
                var liList = $('#HDcodeFormat' + i).find('#HDcodeFormat' + i + 'List').find('li')
                for (var j = 0; j < liList.length; j++) {
                  if ($(liList[j]).find('div').attr('data-details') == 'H.264' && isH264) {
                    $(liList[j]).addClass('mui-selected')
                  } else if ($(liList[j]).find('div').attr('data-details') == 'H.265' && !isH264) {
                    $(liList[j]).addClass('mui-selected')
                  }
                }
              }
            }
          } else {
            for (var i = 0; i < HDcodeFormatArr.length; i++) {
              if (HDcodeFormatArr[i].ID < 2) {
                if (i == 0 || HDcodeFormatArr[i].Enabled == 1) {
                  $("#HDcodeFormat" + i).removeClass("mui-hidden");
                }
                // 根据接受的服务端数据，给界面中的 格式编码单选框 添加选中状态
                var isH264 = HDcodeFormatArr[i].VideoEncodeInfo.EncodeFormat == 1 ? true : false;
                var liList = $('#HDcodeFormat' + i).find('#HDcodeFormat' + i + 'List').find('li')
                for (var j = 0; j < liList.length; j++) {
                  if ($(liList[j]).find('div').attr('data-details') == 'H.264' && isH264) {
                    $(liList[j]).addClass('mui-selected')
                  } else if ($(liList[j]).find('div').attr('data-details') == 'H.265' && !isH264) {
                    $(liList[j]).addClass('mui-selected')
                  }
                }
              }
            }
          }
        } else {
          addBitmap(0);
          showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
          dsBridgeFuncSyn.dismiss();
        }
      });
    }


    // 码流切换时对应的事件处理函数
    function changeHDcodeFormat(event) {
      // 当前视频流类型  0:高清（主码流） 1:标清（辅码流）
      var curType = Number($(event.detail.el).parent().attr('data-value'))
      // 当前视频编码格式  1:H.264  2:H.265
      var curEncodeFormat = Number($(event.detail.el).find('div').attr('data-value'))
      // 最终发送给服务端的数据
      var sendData = deepCopy(HDcodeFormatData);
      // 当前视频流类型的视频编码参数信息数组
      var VideoEncodeInfo = sendData.VideoStreamInfos[curType].VideoEncodeInfo;

      // 门铃设备
      if (localStorage.dvt == 100) {
        if (curEncodeFormat == 1) {
          VideoEncodeInfo.EncodeFormat = 1;
          VideoEncodeInfo.BitRate = Number(VideoEncodeInfo.BitRate) * 2;
        } else if (curEncodeFormat == 2) {
          VideoEncodeInfo.EncodeFormat = 2;
          VideoEncodeInfo.BitRate = Number(VideoEncodeInfo.BitRate) / 2;
        }
      } else {
        // 初始化码率的值(码率需要经过计算)
        var sendBitRate = 0;
        // 当前宽度
        var curWidth = VideoEncodeInfo.Resolution.Width;
        // 当前高度
        var curHeight = VideoEncodeInfo.Resolution.Height;
        // 当前帧率
        var curFrameRate = VideoEncodeInfo.FrameRate;
        // 当前智能编码模式
        var curSmartEncodeMode = VideoEncodeInfo.SmartEncodeMode;

        if (curWidth == 352 && curWidth == 288) {
          if (curFrameRate > 30) {
            sendBitRate = 256;
          } else {
            sendBitRate = 128;
          }
        } else {
          sendBitRate = getH264DefaultBitrate(curWidth, curHeight);
          if (curEncodeFormat == 1) {
            VideoEncodeInfo.EncodeFormat = 1;
          } else if (curEncodeFormat == 2) {
            VideoEncodeInfo.EncodeFormat = 2;
            sendBitRate = getH265DefaultBitrate(curWidth, curHeight, sendBitRate);
          }
          sendBitRate = calculateBitrate(curWidth, curHeight, sendBitRate, curFrameRate, curSmartEncodeMode);
        }
        if (sendBitRate == 0) {
          showToast(langTip["WEB_codeFormat_Tip"]);
          return;
        }
        VideoEncodeInfo.BitRate = sendBitRate;
      }

      dsBridgeFuncSyn.showLoading();
      SendAjax(LAPI.StreamsDetailInfo, 'put', function (code, data) {
        dsBridgeFuncSyn.dismiss();
        if (code == 0) {
        } else {
          // 接口发送失败，将视频编码格式还原为之前的值
          if (curEncodeFormat == 1) {
            $(event.detail.el).parent().find('div[data-value="2"]').parent().addClass('mui-selected');
            $(event.detail.el).parent().find('div[data-value="1"]').parent().removeClass('mui-selected');
          } else if (curEncodeFormat == 2) {
            $(event.detail.el).parent().find('div[data-value="1"]').parent().addClass('mui-selected');
            $(event.detail.el).parent().find('div[data-value="2"]').parent().removeClass('mui-selected');
          }
          showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
        }
      }, sendData);
    }

    // 获取 H264 默认码率
    function getH264DefaultBitrate(width, height) {
      var H264DefaultCode = 0;
      for (var i = 0; i < BitRateList.length; i++) {
        var RWidth = BitRateList[i].width;
        var RHeight = BitRateList[i].height;
        if (width == RWidth && height == RHeight) {
          H264DefaultCode = BitRateList[i].BitRate;
          return H264DefaultCode;
        }
      }
      var resolutionRatio = width * height;
      //（720p,1080],H264默认4096
      //[4096,5120,6144,7168,8192,10240,12288]
      if (921600 < resolutionRatio && resolutionRatio <= 2500000) {
        H264DefaultCode = IntervalResolutionList[0];
      } else if (2500000 < resolutionRatio && resolutionRatio <= 3500000) {
        H264DefaultCode = IntervalResolutionList[1];
      } else if (3500000 < resolutionRatio && resolutionRatio <= 5500000) {
        H264DefaultCode = IntervalResolutionList[2];
      } else if (5500000 < resolutionRatio && resolutionRatio <= 7500000) {
        H264DefaultCode = IntervalResolutionList[3];
      } else if (7500000 < resolutionRatio && resolutionRatio <= 9500000) {
        H264DefaultCode = IntervalResolutionList[4];
      } else if (9500000 < resolutionRatio && resolutionRatio <= 11500000) {
        H264DefaultCode = IntervalResolutionList[5];
      } else if (resolutionRatio > 11500000) {
        H264DefaultCode = IntervalResolutionList[6];
      }
      return H264DefaultCode;
    }

    // 获取H265默认码率
    function getH265DefaultBitrate(width, height, H264Bitrate) {
      var H265DefaultCode;
      if (width * height > 3500000) {
        H265DefaultCode = H264Bitrate * 0.7;
      } else {
        H265DefaultCode = H264Bitrate * 0.5;
      }
      if (H265DefaultCode % 128 != 0) {
        H265DefaultCode = Math.floor(H265DefaultCode) + 128 - Math.floor(H265DefaultCode) % 128;
      }
      return H265DefaultCode;
    }

    // 计算最终的码率
    function calculateBitrate(width, height, defultBitrate, FrameRate, SmartEncodeMode) {
      var sendBitrateC;
      if (FrameRate > 30 && FrameRate <= 60) {
        sendBitrateC = 1.5 * defultBitrate;
      } else if (FrameRate >= 1 && FrameRate <= 30) {
        switch (SmartEncodeMode) {
          //0关闭
          case 0:
            sendBitrateC = defultBitrate;
            break;
          //1	基础模式
          case 1:
            if (width * height <= 5500000) {
              sendBitrateC = 0.75 * defultBitrate;
            } else {
              sendBitrateC = defultBitrate;
            }
            break;
          //2 高级模式
          case 2:
            sendBitrateC = 0.5 * defultBitrate;
            break;
          default:
            break;
        }
      }
      if (sendBitrateC % 128 != 0) {
        sendBitrateC = Math.floor(sendBitrateC) + 128 - Math.floor(sendBitrateC) % 128;
      }
      return sendBitrateC;
    }
  </script>
</body>

</html>