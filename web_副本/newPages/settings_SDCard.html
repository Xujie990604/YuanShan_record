<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<link href="../css/theme_normal.css" rel="stylesheet" />
		<style>
			.SDTips span {
				display: inline-block;
			}
			
			.SDTips img {
				width: 14px;
				position: absolute;
				right: 17px;
				top: 14px;
			}
			
			.SDTips span:last-child {
				font-size: 12px;
				color: #c5c5c5;
				z-index: 10;
				right: 17px;
			}
			
			.mui-table-view-cell .ui-tip {
				position: absolute;
				right: 0px;
				z-index: 100;
				width: 100% !important;
			}
			
			#SDSettingUl .mui-table-view-cell:not(:first-child) a {
				padding-left: 30px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_sd_config">&nbsp;</h1>
		</header>
		<div class="mui-content">
			<div id="EZView-content" class="mui-hidden">
				<!--SD卡配置-->
				<ul class="mui-table-view">
					<li class="mui-table-view-cell SDTips" id="SDTips">
						<span data-text="WEB_sd_config" class="mainStyle">&nbsp;</span>
						<span id="SDCardTips" style="float: right">&nbsp;</span>
					</li>
				</ul>
				<ul class="mui-table-view" style="margin-top:0; visibility: hidden;height:0px;" id="SDSettingUl">
					<li id="setSDcard" class="mui-table-view-cell" style="padding-left:30px;">
						<span data-text="WEB_Full_Coverage" class="mainStyle padding-left-15">&nbsp;</span>
						<div id="setSDcardSwitch" class="mui-switch mui-switch-mini">
							<div class="mui-switch-handle" id="setSDcardCircle"></div>
						</div>
						<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
					</li>
					<li class="mui-table-view-cell">
						<a id="storagestatus" class="mui-navigate-right">&nbsp;
							<span data-text="WEB_device_manager_storage_status" class="mainStyle padding-left-15">&nbsp;</span>
							<span class="mui-badge"></span>
						</a>
					</li>
					<li class="mui-table-view-cell mui-hidden" id="setVideo">
						<a id="Video" class="mui-navigate-right">&nbsp;
							<span data-text="WEB_device_manager_record_schedule" class="mainStyle padding-left-15">&nbsp;</span>
							<span class="mui-badge"></span>
						</a>
					</li>
					<li class="mui-table-view-cell" id="setImageVivid">
						<a id="ImageVivid" class="mui-navigate-right">&nbsp;
							<span data-text="WEB_Image_vivid" class="mainStyle padding-left-15">&nbsp;</span>
							<span class="mui-badge"></span>
						</a>
					</li>
					<li class="mui-table-view-cell">
						<a id="format" class="mui-navigate-right">&nbsp;
							<span data-text="WEB_sd_format" class="mainStyle padding-left-15">&nbsp;</span>
							<span class="mui-badge"></span>
						</a>
					</li>
				</ul>
			</div>
		</div>

		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/libs/sha2.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/loadCss.js"></script>
    <script id="langScript"></script>
		<script>
			var langTip;
			checkType(localStorage.AppType); //加载特定样式
			var SportCheckConfirm = true; //满覆盖开关状态变化时是否调接口提交
			// SD卡
			var getSDError = false;
			var SDCardTips = document.getElementById("SDCardTips");
			var SDcardServiceData;
			var overStoreCheck;
			var setSDcardConfirm = true;
			var coverObj = {};
			var height = "220px";
			//录像计划
			var setVideo = document.getElementById("setVideo"); //录像计划点击处理
			setVideo.classList.remove("mui-hidden");
			var SDClickednum = 0; //点击刷新次数
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;
			initPage();
			initData();
			initEvent();

			function initPage() {
				//门铃设备暂不支持图像清晰度配置
				if(localStorage.dvt == 100) {
					document.getElementById("setImageVivid").classList.add("mui-hidden")
					height = (220 - 44) + "px";
				}
				//双通道设备不支持
				if(localStorage.isMultiChannelIPC == "1") {
					document.getElementById("setSDcard").classList.add("mui-hidden")
					height = (220 - 44) + "px";
				}
			}

			function initData() {
				//初始化sd卡
				initSD();
			}

			function initEvent() {
				document.getElementById("storagestatus").addEventListener("tap", storageStatus); //存储状态点击事件
				document.getElementById("format").addEventListener("tap", formatStorage); //格式化点击事件
				document.getElementById("ImageVivid").addEventListener("tap", ImageVivid); //图像清晰度点击事件
			}

			function initSD() {
				SendAjax(LAPI.StatusSD, "get", function(code, data) {
					SDCardTips.style.display = 'block';
					SDCardTips.style.color = "#999999";
					SDCardTips.style.fontSize = "14px";
					if(code == 0) {
						$("#EZView-content").removeClass("mui-hidden");
						getSDError = false;
						switch(data.StatusParam.SDStatus) {
							case 0:
								SDCardTips.innerHTML = langTip["WEB_web_sd_noSD"];
								dsBridgeFuncSyn.dismiss();
								break;
							case 1:
								SDSettingUl.style.visibility = "visible";
								SDSettingUl.style.height = height;
								SDCardTips.innerHTML = langTip["WEB_web_sd_errSD"];
								initSDcardData();
								break;
							case 2:
								SDSettingUl.style.visibility = "visible";
								SDSettingUl.style.height = height;
								SDCardTips.innerHTML = langTip["WEB_web_sd_noformatSD"];
								initSDcardData();
								break;
							case 3:
								SDSettingUl.style.visibility = "visible";
								SDSettingUl.style.height = height;
								SDCardTips.innerHTML = langTip["WEB_web_sd_normalSD"];
								initSDcardData();
								break;
						}
					} else {
						getSDError = true;
						//数据获取失败的处理
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						addBitmap(0);
						dsBridgeFuncSyn.dismiss();
					}
				})
			}

			function initSDcardData() {
				SendAjax(LAPI.Storage, "get", function(code, data) {
					if(code == 0) {
						SDcardServiceData = deepCopy(data);
						overStoreCheck = data.VideoStorage.StoragePolicy;
						coverObj = data;
						document.getElementById("setSDcardSwitch").style.zIndex = 20;
						document.getElementById("setSDcardSwitch").style.visibility = "visible";
						setSDcardConfirm = false;
						setSwitchStatus("setSDcardSwitch", overStoreCheck);
						setSDcardConfirm = true;
						var setSDcardActive = document.getElementById("setSDcardSwitch").classList.contains("mui-active")
						if(setSDcardActive) {
							document.getElementById("setSDcardCircle").style.transform = "translate(16px, 0px)";
						}
						dsBridgeFuncSyn.dismiss();
					} else {
						$("#setSDcard div.loadFailed").removeClass("mui-hidden");
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						dsBridgeFuncSyn.dismiss();
					}
				})
			}
			/*
			 *  监听满覆盖开关
			 */
			document.getElementById("setSDcardSwitch").addEventListener("toggle", function(event) {
				if(event.detail.isActive && setSDcardConfirm) {
					var sendDataON = deepCopy(SDcardServiceData);
					sendDataON.VideoStorage.StoragePolicy = 1;
					dsBridgeFuncSyn.showLoading();
					SendAjax(LAPI.Storage, "put", function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {

						} else {
							setSDcardConfirm = false;
							showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
							setTimeout(function() {
								mui("#setSDcardSwitch").switch().toggle();
							}, 200)
						}
					}, sendDataON)
				} else if(!event.detail.isActive && setSDcardConfirm) {
					var sendDataOFF = deepCopy(SDcardServiceData);
					sendDataOFF.VideoStorage.StoragePolicy = 0;
					SendAjax(LAPI.Storage, "put", function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {

						} else {
							setSDcardConfirm = false;
							showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
							setTimeout(function() {
								mui("#setSDcardSwitch").switch().toggle()
							}, 200)
						}
					}, sendDataOFF)
				} else {
					setSDcardConfirm = true;
				}

			})

			function storageStatus() {
				jumpToWebPage("settings_SDCardStatus", "");
			}
			/*
			 *  录像计划
			 */
			setVideo.addEventListener("tap", function() {
				jumpToWebPage("settings_VideoPlan", "");

			});

			function formatStorage() {
				var btnArray = [langTip["WEB_text_no"], langTip["WEB_text_yes"]];
				mui.confirm(langTip["WEB_sd_format_tip"], langTip["WEB_dialog_title_notify"], btnArray, function(e) {
					if(e.index == 1) {
						dsBridgeFuncSyn.showLoading();
						//先判断是否有SD卡然后，若有则调格式化接口
						SendAjax(LAPI.StatusSD, 'get', function(code, data) {
							if(code == 0) {
								switch(data.StatusParam.SDStatus) {
									case 0:
										dsBridgeFuncSyn.dismiss();
										showToast(langTip["WEB_web_sd_noSD"]);
										break;
									case 1:
										dsBridgeFuncSyn.dismiss();
										showToast(langTip["WEB_web_sd_errSD"]);
										break;
									default:
										SendAjax(LAPI.SDFormat, 'put', function(code, data) {
											if(code == 0) { //格式化下发成功后告知原生页面关闭web页面，返回上一页
												showToast(langTip["WEB_api_error_succeededAndRebooting"]);
												dsBridgeFuncSyn.dismiss();
												dsBridgeFuncSyn.deviceOffLine();
											} else {
												dsBridgeFuncSyn.dismiss();
												showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
											}
										});
								}
							} else {
								dsBridgeFuncSyn.dismiss();
								showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
							}
						});
					}
				}, 'div');
			}

			/**
			 * 图像清晰度
			 */
			function ImageVivid() {
				jumpToWebPage("settings_SDCardVideoImage", "");
			}
		</script>
	</body>

</html>