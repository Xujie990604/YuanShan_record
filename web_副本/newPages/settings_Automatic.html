<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
		<title></title>
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/iconfont.css" rel="stylesheet" />
		<link href="../css/Common.css" rel="stylesheet" />
		<link href="../css/theme_normal.css" rel="stylesheet" />
		<style>
			.mui-table-view-cell .ui-tip {
				position: absolute;
				right: 0px;
				z-index: 100;
				width: 100% !important;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon iconfont icon-back1"></a>
			<h1 id="title" class="mui-title" data-text="WEB_auto_tracking">&nbsp;</h1>
		</header>
		<div class="mui-content">
			<div id="EZView-content" class="mui-hidden">
				<!--自动跟踪能力-->
				<ul id="Capabilities" class="mui-table-view ui-siwtchlist">
					<li id="setCapabilities" class="mui-table-view-cell">
						<span data-text="WEB_auto_tracking" class="mainStyle">&nbsp;</span>
						<div id="setCapabilitiesSwitch" class="mui-switch mui-switch-mini">
							<div class="mui-switch-handle"></div>
						</div>
						<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
					</li>
					<li id="CapabilitiesTimeItem" class="mui-table-view-cell mui-hidden">
						<a id="CapabilitiesTime">&nbsp;
							<span data-text="WEB_motion_detection_time_quantum" class="mainStyle padding-left-15">&nbsp;</span>
							<span id="CapabilitiesTimeVal" class="mui-badge"></span>
						</a>
						<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
					</li>
					<li id="setContinueTrack" class="mui-table-view-cell  mui-hidden">
						<a id="ContinueTrack">&nbsp;
							<span data-text="WEB_continue_track" class="mainStyle padding-left-15">&nbsp;</span>
							<div id="setContinueTrackSwitch" class="mui-switch mui-switch-mini">
								<div class="mui-switch-handle" id="setContinueTrackCircle"></div>
							</div>
						</a>
						<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
					</li>
					<li id="MaxTrackTimeItem" class="mui-table-view-cell mui-hidden">
						<a href="#MaxTrackTime" id="MaxTrackTimeIcon">&nbsp;
							<span data-text="WEB_max_track_time" class="mainStyle padding-left-15">&nbsp;</span>
							<span id="MaxTrackTimeVal" class="mui-badge"></span>
						</a>
						<div class="loadFailed mui-hidden" data-text="WEB_loadFailed">&nbsp;</div>
					</li>
				</ul>
			</div>
		</div>
		<!--最大跟踪时间弹框-->
		<div id="MaxTrackTime" class="mui-popover mui-popover-action mui-popover-bottom ui-radio-list">
			<form class="mui-input-group">
				<div class="mui-input-row mui-checkbox ui-list-titile" id="swipedownDiv">
					<label data-text="WEB_max_track_time">&nbsp;</label>
					<span id="MaxTrackTimeClose" class="mui-icon mui-icon-closeempty"></span>
				</div>
				<ul id="MaxTrackTimeList" class="mui-table-view mui-table-view-radio">
					<li class="mui-table-view-cell">
						<a class="mui-navigate-right" data-value=15>&nbsp;15</a>
					</li>
					<li class="mui-table-view-cell">
						<a class="mui-navigate-right" data-value=30>&nbsp;30</a>
					</li>
					<li class="mui-table-view-cell">
						<a class="mui-navigate-right" data-value=60>&nbsp;60</a>
					</li>
					<li class="mui-table-view-cell">
						<a class="mui-navigate-right" data-value=100>&nbsp;100</a>
					</li>
					<li class="mui-table-view-cell">
						<a class="mui-navigate-right" data-value=150>&nbsp;150</a>
					</li>
					<li class="mui-table-view-cell">
						<a class="mui-navigate-right" data-value=300>&nbsp;300</a>
					</li>
				</ul>
			</form>
			<button id="MaxTrackTimeOk" class="mui-btn mui-btn-block ui-dateok" data-text="WEB_button_ok">&nbsp;</button>
		</div>

		<script src="../js/dsbridge.min.js"></script>
		<script src="../js/common.js"></script>
		<script src="../js/libs/md5.js"></script>
		<script src="../js/libs/jquery-3.4.1.min.js"></script>
		<script src="../js/libs/sha2.js"></script>
		<script src="../js/resource.js"></script>
		<script src="../js/Utils.js"></script>
		<script src="../js/mui.js"></script>
		<script src="../js/immersed.js"></script>
		<script src="../js/customSetting.js"></script>
		<script src="../js/loadCss.js"></script>
    <script id="langScript"></script>
		<script>
			var langTip;

			checkType(localStorage.AppType); //加载特定样式
			// 自动跟踪
			var setCapabilitiesConfirm = true; //自动跟踪开关状态变化时是否调接口提交
			var setCapabilitiesServiceData; //自动跟踪使能服务端数据
			var setCapabilitiesCheck; // 自动跟踪开关是否开启
			var setContinueTrackConfirm = true; //持续跟踪开关状态变化时是否调接口提交
			var setContinueTrackCheck;
			var ContinueTrackCheck;
			var CapabilityCheckData;
			var IsSupportCfg = "";
			var CapCheckTimeServiceData; //自动跟踪检测时间服务端数据
			var CheckTimeStepChecked = ''; //检测时间初始值“全天”“自定义”
			mui.init();
			var typeLan = initLang();
			langTip = typeLan.lang;
			initData();
			initEvent();


			function initData() {
				// 自动跟踪能力
				initCapabilities();
			}

			function initEvent() {
				document.getElementById('MaxTrackTimeClose').addEventListener('tap', function() {
					mui('#MaxTrackTime').popover('toggle');
				});
				document.getElementById('MaxTrackTimeOk').addEventListener('tap', MaxTrackTimeOk); //最大跟踪时间确定
				document.getElementById('MaxTrackTime').addEventListener('hidden', function(e) {
					hiddenPopover("MaxTrackTimeList", ContinueTrackCheck);
				});

				// 手势操作：向下滑动关闭弹框
				document.getElementById("swipedownDiv").addEventListener("swipedown", function() {
					mui('#MaxTrackTime').popover('toggle');
				});
			}

			/**
			 * 初始化 自动跟踪能力
			 */
			function initCapabilities() {
				var Url = "web/newPages/settings_Automatic.html";
				var self = dsBridgeFuncSyn.getWebParam(Url);
				self = JSON.parse(self);
				var data = self.capacityData;
				CapabilityCheckData = deepCopy(data);
				CapabilitiesData();
			}
			/**
			 * 初始化 自动跟踪使能
			 */
			function CapabilitiesData() {
				SendAjax(LAPI.ObjTrackRule, 'get', function(code, data) {
					if(code == 0) {
						$("#EZView-content").removeClass("mui-hidden");
						setCapabilitiesServiceData = deepCopy(data);
						setCapabilitiesCheck = data.Rule.Enabled; // 0：关闭，1：开启
						setContinueTrackCheck = data.Rule.LastTrackEnable; // 0：关闭，1：开启
						//初始化自动跟踪使能开关
						document.getElementById("setCapabilitiesSwitch").style.zIndex = 20;
						document.getElementById("setCapabilitiesSwitch").style.visibility = "visible";
						document.getElementById("setContinueTrackSwitch").style.zIndex = 20;
						document.getElementById("setContinueTrackSwitch").style.visibility = "visible";
						setCapabilitiesConfirm = false;
						setSwitchStatus("setCapabilitiesSwitch", setCapabilitiesCheck);
						setCapabilitiesConfirm = true;
						setContinueTrackConfirm = false;
						setSwitchStatus("setContinueTrackSwitch", setContinueTrackCheck);
						setContinueTrackConfirm = true;
						if(setCapabilitiesCheck == 1) {
							//显示自动跟踪配置选项
							mui("#Capabilities .mui-table-view-cell").each(function(index, El) {
								if(index != 0) {
									El.classList.remove('mui-hidden');
								}
							});
						}
						if(setContinueTrackCheck == 1) {
							document.getElementById("MaxTrackTimeItem").classList.add("mui-hidden");
						}
						var setContinueTrackActive = document.getElementById("setContinueTrackSwitch").classList.contains("mui-active");
						if(setContinueTrackActive) {
							document.getElementById("setContinueTrackCircle").style.transform = 'translate(16px, 0px)';
						}
						ContinueTrackCheck = data.Rule.OverAll.TrackTime;
						mui('#MaxTrackTimeList a').each(function(index, El) {
							if(El.innerText.trim() == ContinueTrackCheck) {
								El.parentNode.classList.add('mui-selected');
							}
						});
						document.getElementById("MaxTrackTimeVal").innerText = ContinueTrackCheck;
						document.getElementById("MaxTrackTimeIcon").classList.add("mui-navigate-right");
						initCapabilityCheck();
					} else {
						//数据获取失败的处理
						addBitmap(0);
						showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
						dsBridgeFuncSyn.dismiss();
					}
				});
			}
			/**
			 * 监听自动跟踪开关
			 */
			document.getElementById("setCapabilitiesSwitch").addEventListener("toggle", function(event) {
				if(event.detail.isActive && setCapabilitiesConfirm) {
					var sendDataON = deepCopy(setCapabilitiesServiceData);
					sendDataON.Rule.Enabled = 1; // 0：自动跟踪关闭，1：自动跟踪开启
					dsBridgeFuncSyn.showLoading();
					SendAjax(LAPI.ObjTrackRule, 'put', function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {
							document.getElementById("MaxTrackTimeVal").innerText = sendDataON.Rule.OverAll.TrackTime;
							setCapabilitiesServiceData = deepCopy(sendDataON);
							showToast(langTip["WEB_api_error_succeeded"]);
							mui("#Capabilities .mui-table-view-cell").each(function(index, El) {
								if(index != 0) {
									El.classList.remove('mui-hidden');
								}
							});
							if(sendDataON.Rule.LastTrackEnable == 1) {
								document.getElementById("MaxTrackTimeItem").classList.add("mui-hidden");
							} else {
								document.getElementById("MaxTrackTimeItem").classList.remove("mui-hidden");
							}
						} else {
							setCapabilitiesConfirm = false;
							showToast(langTip["WEB_api_error_succeeded"] + "(" + code + ")", code);
							setTimeout(function() {
								mui("#setCapabilitiesSwitch").switch().toggle();
							}, 200);
						}
					}, sendDataON);
				} else if(!event.detail.isActive && setCapabilitiesConfirm) {
					mui("#Capabilities .mui-table-view-cell").each(function(index, El) {
						if(index != 0) {
							El.classList.add('mui-hidden');
						}
					});
					var sendDataOFF = deepCopy(setCapabilitiesServiceData);
					sendDataOFF.Rule.Enabled = 0; // 0：自动跟踪关闭，1：自动跟踪开启
					dsBridgeFuncSyn.showLoading();
					SendAjax(LAPI.ObjTrackRule, 'put', function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {
							setCapabilitiesServiceData = deepCopy(sendDataOFF);
							showToast(langTip["WEB_api_error_succeeded"]);
						} else {
							setCapabilitiesConfirm = false;
							showToast(langTip["WEB_api_error_succeeded"] + "(" + code + ")", code);
							setTimeout(function() {
								mui("#setCapabilitiesSwitch").switch().toggle();
								mui("#Capabilities .mui-table-view-cell").each(function(index, El) {
									if(index != 0) {
										El.classList.remove('mui-hidden');
									}
								});
							}, 300);
						}
					}, sendDataOFF);
				} else {
					setCapabilitiesConfirm = true;
				};
			});
			/**
			 * 自动跟踪时间布防配置
			 */
			function initCapabilityCheck() {
				if(CapabilityCheckData.ObjTrack.SupportWeekPlan == 1) {
					SendAjax(LAPI.WeekPlan, 'get', function(code, data) {
						if(code == 0) {
							document.getElementById('CapabilitiesTime').addEventListener('tap', CapabilitiesTime); //自动跟踪检测时段
							CapCheckTimeServiceData = deepCopy(data);
							//初始化 自动跟踪布防计划
							initCheckTime(data);
							document.getElementById("CapabilitiesTime").classList.add("mui-navigate-right");
							document.getElementById('CapabilitiesTimeVal').innerText = CheckTimeStepChecked;
							dsBridgeFuncSyn.dismiss();
						} else {
							//数据获取失败的处理
							$("#Capabilities div.loadFailed").removeClass("mui-hidden");
							showToast(langTip["WEB_AuthenticateFailed"] + "(" + code + ")", code);
							dsBridgeFuncSyn.dismiss();
						}
					});
				} else {
					dsBridgeFuncSyn.dismiss();
					$("#CapabilitiesTimeItem .loadFailed").removeClass("mui-hidden");
					$("#CapabilitiesTimeItem .loadFailed").text(langTip["WEB_unSupported"]); //功能不支持
				}
			}
			/**
			 * 进入检测时间配置
			 */
			function CapabilitiesTime() {
				var checkDate = this.children[1].innerText.trim();
				// TODO:页面跳转+传参
				var Extras = {
					isCapality: 1,
					checkDate: checkDate,
					ServiceData: CapCheckTimeServiceData
				};
				jumpToWebPage("settings_CheckTime", JSON.stringify(Extras));
			}
			/**
			 * 监听持续跟踪开关
			 */
			document.getElementById("setContinueTrackSwitch").addEventListener("toggle", function(event) {
				if(event.detail.isActive && setContinueTrackConfirm) {
					var sendDataON = deepCopy(setCapabilitiesServiceData);
					sendDataON.Rule.LastTrackEnable = 1; // 0：持续跟踪关闭，1：持续跟踪开启
					dsBridgeFuncSyn.showLoading();
					SendAjax(LAPI.ObjTrackRule, 'put', function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {
							setCapabilitiesServiceData = deepCopy(sendDataON);
							showToast(langTip["WEB_api_error_succeeded"]);
							document.getElementById("MaxTrackTimeItem").classList.add("mui-hidden");
						} else {
							setContinueTrackConfirm = false;
							showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
							setTimeout(function() {
								mui("#setContinueTrackSwitch").switch().toggle();
							}, 200);
						}
					}, sendDataON);
				} else if(!event.detail.isActive && setContinueTrackConfirm) {
					document.getElementById("MaxTrackTimeItem").classList.remove("mui-hidden");
					var sendDataOFF = deepCopy(setCapabilitiesServiceData);
					sendDataOFF.Rule.LastTrackEnable = 0;
					dsBridgeFuncSyn.showLoading();
					SendAjax(LAPI.ObjTrackRule, 'put', function(code, data) {
						dsBridgeFuncSyn.dismiss();
						if(code == 0) {
							setCapabilitiesServiceData = deepCopy(sendDataOFF);
							showToast(langTip["WEB_api_error_succeeded"]);
						} else {
							setContinueTrackConfirm = false;
							showToast(langTip["WEB_api_error_operation_fails"] + "(" + code + ")", code);
							setTimeout(function() {
								mui("#setContinueTrackSwitch").switch().toggle();
								document.getElementById("MaxTrackTimeItem").classList.add("mui-hidden");
							}, 300);
						}
					}, sendDataOFF);
				} else {
					setContinueTrackConfirm = true;
				};
			});
			/**
			 * 最大跟踪时间确定
			 */
			function MaxTrackTimeOk() {
				var sendData = deepCopy(setCapabilitiesServiceData);
				var trackCheck;
				mui('#MaxTrackTimeList a').each(function(index, El) {
					if(El.parentNode.classList.contains('mui-selected')) {
						trackCheck = El.getAttribute('data-value');
					}
				});
				sendData.Rule.OverAll.TrackTime = Number(trackCheck);
				dsBridgeFuncSyn.showLoading();
				SendAjax(LAPI.ObjTrackRule, 'put', function(code, data) {
					dsBridgeFuncSyn.dismiss();
					if(code == 0) {
						setCapabilitiesServiceData = deepCopy(sendData);
						ContinueTrackCheck = trackCheck;
						document.getElementById('MaxTrackTimeVal').innerText = ContinueTrackCheck;
					} else {
						if(ContinueTrackCheck != document.getElementById('MaxTrackTimeVal').innerText.trim()) {
							mui('#MaxTrackTimeList a').each(function(index, El) {
								if(El.innerText.trim() == document.getElementById('MaxTrackTimeVal').innerText.trim()) {
									El.parentNode.classList.add('mui-selected');
								} else {
									El.parentNode.classList.remove('mui-selected');
								}
							});
						}
						showToast(langTip["WEB_toast_modify_favoritesname_failed"] + "(" + code + ")", code);
					}
					mui('#MaxTrackTime').popover('toggle');
				}, sendData);
			}
			//  监听其它页面发送的时间数据
			window.addEventListener('reshTimeStepVal', function(event) {
				//获得事件参数
				var dataBackTxt = event.detail.dataBackTxt;
				if(event.detail.isCapality == 1) {
					CapCheckTimeServiceData = event.detail.ServiceData;
					document.getElementById('CapabilitiesTimeVal').innerText = dataBackTxt;
				} else if(event.detail.isCapality == 2) {
					CheckTimeServiceData = event.detail.ServiceData;
					document.getElementById('CheckTimeStepVal').innerText = dataBackTxt;
				} else {
					HumanCheckTimeServiceData = event.detail.ServiceData;
					document.getElementById('HumanCheckTimeStepVal').innerText = dataBackTxt;
				}
			});
			/******************新增原生App上报Web功能接口******************/
			//TODO:监听原生侧上报内容
			dsBridge.register("callWebDoFuncAsyn", function(args) {
				var webInfo = JSON.parse(args);
				for(var key in webInfo) {
					switch(webInfo[key].whichInfo) {
						case "reshTimeStepVal": //监听checkTime页面发送的消息 更新时间数据
							var param = JSON.parse(webInfo[key].infoValue);
							var dataBackTxt = param.dataBackTxt;
							if(param.isCapality == 1) {
								CapCheckTimeServiceData = param.ServiceData;
								document.getElementById('CapabilitiesTimeVal').innerText = dataBackTxt;
							} else if(param.isCapality == 2) {
								CheckTimeServiceData = param.ServiceData;
								document.getElementById('CheckTimeStepVal').innerText = dataBackTxt;
							} else {
								HumanCheckTimeServiceData = param.ServiceData;
								document.getElementById('HumanCheckTimeStepVal').innerText = dataBackTxt;
							}
							break;
						case "deviceStatus": // 更新设备在线状态
							localStorage.deviceStatus = webInfo[key].infoValue;
							break;
						case "ip": // 更新ip
							localStorage.Ip = webInfo[key].infoValue;
							break;
						case "port": // 更新port
							localStorage.Port = webInfo[key].infoValue;
							break;
						case "logInfo": //更新登录信息
							localStorage.logInfo = webInfo[key].infoValue;
							break;
						case "deviceName": //更新设备名称
							var deviceName = document.getElementById("deviceName");
							break;
						case "sdkType": //更新SDK类型
							localStorage.sdkType = webInfo[key].infoValue;
							break;
						case "isNetConnect": //更新手机是否联网
							localStorage.isNetConnect = webInfo[key].infoValue;
							break;
						case "hasNewVersion": //是否有新版本
							localStorage.hasNewVersion = webInfo[key].infoValue;
							break;
						case "versionNumber": //当前版本号
							localStorage.versionNumber = webInfo[key].infoValue;
							break;
						case "LocalDeviceUname": //免注册设备用户名更新
							localStorage.LocalDeviceUname = webInfo[key].infoValue;
							break;
						case "deviceOs": //设备云端在线状态 “true”在线，“false”离线
							localStorage.deviceOs = webInfo[key].infoValue;
							break;
						case "updateChannelName": // TODO：通道名称修改成功后，主页同步更新
							localStorage.deviceName = webInfo[key].infoValue;
							break;
						case "workingStatus":
							localStorage.workingStatus = webInfo[key].infoValue;
							break;
						case "channelStatus":
							localStorage.channelStatus = webInfo[key].infoValue;
							break;
						default:
							break;
					}
				}
			})
		</script>
	</body>

</html>