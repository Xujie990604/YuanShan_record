<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title></title>
  <link href="../css/mui.css" rel="stylesheet" />
  <link href="../css/iconfont.css" rel="stylesheet" />
  <link href="../css/Common.css" rel="stylesheet" />
  <link href="../css/theme_normal.css" rel="stylesheet" />
  <style>
  </style>
</head>

<body>
  <header class="mui-bar mui-bar-nav">
    <a id="back" class="mui-icon iconfont icon-back1"></a>
    <h1 id="title" class="mui-title" data-text="WEB_alarmRevoke">&nbsp;</h1>
  </header>
  <div class="mui-content">
    <ul class="mui-table-view mui-hidden" id="messageUl">
      <!--报警撤防模式设置-->
      <li class="mui-table-view-cell mui-hidden" id="alarmMsg">
        <span class="left-text-right-swtich" data-text="WEB_alarmRevoke">&nbsp;</span>
        <!--临时撤防配置-->
        <div id="alarmRevokeSwitch" class="mui-switch mui-switch-mini">
          <div class="mui-switch-handle" id="alarmRevokeSwitchCircle"></div>
        </div>
        <!--撤防模式-->
      </li>
    </ul>
  </div>

  <script src="../js/dsbridge.min.js"></script>
  <script src="../js/common.js"></script>
  <script src="../js/libs/md5.js"></script>
  <script src="../js/libs/jquery-3.4.1.min.js"></script>
  <script src="../js/libs/sha2.js"></script>
  <script src="../js/resource.js"></script>
  <script src="../js/Utils.js"></script>
  <script src="../js/mui.js"></script>
  <script src="../js/immersed.js"></script>
  <script src="../js/customSetting.js"></script>
  <script src="../js/loadCss.js "></script>
  <script id="langScript"></script>
  <script>
    checkType(localStorage.AppType); //加载特定样式
    var langTip;
    var onClickLinkageData;      // 一键联动撤防的老数据
    var onClickLinkageSendData;  // 设置一键联动撤防的数据
    var setAlarmRevokeSwitchConfirm = true;  // 使能开关状态变化时是否调接口提交

    // 七天二十四小时周期撤防(永久撤防)的固定数据
    var shieldWeekPlanInfo = {
      Num: 7,
      ShieldDayPlanList: [
        {
          ID: 1,
          Num: 4,
          ShieldTimeSectionList: [
            {
              Begin: "00:00:00",
              End: "24:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            }
          ]
        },
        {
          ID: 2,
          Num: 4,
          ShieldTimeSectionList: [
            {
              Begin: "00:00:00",
              End: "24:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            }
          ]
        },
        {
          ID: 3,
          Num: 4,
          ShieldTimeSectionList: [
            {
              Begin: "00:00:00",
              End: "24:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            }
          ]
        },
        {
          ID: 4,
          Num: 4,
          ShieldTimeSectionList: [
            {
              Begin: "00:00:00",
              End: "24:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            }
          ]
        },
        {
          ID: 5,
          Num: 4,
          ShieldTimeSectionList: [
            {
              Begin: "00:00:00",
              End: "24:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            }
          ]
        },
        {
          ID: 6,
          Num: 4,
          ShieldTimeSectionList: [
            {
              Begin: "00:00:00",
              End: "24:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            }
          ]
        },
        {
          ID: 7,
          Num: 4,
          ShieldTimeSectionList: [
            {
              Begin: "00:00:00",
              End: "24:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            },
            {
              Begin: "00:00:00",
              End: "00:00:00"
            }
          ]
        }
      ]
    }

    mui.init();
    var typeLan = initLang();
    langTip = typeLan.lang;
    initData();
    initEvent();


    function initData() {
      initLinkageCapabilities(); // 初始化 撤防能力
    }

    function initEvent() {
      // 监听一键联动撤防开关
      document.getElementById("alarmRevokeSwitch").addEventListener("toggle", function (event) {
        // 由关闭到打开
        if (event.detail.isActive && setAlarmRevokeSwitchConfirm) {
          var sendData = deepCopy(onClickLinkageSendData);
          sendData.Mode = 2;
          sendData.ShieldWeekPlanInfo = shieldWeekPlanInfo;
          dsBridgeFuncSyn.showLoading();
          SendAjax(LAPI.linkageModeConfig, 'put', function (code, data) {
            dsBridgeFuncSyn.dismiss();
            if (code == 0) {

            } else {

              setTimeout(function () {
                mui("#alarmRevokeSwitch").switch().toggle();
              }, 200)

            }
          }, sendData)
        } else if (!event.detail.isActive && setAlarmRevokeSwitchConfirm) {  // 由关闭切换至打开
          var sendData = deepCopy(onClickLinkageSendData);
          sendData.Mode = 0;
          dsBridgeFuncSyn.showLoading();

          SendAjax(LAPI.linkageModeConfig, 'put', function (code, data) {
            dsBridgeFuncSyn.dismiss();
            if (code == 0) {

            } else {
              setTimeout(function () {
                mui("#alarmRevokeSwitch").switch().toggle();
              }, 200)
            }
          }, sendData)
        } else {
          setAlarmRevokeSwitchConfirm = true;
        }
      })

    }

    function initLinkageCapabilities() {
      SendAjax(LAPI.IPCorChannelCapabilities, 'get', function (code, data) {
        if (code == 0) {
          var LinkageCapabilities = data.SupportShieldLinkage;
          if (1 == LinkageCapabilities) {
            initLinkageMode(); // 初始化撤防模式
          } else {
            addBitmap(1, langTip["WEB_unSupported"]);
            dsBridgeFuncSyn.dismiss();
          }
        } else if (code == 4 || code == 8 || code == 1006) {
          addBitmap(1, langTip["WEB_unSupported"]);
          dsBridgeFuncSyn.dismiss();
        } else {
          showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
          addBitmap(0);
          dsBridgeFuncSyn.dismiss();
        }
      })
    }

    function initLinkageMode() {
      SendAjax(LAPI.linkageModeConfig, 'get', function (code, data) {
        dsBridgeFuncSyn.dismiss();
        if (code == 0) {
          onClickLinkageData = deepCopy(data);
          onClickLinkageSendData = deepCopy(data);
          var nowEnabled;
          data.Mode === 0 ? nowEnabled = 0 : nowEnabled = 1
          $("#messageUl").removeClass("mui-hidden");
          $("#alarmMsg").removeClass("mui-hidden");
          document.getElementById("alarmRevokeSwitch").style.zIndex = 20;
          document.getElementById("alarmRevokeSwitch").style.visibility = "visible";
          setAlarmRevokeSwitchConfirm = false;
          // 根据设备能力来初始化 switch 状态
          setSwitchStatus("alarmRevokeSwitch", nowEnabled)
          setAlarmRevokeSwitchConfirm = true;
          var setAlarmRevokeActive = document.getElementById("alarmRevokeSwitch").classList.contains("mui-active");
          if (setAlarmRevokeActive) {
            document.getElementById("alarmRevokeSwitchCircle").style.transform = 'translate(16px, 0px)';
          }
        } else if (code == 4 || code == 8 || code == 1006) {
          addBitmap(1, langTip["WEB_unSupported"]);
        } else {
          showToast(langTip["WEB_loadFailed"] + "(" + code + ")", code);
          addBitmap(0);
        }
      })
    }




  </script>
</body>

</html>