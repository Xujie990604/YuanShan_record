# 批量分享需求

## 任务进度

* feature/x09898/deviceBatchShareFeature-IOS      这是从 IOS 2.0.5.0版本分支拉取的分支
* feature/x09898/deviceBatchShareFeature          基于 Android 2.0.5.0
* 批量分享的 TC chenweiji，副TC yewenping

## 一些共性的问题

* 需要 jixue 搭建国外的服务器
* 文字的超长打点，需要全局检测一下
* 错误码的适配需要使用变量的形式，需要翻译字段
* 全文的字段需要翻译字段
* 在加载页面的时候把整个页面先关掉，然后 loading 结束之后再打开
* 创建，编辑时接口的上限是 100台

## 分享管理页面

## 批量分享页面

* 时间有效期选择器需要 APP 去实现
* 当前页面点击返回按钮，需要一个确认的弹窗
* 用户名和邮箱的正则验证
* 手机号的正则验证
* 如果是海外的环境，需要将区号加在手机号之前
* 海外区号的数据需要和原生APP来取，需要实现一个下拉的列表

## 分享详情页面

* 点击取消分享按钮之后需要一个弹窗

## 编辑分享页面

* 页面的整体样式需要优化

## 管理设备页面

* 总设备和总通道的全选功能

## 权限管理页面

* 时间选择器需要 APP 实现
* 勾选云台控制和语音对讲，需要自动勾选，视频查看
* 取消视频查看时，需要去掉云台控制和语音对讲
* 图标进行替换
* 页面的整体样式需要优化

## 分享记录的搜索页面

* 搜索时需要去掉空字符串和 <> 特殊符号

## 特性需求点

1. 不再支持分享 NVR 和 一部分通道的这种分享方式
2. 分享时勾选 NVR 就必须带上所有的通道（通道可以取消勾选，取消任意一个会导致）（NVR 和 通道上的权限都有哪些？告警消息放在哪里？或者说由谁控制）（NVR 六个权限，通道五个没有设备配置）（整台 NVR 分享，仅需要传输 NVR的数据）（有效期，权限都在NVR上设置，通道上不允许编辑）（分享记录中也仅展示 NVR 设备）
3. 分享时只通道，即使所有的通道都勾选上了，也不会带上 NVR 设备。（通道上的权限有五个）（在展示页面 NVR 外壳不显示权限和时间，所有的通道都挂在 NVR 下）
4. 单次分享可以只分享 NVR（批量不允许），为了兼容这种情况。页面中仅仅展示 NVR 设备的信息(允许编辑，NVR有六个权限)(分享记录中按照接口中的权限展示)（允许权限和有效期的编辑，有六个权限）
5. 假设之前有人单次分享了 NVR 设备，然后 使用批量分享分享了 NVR 下的很多通道。在分享记录中只展示NVR设备和单独分享的通道的信息，并且可点击。在管理设备列表页面中是需要将 NVR 设备和 IPC 通道全部勾选上的。
6. 使用多种方式（用户名/手机号/邮箱）给同一个用户分享设备时，界面中如何展示被分享者的信息 国内：用户名（手机号） 海外：用户名（邮箱））

## 设备的选择

### 新建批量分享

#### 首次进行添加

1. 由批量分享进入设备管理页面，不携带数据，只携带操作类型
2. 设备管理接口页面获取到的是所有的设备信息，并且 isShared 字段是 0。根据当前的数据进行列表的渲染
3. 用户进行操作之后，需要将选择的数据传回给批量分享页面，批量分享页面会将所有的设备上都添加最大的权限
4. 用户进行操作之后，将所有的数据都传回给批量分享页面，批量分享页面筛选出被选中的设备给添加上最大的权限

### 重新进行选择（传回被选中数据）

1. 由批量分享进入设备管理页面，携带被选中的设备数据，并且携带操作类型
2. 设备管理页面接口获取到的是所有的设备信息，并且 isShared 字段是 0(因为并没有下发过接口，服务端不会知道用户上次选择了什么)
3. 先将携带的设备数据和所有的设备信息进行对比，将那些在上次操作中进行选中的设备给添加选中状态（先将数据变更，然后根据数据去生成列表！当前没有根据 isShared 字段去渲染列表）(被选中的也需要把当前设备的权限放进入)
4. 用户进行操作之后，将最新的被选中的数据传回批量分享页面，批量分享页面会检查每个设备信息的 permission 字段，如果有这个字段，那么不去动它，如果没有这个字段则证明是这次新加的，所以给添加上所有的权限

### 重新进行选择（传回所有的数据）

1. 由批量分享进入设备管理页面，携带所有的设备数据(设备总数是全的，被选中设备的 isShared 是1，并且被选中设备上有权限字)，并携带操作类型
2. 不再需要使用接口返回的数据，直接使用批量分享页面穿过来的数据就行，可以直接使用这个数据进行列表渲染
3. 用户在传过来的数据的基础上进行操作，依旧是将所有的数据都传回给批量分享页面，批量分享页面筛选出被选中的设备，检查 permission 字段，如果有则不动，如果没有则添加上所有的权限

### 编辑批量分享

#### 首次进行编辑

1. 由批量分享进入设备管理页面，不携带设备数据
2. 设备管理接口获取到的是所有的设备数据，并且根据当前设备是否被分享 isShared 的值为 0或者1     根据当前的数据进行列表的渲染
3. 用户进行操作之后，需要经被选择的数据传回给批量分享页面，批量分享页面会将所有的设备上都添加最大权限
4. 用户记性操作之后。需要将所有的数据都传回给批量分享页面，批量分享页面筛选出被选中的设备没给添加上最大的权限

#### 重新进行编码（传回被选中数据）

1. 方案被 pass 掉，如果说本来用户是选择了 A 和 B 的，在首次编辑的时修改成了 A 和 C. 这时传到 批量分享页面的数据只有 A 和 C。然后来到设备管理页面进行数据对比的时候，会把 B 的删除这条操作忽略掉。（除非一上来就把所有设备 isShared 设置为0，然后被选中的数据进行对比，那就是除了首次编辑的时候以接口为准，剩下的情况全部以传进来的被选择数据为准）

#### 重新进行编码（传回所有的数据）

1. 由批量分享进入设备管理页面，携带所有的设备数据（设备条数是全的，被选中设备的 isShared 为 1，并且被选中的设备上有权限字段
2. 不再需要使用数据进行对比，直接使用批量分享传过来的数据就行了，直接使用这个数据进行列表渲染
3. 用户在传过来的数据的基础上进行操作，依旧是将所有的数据都传回批量分享页面，批量分享页面筛选出被选中的设备，检查 permiss 字段，如果有则不到，如果没有则添加上所有的权限
