<!--
 * @Author: xujie 1607526161@qq.com
 * @Date: 2022-04-22 13:10:58
 * @LastEditors: xujie 1607526161@qq.com
 * @FilePath: \HTML-CSS-Javascript-\JAVAScript+ES6\JavaScript\浏览器渲染页面的过程.md\浏览器渲染原理.md
 * @Description: web执行的生命周期
-->
# 浏览器渲染原理

## Web的执行分为两个阶段

1. 页面构建阶段(通过对HTML标签的解析，进行DOM的构建): 遇到Script标签(script标签也是HTML标签的一种)时，执行标签中的JavaScript代码(1.JavaScript代码通过浏览器暴露给JavaScript引擎的全局对象: window对象 来操作当前页面中的所有变量，浏览器API 2.注册事件处理器)

2. 事件处理阶段: 按照事件的生成顺序，依赖事件队列来循环的处理事件。

### 不同环境下的顶层对象

1. ES5之前，顶层对象的属性(window)和全局变量是等价的 (变量未声明就使用不报错)(window对象是当前的浏览器窗口，是当前页面的顶层对象)
2. ES6之后，var 和 function 声明的全局变量依旧是顶层对象(window窗口)的属性，let, const, class声明的全局变量不在属于window对象(在控制台中查看时属于一个叫script的对象)

* window对象会存在于整个页面的生存期之间

#### globalThis对象(和宿主环境有关)

1. 浏览器里面，顶层对象是window，但 Node 和 Web Worker 没有window。
2. 浏览器和 Web Worker 里面，self也指向顶层对象，但是 Node 没有self。
3. Node 里面，顶层对象是global，但其他环境都不支持。

**ES2020在语言标准的层面，引入globalThis作为顶层对象。也就是说，任何环境下，globalThis都是存在的，都可以从它拿到顶层对象，指向全局环境下的this。**

## 浏览器加载时间线

1. 创建Document对象，开始解析web页面。这个阶段的document.readyState  = "loading".
2. 遇到link外部css，创建线程异步加载，并继续解析文档。
3. 遇到script外部js，并且没有设置async，defer，浏览器加载，并阻塞。等待js加载完成并执行该脚本，然后继续解析文档。

    js操作了尚未解析的dom，会怎麽办。找不到DOM，得到null

4. 遇到script外部js，并且设置async，defer，浏览器创建线程加载，并继续解析文档。
对async属性的脚本，脚本加载完之后立即执行。(异步加载禁止使用document.write(),当做文档流输出。会清除当前文档流，并且替换)
5. 遇到img标签的话，先正常解析dom（script也是Dom结构）结构，然后浏览器异步加载src，并继续解析文档。
6. 当文档解析(DomTree完成，但是img的图片不一定被加载出来，只是img的DOM被加载了)完成后，document.readyState = "interactive".
7. 当文档解析(DomTree完成)完成后，所有设置defer的脚本会按照顺序执行。
8. document对象触发DOMContentLoaded事件，这也标志着程序从同步脚本执行阶段，转化为事件驱动阶段。
9. 当所有async的脚本加载完成并执行后，img等加载完成后，document.readyState = "complete" ,window对象触发load事件
10. 从此之后，以异步响应的方式处理用户输入，网络事件等。

### load事件与DOMContentLoaded事件的先后

* DOMContentLoaded 事件触发时，仅当DOM加载完成，不包括样式表，图片。
* onload 事件触发时，页面上所有的DOM，样式表，脚本，图片都已经加载完成了。

### 注意文档的解析和加载两个状态

* 在DOM树形成之后叫做文档的解析完毕。解析完毕之后状态码改变。defer的脚本们按照顺序进行执行。
* 在img的src加载完之后和async的脚本下载并执行完之后，才能说文档被加载完了并且状态码改变。因为这两步都是异步操作。

## 文档解析被阻塞

* 无论是内联的还是外链的js的下载和执行都会阻碍后面DOM的解析和渲染(因为js会改变DOM，所以不能和文档的解析一起执行，否则会出现错乱)。除非是使用了defer和async属性
* css是由单独的下载线程异步下载的。对于一个html文档来说，不论是内联的还是外链的css，都会阻碍后续DOM的渲染，但是不会阻碍后续的DOM解析。所以优化时，避免无用的css文件。使用媒体查询只在必要的时候解析css文件。
