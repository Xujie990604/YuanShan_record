# 同步异步

## 单线程

* js是单线程的语言，很有必要
* 单线程意味着:如果在同个时间有多个任务时，这些任务就需要进行排队，前一个任务执行完，才会执行下一个任务。
* 所谓单线程，是指在JS引擎中负责解释和执行JavaScript代码的线程只有一个。不妨叫它主线程
* 处理AJAX请求的线程、处理DOM事件的线程、定时器线程等等。这些线程叫它们工作线程。

## 同步任务异步任务

### 同步任务

* 是指在主线程上进行的任务，只有前一个任务执行完毕的话，才能继续执行下一个任务。
* 如果在函数A返回的时候，调用者就能够得到预期结果(即拿到了预期的返回值或者看到了预期的效果)，那么这个函数就是同步的。

### 异步任务

* 如果在函数A返回的时候，调用者还不能够得到预期结果，而是需要在将来通过一定的手段得到，那么这个函数就是异步的
* 主线程发起一个异步请求，相应的工作线程接收请求并告知主线程已收到(异步函数返回)；主线程可以继续执行后面的代码，同时工作线程执行异步任务；工作线程完成工作后，通知主线程；主线程收到通知后，执行一定的动作(调用回调函数)
* 异步函数实际上很快就调用完成了。但是后面还有工作线程执行异步任务、通知主线程、主线程调用回调函数等很多步骤。我们把整个过程叫做异步过程

#### 异步任务的要素

* 从主线程的角度来看，一个异步过程需要两个要素
* 发起函数(异步函数， 异步任务的注册函数)
* 回调函数
* 他们都是在主线程上被调用的，其中注册函数用于发起异步的过程。回调函数用于处理结果。

#### 异步的任务都有哪些

1. http请求线程
2. 浏览器的定时触发器
3. 浏览器的事件触发线程

* 当遇到这些事情的时候，浏览器会为这些耗时的任务开辟另外的线程，说明js的宿主环境是多线程的(代码的执行和资源的加载在宿主环境的多个线程中同时进行)。
* 异步的定义：异步是调用一个调用请求给被调用者，而调用者不用等待其结果的返回。

#### 异步的机制

1. 所有的同步任务都在主线程上被执行，形成一个执行栈，
2. 主线程之外还会有一个任务队列，只要异步任务有了结果，就会在任务队列中放置一个事件。
3. 一旦主执行栈上的所有同步任务执行完毕，就会读取任务对列，看看有哪些事件，执行对应的异步任务，然后结束等待状态，进入执行栈。
4. 主线程不断的执行第三步

#### 消息队列和事件循环

> 上文讲到，异步过程中，工作线程在异步操作完成后需要通知主线程。那么这个通知机制是怎样实现的呢？答案是利用消息队列和事件循环。

* 工作线程将消息放到消息队列，主线程通过事件循环过程去取消息。
* 消息队列：消息队列是一个先进先出的队列，它里面存放着各种消息。
* 事件循环：事件循环是指主线程重复从消息队列中取消息、执行的过程。
* 实际上，主线程只会做一件事情，就是从消息队列里面取消息、执行消息，再取消息、再执行。当消息队列为空时，就会等待直到消息队列变成非空。而且主线程只有在将当前的消息执行完成后，才会去取下一个消息。这种机制就叫做事件循环机制，取一个消息并执行的过程叫做一次循环。
* 消息队列中放的消息具体是什么东西，消息就是注册异步任务时添加的回调函数(回调函数被封装为消息)

## 异步和事件

* 上文中说的事件循环，为什么里面有个事件呢。消息队列中的每条消息实际上都对应着一个事件
* 从异步过程的角度看，addEventListener函数就是异步过程的发起函数，事件监听器函数就是异步过程的回调函数。事件触发时，表示异步任务完成，会将事件监听器函数封装成一条消息放到消息队列中，等待主线程执行。
* 另一方面，所有的异步过程也都可以用事件来描述。例如：setTimeout可以看成对应一个时间到了！的事件

## setTimeout而不是setInterval

* 当使用setTimeout或setInterval时，它需要定时器线程计时，计时完成后就会将特定的事件推入事件队列中。所以时间上一定是不准的。
* 且setInterval有一些比较致命的问题就是。累计效应，如果setInterval代码在（setInterval）再次添加到队列之前还没有完成执行，就会导致定时器代码连续运行好几次，而之间没有间隔。
* 当任务队列中有对应的setInterval等待被执行， 即使到了时间也不会添加新的setInterval任务， 但是当setInterval任务正在被执行的时候，会继续添加setInterval任务。